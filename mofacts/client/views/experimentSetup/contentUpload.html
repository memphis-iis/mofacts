<!-- Content (TDF and Stim) File Uploading Template -->

<template name="contentUpload">
    <div class="container" style="margin-top: 1rem;">
        <h3 style="margin-top: 0; text-align: center;">Content Management</h3>

        <p class="text-center mb-4">This manages your assets, lessons, and stimuli for use in experiments. It will upload packaged zip files with TDF/stim/asset combinations.
            Please wait until a prompt is given to navigate to a new page.</p>

        <!-- Upload Package (ZIP) Section -->
        <div class="admin-section">
            <h4 class="text-center">Upload MoFaCTS Package (.zip)</h4>
            <div class="row">
                <div class="col text-center">
                    <div class="row text-center mt-4">
                        <div class="row row-cols-2">
                            <div class="col text-end">
                                <label class="form-check-label" for="emailInsteadOfAlert">
                                    Email a summary of the upload instead of an alert in the browser.
                                </label>
                            </div>
                            <div class="col text-start">
                                <input type="checkbox" class="form-check-input" id="emailInsteadOfAlert">
                            </div>
                        </div>
                        <div class="row">
                            <input type="file" class="form-control" name="upload-file" id="upload-file" value="" accept=".zip">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload from Anki (.apkg) Section -->
        <div class="admin-section">
            <h4 class="text-center">Import from Anki (.apkg)</h4>
            <p class="text-center">
                Convert Anki flashcard decks to MoFaCTS format. Supports images, cloze deletions, and basic cards.
            </p>
            <div class="row">
                <div class="col text-center">
                    <div class="row text-center mt-4">
                        <div class="row">
                            <input type="file" class="form-control" name="upload-apkg" id="upload-apkg" value="" accept=".apkg">
                        </div>
                        <div class="row mt-3" id="apkg-status" style="display:none;">
                            <div class="col">
                                <div class="alert alert-info" role="alert">
                                    <span class="fa fa-spinner fa-spin"></span> Converting .apkg file...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-section">
            <h4 class="text-center">Your Assets</h4>
            <!-- toggle for viewing only owned lessons, default is checked -->
            {{#if isInRole 'admin'}}
            <div class="row">
                <div class="col">
                    <label class="form-check">
                        <input type="checkbox" class="form-check-input" id="showAllAssets">
                        Include all assets (not just owned)
                    </label>
                </div>
            </div>
            {{/if}}

            <div class="admin-table-wrapper">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th class="table-col-large">Summary</th>
                                <th class="table-col-medium table-col-actions">Action</th>
                            </tr>
                        </thead>
                    <tbody>
                        {{#each assets}}
                            <tr>
                                <td>
                                    <div style="padding: 0.5rem 0;">
                                        <div style="margin-bottom: 0.5rem;">
                                            <b>{{lessonName}}
                                                {{#if displayUnownedTDFs}}
                                                    ({{owner}})
                                                {{/if}}
                                            </b>
                                        </div>
                                        {{#if conditions}}
                                        <div style="margin-bottom: 0.5rem;">
                                            <b>Conditions</b>
                                            {{#each conditions}}
                                                <br>
                                                {{this.condition}} (count: {{this.count}})
                                            {{/each}}
                                        </div>
                                        {{/if}}
                                        <div style="margin-bottom: 0.5rem;">
                                            <b>Package Asset Id:</b> {{packageAssetId}}
                                        </div>
                                        {{#if errors}}
                                        <div style="margin-bottom: 0.5rem; color: var(--alert-color);">
                                            <b>ERROR:</b>
                                            <br>
                                            {{#each errors}}
                                                {{{this}}}
                                            {{/each}}
                                        </div>
                                        {{/if}}
                                        <div style="margin-bottom: 0.5rem;">
                                            Stimuli Count: {{stimuliCount}} <a id="show_stimuli" data-file="{{this._id}}">(click to toggle view of {{stimFilesCount}})</a>
                                            <div hidden id="stimuli-{{this._id}}" style="margin-top: 0.5rem;">
                                            {{#each this.stimFileInfo}}
                                                <button id="stim-download-btn" value="{{this.stimuliSetId}}" class="btn-icon"><span class="fa fa-download" aria-hidden="true"></span> {{this.fileName}} </button>
                                            {{/each}}
                                            </div>
                                        </div>
                                        {{#if accessors}}
                                        <div style="margin-bottom: 0.5rem;">
                                            Teachers (excluding owner) ({{accessorsCount}}):
                                            <ul style="margin-top: 0.5rem; margin-bottom: 0;">
                                            {{#each accessors}}
                                                <li>
                                                {{this.username}}
                                                <button id="remove-access-btn" value="{{../_id}}" data-user="{{this.userId}}" class="btn-icon"><span class="fa fa-minus" aria-hidden="true"></span></button>
                                                </li>
                                            {{/each}}
                                            </ul>
                                        </div>
                                        {{/if}}
                                        <div style="margin-bottom: 0.5rem;">
                                            <a id="show_assets" data-file="{{this._id}}">Assets (click to toggle)</a>
                                            <div hidden id="assets-{{this._id}}" style="margin-top: 0.5rem;">
                                            {{#each this.assets}}
                                                <a href="{{this.link}}">{{this.filename}}</a>
                                            {{/each}}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="table-col-actions">
                                    {{#if packageFileLink}}
                                        {{#if this.hasAPIKeys}}
                                        
                                        {{else}}
                                        <button id="tdf-download-btn" value="{{packageFileLink}}" class="btn-icon"><span class="fa fa-download" aria-hidden="true"></span></button>
                                        {{/if}}
                                    {{/if}}
                                    <button id="package-delete-btn" value="{{packageFile}}" data-filename="{{fileName}}" class="btn-icon"><span class="fa fa-minus" aria-hidden="true"></span></button>
                                    {{#if conditions}}
                                        <button id="reset-conditions-btn" value="{{_id}}" class="btn-icon"><span class="fa fa-refresh" aria-hidden="true"></span></button>
                                    {{/if}}
                                
                                </td>
                            </tr>
                            <tr>

                                <td>
                                    {{#if this.hasAPIKeys}}
                                        <!-- key icon -->
                                        <span class="fa fa-key" aria-hidden="true"></span>
                                        Transfering ownership or adding accessors of this lesson is not allowed because it has API keys. Download of this lesson is disabled. 
                                        Please share the lesson manually with the new owner or accessors.
                            
                                    {{else}}
                                        Transfer Ownership (not recoverable)
                                        <input type="text" id="transfer-{{_id}}" placeholder="Enter new owner's email">
                                        <button id="transfer-btn" value="{{_id}}" class="btn-icon"><span class="fa fa-exchange" aria-hidden="true"></span></button>
                                    {{/if}}
                                </td>
                                <td class="table-col-actions">
                                    {{#if this.hasAPIKeys}}
                                    
                                    {{else}}
                                        Add Access
                                        <input type="text" id="add-access-{{_id}}" data-id="{{_id}}" placeholder="Enter new user's email">
                                        <button id="add-access-btn" value="{{_id}}" class="btn-icon"><span class="fa fa-plus" aria-hidden="true"></span></button>
                                    {{/if}}
                                </td>

                            </tr>
                        {{/each}}
                    </tbody>
                    </table>
                </div>
            </div>
        </div>

        {{#if showDeleteAllButton}}
        <div class="admin-section">
        <h4 class="text-center">Admin Functions</h4>
            <p>
                This will delete all files, remove all lessons, and remove all stimuli. <b>This is not recoverable.</b>
            </p>
            <button class="btn width-80-percent" id="deleteAllAssetsConfirm">Delete All Uploaded Files</button>
        </div>
        {{/if}}
    </div>
</template>
