<template name="learningDashboard">
  <!-- Audio Warmup Spinner Overlay -->
  {{#if audioWarmupInProgress}}
  <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="text-center text-white">
      <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
        <span class="sr-only">Loading...</span>
      </div>
      <div class="mt-3">Preparing audio features...</div>
    </div>
  </div>
  {{/if}}

  <div class="page-container page-loading" id="learningDashboardContainer">
    <h3 style="margin-top: 0; text-align: center;">Learning Dashboard</h3>

    <!-- Search Field -->
    <div class="row justify-content-center">
      <div class="col-12">
        <div class="row justify-content-center" style="margin: 10px;">
          <input id="learningDashboardSearch" type="text" placeholder="Search lessons by name or tag..." alt="lesson search box" class="w-75 mx-auto d-block">
        </div>
      </div>
    </div>

    {{#if hasTdfs}}
      <!-- Desktop Table - Traditional layout for large screens -->
      <table class="table table-striped table-hover mt-4 learning-dashboard-table">
        <thead>
          <tr>
            <th>Lesson</th>
            <th>Features</th>
            <th>Total Trials</th>
            <th>Overall Accuracy</th>
            <th>Last 10 Accuracy</th>
            <th>Time (min)</th>
            <th>Items Practiced</th>
            <th>Days with Sessions</th>
            <th>Last Practice</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {{#each allTdfsList}}
            <tr>
              <td><strong>{{this.displayName}}</strong></td>
              <td>
                {{#if this.enableAudioPromptAndFeedback}}
                  <span class="fa fa-headphones" title="Text-to-Speech enabled"></span>
                {{/if}}
                {{#if this.audioInputEnabled}}
                  <span class="fa fa-microphone" title="Speech Recognition enabled"></span>
                {{/if}}
              </td>
              {{#if this.isUsed}}
                <td>{{this.totalTrials}}</td>
                <td>{{this.overallAccuracy}}%</td>
                <td>{{this.last10Accuracy}}%</td>
                <td>{{this.totalTimeMinutes}}</td>
                <td>{{this.itemsPracticed}}</td>
                <td>{{this.totalSessions}}</td>
                <td>{{this.lastPracticeDate}}</td>
                <td class="text-center">
                  <button class="btn btn-sm btn-primary continue-lesson"
                    data-tdfid="{{this.TDFId}}"
                    data-lessonname="{{this.displayName}}"
                    data-currentstimulisetid="{{this.currentStimuliSetId}}"
                    data-ismultitdf="{{this.isMultiTdf}}">Continue</button>
                </td>
              {{else}}
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td class="text-center">
                  <button class="btn btn-sm btn-success start-lesson"
                    data-tdfid="{{this.TDFId}}"
                    data-lessonname="{{this.displayName}}"
                    data-currentstimulisetid="{{this.currentStimuliSetId}}"
                    data-ignoreoutofgrammarresponses="{{this.ignoreOutOfGrammarResponses}}"
                    data-speechoutofgrammarfeedback="{{this.speechOutOfGrammarFeedback}}"
                    data-ismultitdf="{{this.isMultiTdf}}">Start</button>
                </td>
              {{/if}}
            </tr>
          {{/each}}
        </tbody>
      </table>

      <!-- Mobile/Tablet Cards - Card layout for small screens -->
      <!-- IMPORTANT: Keep this structure in sync with table above (same data, same buttons) -->
      <div class="learning-dashboard-cards">
        {{#each allTdfsList}}
          <div class="border rounded p-3 mb-3 bg-white shadow-sm {{#unless this.isUsed}}lesson-card-unused{{/unless}}">

            <!-- Card Header - Always Visible -->
            <!-- Lesson Name -->
            <div class="fw-bold">{{this.displayName}}</div>

            <!-- Features and Badge Row (consistent spacing) -->
            <div class="d-flex justify-content-between align-items-center py-1" style="height: 2rem;">
              <div class="d-flex gap-1 align-items-center">
                {{#if this.enableAudioPromptAndFeedback}}
                  <span class="fa fa-headphones" title="Text-to-Speech enabled"></span>
                {{/if}}
                {{#if this.audioInputEnabled}}
                  <span class="fa fa-microphone" title="Speech Recognition enabled"></span>
                {{/if}}
              </div>

              <div>
                {{#if this.isUsed}}
                  <span class="badge bg-success">{{this.overallAccuracy}}%</span>
                {{else}}
                  <span class="badge bg-secondary">New</span>
                {{/if}}
              </div>
            </div>

            <!-- Action Buttons Row -->
            {{#if this.isUsed}}
              <div class="d-flex gap-1 mt-1 align-items-center">
                <button class="btn btn-sm btn-primary flex-grow-1 continue-lesson"
                  data-tdfid="{{this.TDFId}}"
                  data-lessonname="{{this.displayName}}"
                  data-currentstimulisetid="{{this.currentStimuliSetId}}"
                  data-ismultitdf="{{this.isMultiTdf}}"
                  style="height: 44px; display: flex; align-items: center; justify-content: center;">
                  Continue
                </button>
                <button class="btn btn-sm btn-primary flex-grow-1"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#details-{{this.TDFId}}"
                  aria-expanded="false"
                  aria-controls="details-{{this.TDFId}}"
                  style="white-space: nowrap; height: 44px; display: flex; align-items: center; justify-content: center;">
                  Details
                  <span class="fa fa-chevron-down card-expand-icon ms-1" style="font-size: 0.75rem; vertical-align: middle;"></span>
                </button>
              </div>
            {{else}}
              <button class="btn btn-sm btn-success w-100 mt-1 start-lesson"
                data-tdfid="{{this.TDFId}}"
                data-lessonname="{{this.displayName}}"
                data-currentstimulisetid="{{this.currentStimuliSetId}}"
                data-ignoreoutofgrammarresponses="{{this.ignoreOutOfGrammarResponses}}"
                data-speechoutofgrammarfeedback="{{this.speechOutOfGrammarFeedback}}"
                data-ismultitdf="{{this.isMultiTdf}}">
                Start
              </button>
            {{/if}}

            <!-- Expandable Details Section (only for used lessons) -->
            {{#if this.isUsed}}

              <div id="details-{{this.TDFId}}" class="collapse">
                <div class="border-top pt-1 mt-1">
                  <div class="d-flex justify-content-between py-1 border-bottom">
                    <span>Total Trials:</span>
                    <span class="fw-bold">{{this.totalTrials}}</span>
                  </div>
                  <div class="d-flex justify-content-between py-1 border-bottom">
                    <span>Last 10 Accuracy:</span>
                    <span class="fw-bold">{{this.last10Accuracy}}%</span>
                  </div>
                  <div class="d-flex justify-content-between py-1 border-bottom">
                    <span>Time Spent:</span>
                    <span class="fw-bold">{{this.totalTimeMinutes}} min</span>
                  </div>
                  <div class="d-flex justify-content-between py-1 border-bottom">
                    <span>Items Practiced:</span>
                    <span class="fw-bold">{{this.itemsPracticed}}</span>
                  </div>
                  <div class="d-flex justify-content-between py-1 border-bottom">
                    <span>Days with Sessions:</span>
                    <span class="fw-bold">{{this.totalSessions}}</span>
                  </div>
                  <div class="d-flex justify-content-between py-1">
                    <span>Last Practice:</span>
                    <span class="fw-bold">{{this.lastPracticeDate}}</span>
                  </div>
                </div>
              </div>
            {{/if}}

          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="alert alert-info text-center mt-4">
        <p>No lessons found. Please contact your administrator.</p>
      </div>
    {{/if}}
  </div>
</template>
