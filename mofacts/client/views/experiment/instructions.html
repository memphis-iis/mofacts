<template name="instructions">
    <div class="container">
        <div class="row full-width">
            {{#if UISettings.displayInstructionsTitle}}
            <div class="header-box">
                {{curTdfName}}:
                {{#if UISettings.displayUnitNameInInstructions}}
                    {{curTdfName}}:
                {{/if}}
                Instructions
            </div>
            {{else}}
            {{/if}}
        </div>
        <div class="row">
            {{#if backgroundImage}}
            <div class="col-lg-12">
                <img src="{{backgroundImage}}">
            </div>
            {{/if}}
        </div>
        {{#if instructionText}}
            <div class="row">
                <p>{{{instructionText}}}</p>
            </div>
        {{/if}}     
        {{#if islockout}}
        <div class="alert">
            <div class="alert-icon">
                <i class="fa fa-info-circle" aria-hidden="true"></i>
            </div>
                <p>The lesson cannot continue just yet due to a lockout timer. Please wait before resuming.</p>
        </div>
        {{/if}}
        {{#if allowcontinue}}
            <div class="text-center mt-4"><span id="lockoutTimeRemaining"></span></div>
            <div id="continueBar" class="full-width text-center" >
                <span id="displayTimeoutMsg"></span>
                {{#if islockout}}
                    <div class="row">
                        <div class="col-6 offset-3">        
                            <button type="button" id="continueButton" class="btn width-80-percent mx-auto" disabled>
                            {{UIsettings.continueButtonText}}
                            </button>
                        </div>
                    {{#if allowGoBack}}
                        <div class="col-1 offset-1">
                            <button type="button" id="stepBackButton" class="btn width-80-percent mx-auto" disabled>
                            <!-- back icon -->
                            <i class="fa fa-arrow-left" aria-hidden="true"></i>
                            </button>
                        </div>
                    {{/if}}
                    </div>
                {{else}}
                    <div class="row">
                        <div class="col-6 offset-3">               
                            <button type="button" id="continueButton" class="btn width-80-percent mx-auto">
                            {{UIsettings.continueButtonText}}
                            </button>
                        </div>
                    {{#if allowGoBack}}
                        <div class="col-1 offset-1">
                            <button type="button" id="stepBackButton" class="btn width-80-percent mx-auto">
                            <!-- back icon -->
                            <i class="fa fa-arrow-left" aria-hidden="true"></i>
                            </button>
                        </div>
                    {{/if}}
                    </div>
                {{/if}}
            </div>
        {{/if}}
    </div>

<script>
// Attach globally for instructions pages
const observer = new MutationObserver(() => {
    attachAudioListeners();
});
observer.observe(document.body, { childList: true, subtree: true });

function attachAudioListeners() {
    document.querySelectorAll('.play-btn:not([data-listener-attached])').forEach(btn => {
        const audId = btn.getAttribute('data-audio-id');
        if (audId) {
            const aud = document.getElementById(audId);
            if (aud) {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    aud.currentTime = 0;
                    aud.play().catch(console.error);
                });
                btn.setAttribute('data-listener-attached', 'true'); // Prevent duplicates
            }
        }
    });
}
</script>

</template>
