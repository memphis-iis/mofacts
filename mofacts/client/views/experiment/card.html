<template name="card">
    <div class="container-fluid position-relative card-stack">

        <!-- VIDEO SESSION MODE - Instructional video player interface -->
        {{#if isVideoSession}}
        <div class="card-stack-section card-stack card-stack--flush card-stack--compact card-stack-section--video">
            <div class="row">
                <div class="col-lg-12 visible-text text-center">
                    {{{videoUnitDisplayText}}}
                </div>
            </div>
            <div id="videoUnitContainer" class="position-absolute z-0 w-100">
                <video id="videoUnitPlayer" playsinline controls preload="metadata">
                    <!-- <source src="{{videoSource}}" type="video/mp4" /> -->
                </video>
                <div class="row">
                    <div class="col-6 offset-3">
                        <div id="continueBar" hidden class="video-button-bar">
                            <button type="button" id="continueButton" class="btn text-center">
                                {{UIsettings.continueButtonText}}
                            </button>
                        </div>
                    </div>
                    {{#if allowGoBack}}
                    <div class="col-1 offset-2">
                        <div id="goBackBar" class="video-button-bar">
                            <button type="button" id="stepBackButton" class="btn text-center" aria-label="Go back to previous question">
                                <!-- back icon -->
                                <i class="fa fa-arrow-left" aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
        {{/if}}

        <!-- ADMIN/DEBUG WARNINGS -->
        {{#if isImpersonating}}
        <div class='text-center alert alert-warning card-stack-section card-stack-section--warning'>
                Impersonation Mode. Nothing will be logged. Log out to reset.
        </div>
        {{/if}}
        {{#if displayFeedback}}
        <div class="card-stack-section card-stack card-stack--flush card-stack--compact card-stack-section--profile-toggles">
            {{>profileDialogueToggles}}
            <div>
                {{#if resetFeedbackSettingsFromIndex}}
                    <button id='confirmFeedbackSelectionFromIndex' class='btn width-100-percent'>Confirm feedback settings</button>
                {{else}}
                    <button id='confirmFeedbackSelection' class='btn width-100-percent'>Confirm feedback settings</button>
                {{/if}}
            </div>
        </div>
        {{/if}}

        <!-- ACCESSIBILITY: ARIA Live Region for screen reader announcements -->
        <div id="trialStateAnnouncer" role="status" aria-live="polite" aria-atomic="true" class="sr-only">
            <!-- Updated by JavaScript with trial state messages -->
        </div>

        <!-- PRACTICE CARD - Main learning interface -->
        <div id="trialContentWrapper" class="card-stack-section card-stack card-stack--flush {{#unless displayReady}}trial-hidden{{/unless}}">
            <div id="userInteractionContainer" class="smooth-transition" hidden>
                <div class="text-center {{fontSizeClass}} smooth-transition" id="UserInteraction" hidden></div>
                <div id="forceCorrectionEntry" class="smooth-transition" hidden>
                    {{> inputForceCorrect}}
                </div>
            </div>

            <div class="scrollHistoryContainer">
                {{#if haveScrollList}}
                {{#each scrollList}}
                <div class="row">
                    <div class="col-12 col-md-8">
                        <div class="panel">
                            <div class="panel-heading bg-primary">{{question}}</div>
                            <div class="panel-body {{correctnessClass userCorrect}}">{{answer}}</div>
                        </div>
                    </div>
                </div>
                {{/each}}
                {{/if}}
            </div>
            {{#if showPerformanceDetails}}
            <div class="card-element-spacing card-stats-bar-wrapper">
                {{> curStudentPerformance}}
            </div>
            {{/if}}
            <div class="row{{UIsettings.reverseStimuliAndInputColumns}} mx-auto w-100 top-0 {{videoSessionClasses isVideoSession}}">
                {{#if trial}}
                <div class="{{UIsettings.displayColWidth}} mx-auto" id="displayContainer">
                    {{#if anythingButAudioCard}}
                        <div class="{{fontSizeClass}} {{studyDisplayClass study UIsettings}} {{stimuliBoxClasses}} dynamic-stimuli-box" id="displaySubContainer">
                            {{#if textOrClozeCard}}
                            <p class="dynamic-font-size">
                            {{#if shouldShowSubWordCloze}}
                                {{{subWordParts}}}
                            {{else if shouldShowStandardCloze}}
                                {{{clozeText}}}
                                {{{text}}}
                            {{else}}
                                {{{text}}}
                            {{/if}}
                            </p>
                            {{/if}}
                            {{#if imageCard}}
                            <div class="h2 image-display-container" id="imageDisplay">
                                <div class="w-100 text-center">
                                    <img src="{{curImgSrc}}"
                                         width="{{curImgWidth}}"
                                         height="{{curImgHeight}}"
                                         loading="eager"
                                         fetchpriority="high"
                                         decoding="async"
                                         class="img-responsive stimulus-image"
                                         alt="Learning stimulus image">
                                </div>
                            </div>
                            {{/if}}
                            {{#if videoCard}}
                                <video autoplay preload="metadata" playsinline>
                                    <source src="{{curVideoSrc}}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            {{/if}}
                        </div>
                    {{/if}}
                    {{#if audioCard}}
                        <div class="text-center mb-2" role="status" aria-label="Audio question playing">
                            <span class="fa fa-volume-up fa-5x {{audioIconColorClass}}" id="audioIcon" aria-hidden="true"></span>
                            <span class="sr-only">Audio question is being played</span>
                        </div>
                    {{/if}}
                </div>
                <div id="correctAnswerDisplayContainer" class="{{UIsettings.textInputDisplay2}} alert {{fontSizeClass}} {{UIsettings.displayColWidth}} d-none text-center">
                </div>
                <div id="feedbackOverrideContainer" class="smooth-transition" hidden>
                    <div id="feedbackOverride" class="{{fontSizeClass}} text-center smooth-transition"></div>
                </div>
                {{#if userInDiaglogue}}
                    <div class="row {{fontSizeClass}}">
                        <div class="container-fluid" id="dialogueDisplayContainer">
                            <div id="leftPanel" class="col-md-11">
                                <div class="alert text-center" id="textQuestion">
                                    {{{dialogueText}}}
                                </div>
                            </div>
                        </div>
                    </div>
                {{/if}}
            {{/if}}

            {{#if skipstudy}}
            <div class="col-12 text-center card-element-spacing">
                <button type='button' id='continueStudy' name='continueStudy' class='btn w-100 btn-responsive'>
                    {{UIsettings.skipStudyButtonText}}
                </button>
            </div>
            {{/if}}

            {{#if study}}
                <div class="alert {{UIsettings.displayColWidth}} {{fontSizeClass}} {{UIsettings.textInputDisplay2}} ">
                    {{#if hideResponse}}
                        <p id="answerLabel" class="answer-display-trial text-center dynamic-font-size">{{displayAnswer}}</p>
                    {{/if}}
                </div>  <!-- close column -->
            {{/if}}

            {{#if testordrill}}
                {{#if shouldShowSpeechRecognitionUI}}
                {{#if audioInputModeEnabled}}
                    {{#if isNotInDialogueLoopStageIntroOrExit}}
                        <div class="sr-status-container">
                            <i class="fa fa-microphone sr-mic-icon {{microphoneColorClass}}"></i>
                            <span>{{voiceTranscriptionStatusMsg}}</span>
                        </div>
                    {{/if}}
                {{/if}}
                {{/if}}
                <!-- Text input: visibility controlled by CSS based on buttonTrial and SR mode -->
                <div class="input-box col-12 {{#if buttonTrial}}trial-input-hidden{{else}}{{#if audioInputModeEnabled}}trial-input-hidden{{/if}}{{/if}}{{#unless inputReady}} input-pending{{/unless}}">
                    {{#if showDialogueHints}}
                        {{#if dialogueCacheHint}}
                            <div class="row hints">
                                <div class="col-lg-12 visible-text text-center">
                                    <b>Hints:</b> {{dialogueCacheHint}}
                                </div>
                            </div>
                        {{/if}}
                    {{/if}}
                    {{> inputF}}
                </div>

                <!-- Button/Multiple choice: visibility controlled by CSS -->
                {{#unless inFeedback}}
                {{#if audioEnabled}}
                    <p class="marginLeftAndRight text-center {{#unless buttonTrial}}trial-input-hidden{{/unless}}">Please speak the letter next to the correct option for audio input</p>
                {{/if}}
                {{/unless}}
                <div id="multipleChoiceContainer"
                     class="{{UIsettings.choiceColWidth}} {{videoMCClasses isVideoSession}} smooth-transition {{#if buttonTrial}}{{else}}trial-input-hidden{{/if}}"
                     role="radiogroup"
                     aria-labelledby="displaySubContainer"
                     aria-required="true">
                    <!-- Multiple choice buttons dynamically added -->
                    <div id="multipleChoiceTable" class="row gy-3 choice text-center row-cols-{{UIsettings.choiceButtonCols}} align-items-start">
                        {{#if imageResponse}}
                            {{#each buttonListImageRows}}
                            <div class="col ml-auto">
                                {{#each this}}
                                {{#if audioEnabled}}
                                    <label class="no-bottom-margin mb-2">{{verbalChoice}}.</label>
                                {{/if}}
                                    <button data-image-url="{{buttonValue}}"
                                            verbalChoice='{{verbalChoice}}'
                                            type='button'
                                            name='{{buttonName}}'
                                            class='btnPaddedAndMinWidth btn-alt w-100 multipleChoiceButton btn-image btn-responsive'
                                            role="radio"
                                            aria-checked="false"
                                            aria-label="Option {{verbalChoice}}: {{buttonName}}">
                                    </button>
                                {{/each}}
                            </div>
                            {{/each}}
                        {{else}}
                            {{#each buttonList}}
                            <div data-display="{{displayReadyConverter (displayReady)}}" class="col ml-auto">
                                {{#if audioEnabled}}
                                <label class="no-bottom-margin mb-2">{{verbalChoice}}.</label>
                                {{/if}}
                                <button verbalChoice='{{verbalChoice}}'
                                        type='button'
                                        name='{{buttonName}}'
                                        class='multipleChoiceButton btn btn-primary'
                                        role="radio"
                                        aria-checked="false"
                                        aria-label="Option {{verbalChoice}}: {{buttonName}}">
                                {{{buttonValue}}}
                                </button>
                            </div>
                            {{/each}}
                        {{/if}}
                    </div>
            </div>

            {{#if UIsettings.displayConfirmButton}}
            <div class="col-12 text-center card-element-spacing">
                <button type='button' id='confirmButton' name='confirmButton' class='btn w-100 btn-responsive' disabled aria-disabled="true">
                    {{UIsettings.continueButtonText}}
                </button>
            </div>
            {{/if}}

            {{/if}}
            {{#if questionIsRemovable}}
                <div class="removalContainer card-element-spacing">
                    <div class="col-12 col-md-6 mx-auto text-center">
                        <button id="removeQuestion" class="btn btn-secondary">
                            Report Mistake
                        </button>
                    </div>
                </div>
            {{/if}}
            </div>

        <!-- DEBUG PANELS - Teacher/Admin only displays -->
            {{#if isInRole 'teacher'}}
            <div class="row card-stack-section card-stack-section--debug">
                <div class="col-lg-12 visible-text text-center">
                    {{#if displayAnswer}}<h5>Teacher Aid (Answer): {{displayAnswer}}</h5>{{/if}}
                    {{#if currentProgress}}<h5>Current Progress: {{currentProgress}}</h5>{{/if}}
                    {{#if rawAnswer}}<h5>Teacher Aid (Raw Answer Text): {{rawAnswer}}</h5>{{/if}}
                </div>
            </div>
            {{/if}}
            {{#if isInRole 'admin'}}
                {{#if debugParms.probParmsDisplay}}            
                <div class="col-lg-12 visible-text text-left card-stack-section card-stack-section--debug">
                    {{#if probabilityParameters}}
                    <h5>(Debug) Probabilty input parameters for this selection:</h5>
                        <p class="small-text">
                                {{#each probabilityParameters}}
                                {{this.parameter}}: {{this.value}}, &nbsp;
                                {{/each}}
                        </p>
                    {{else}}
                        <h5>(Debug) No probability input parameters for this selection due to being a resumed session.</h5>
                    {{/if}}
                </div>
                {{/if}}
            {{/if}}
            <div class="row card-stack-section card-stack-section--debug">
                <div hidden class="offset-lg-2 col-lg-5 text-center" id="overlearningRow">
                    <h4 class="overlearning-text">You are currently overlearning!  Please consider taking a break and coming back later.</h4>
                    <button id="overlearningButton" type="button" class="btn btn-responsive overlearning-button">Practice</button>
                </div>
            </div>
        </div><!-- Close trialContentWrapper -->
    <!-- Removed readyPromptString display to prevent 'Loading...' flash -->

        <!-- Modal -->
        <div class="modal fade" id="finalInstructionsDlg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header visible-text">
                        <button type="button" class="btn-close instructModalDismiss" data-bs-dismiss="modal" aria-label="Close"></button>
                        <h4 class="modal-title" id="myModalLabel">Good Bye</h4>
                    </div>
                    <div class="modal-body visible-text">
                        <div id="finalInstructionsText"></div>
                    </div>
                    <div class="modal-footer visible-text">
                        <button type="button" class="btn btn-secondary btn-responsive instructModalDismiss" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="lastUnitModal" tabindex="-1" role="dialog" aria-labelledby="lastUnitModal" aria-hidden="true" data-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header visible-text">
                        <h4 class="modal-title" id="lastUnitModal"></h4>
                    </div>
                    <div class="modal-body visible-text">
                        <div id="lastUnitModalText">This is the last video, do not progress unless finished with this lesson.</div>
                    </div>
                    <div class="modal-footer visible-text">
                        <button type="button" id="lastUnitModalDismiss" class="btn btn-default btn-responsive" data-bs-dismiss="modal">Continue</button>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- close container -->

    <div id="postCardContainer"></div>


    <!-- Fixed footer for timeout display -->
    {{#if haveDispTimeout}}
    <div id="continueBar" >
        <span id="displayTimeoutMsg">
            <!-- timer bar -->
            <div class="progress">
                <div id="timerBar" class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="{{displayTimeout}}">
                    <span class="sr-only">0% Complete</span>
                </div>
            </div>
        </span>
        <div class="row">
            <div class="col-6 offset-3">
                <button type="button" id="continueButton" class="btn text-center">
                    {{UIsettings.continueButtonText}}
                </button>
            </div>    
            {{#if allowGoBack}}
            <div class="col-1 offset-2">
                <button type="button" id="stepBackButton" class="btn text-center" aria-label="Go back to previous question">
                    <!-- back icon -->
                    <i class="fa fa-arrow-left" aria-hidden="true"></i>
                </button>
            </div>
            {{/if}}
        </div>
    </div> 
    {{/if}}
    <!-- card lower feedback -->
  {{#if isInTrial}}
  {{#unless isInInstructions}}
  <div id="userLowerInteractionContainer" class="card-feedback-area">
      <div class="row text-center">
          <div class="col-12 col-md-6 mx-auto">
              <div id="userLowerInteraction" class="smooth-transition">
              </div>
              <div id="CountdownTimerText" class="smooth-transition">
              </div>
              <div id="progressBarContainer" class="progress">
                  <div id="progressbar" class="bg-warning progress-bar-striped smooth-transition" role="progressbar" aria-label="Progress indicator" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
          </div>
      </div>
  </div>
  {{/unless}}
  {{/if}}

<script>
// Event delegation for .play-btn clicks (handles static and dynamic buttons efficiently without MutationObserver)
(function() {
    let delegatedListenerAttached = false;

    function attachDelegatedListener() {
        if (delegatedListenerAttached) return;
        delegatedListenerAttached = true;

        // Single click listener handles all .play-btn elements (current and future)
        document.body.addEventListener('click', (e) => {
            const btn = e.target.closest('.play-btn');
            if (!btn) return;

            e.preventDefault();
            const audId = btn.getAttribute('data-audio-id');
            if (audId) {
                const aud = document.getElementById(audId);
                if (aud) {
                    aud.currentTime = 0;
                    aud.play().catch(console.error);
                }
            }
        }, {passive: false}); // Cannot use passive: true because we call preventDefault()
    }

    // Attach immediately
    attachDelegatedListener();

    // Also ensure it's attached when modal is shown (defensive)
    $('#finalInstructionsDlg').on('shown.bs.modal', attachDelegatedListener);
})();
</script>

</template>
