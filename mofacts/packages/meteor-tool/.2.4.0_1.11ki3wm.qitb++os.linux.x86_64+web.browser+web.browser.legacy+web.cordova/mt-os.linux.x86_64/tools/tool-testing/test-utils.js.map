{"version":3,"sources":["/tools/tool-testing/test-utils.js"],"names":["module","export","randomString","accountsCommandTimeoutSecs","randomAppName","randomUserEmail","login","logout","registrationUrlRegexp","ddpConnect","registerWithToken","randomOrgName","createOrganization","getMeteorRuntimeConfigFromHTML","checkForSettings","markThrowingMethods","getAuthDDPUrl","link","v","timeoutScaleFactor","withAccountsConnection","fail","markStack","request","loadIsopackage","charsCount","chars","str","i","charAt","Math","floor","random","length","s","username","password","run","waitSecs","matchErr","write","expectExit","url","DDP","connect","token","email","accountsConn","registrationTokenInfo","call","registrationCode","code","emails","close","exports","orgName","conn","meteorAccountsLoginInfo","clientInfo","err","html","m","match","JSON","parse","decodeURIComponent","appName","settings","timeoutSecs","timeoutDate","Date","valueOf","result","mrc","body","e","_","isEqual","PUBLIC_SETTINGS","prototype","Object","keys","forEach","key","value","Function","toString","test","name"],"mappings":"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","sourcesContent":["import { getAuthDDPUrl } from '../meteor-services/config.js';\nimport { timeoutScaleFactor } from '../utils/utils.js';\nimport { withAccountsConnection } from '../meteor-services/auth.js';\nimport { fail, markStack } from './selftest.js';\nimport { request } from '../utils/http-helpers.js';\nimport { loadIsopackage } from '../tool-env/isopackets.js';\n\nexport function randomString(charsCount) {\n  var chars = 'abcdefghijklmnopqrstuvwxyz';\n  var str = '';\n  for (var i = 0; i < charsCount; i++) {\n    str = str + chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return str;\n}\n\nexport const accountsCommandTimeoutSecs = 15 * timeoutScaleFactor;\n\nexport function randomAppName() {\n  return 'selftest-app-' + randomString(10);\n}\n\nexport function randomUserEmail() {\n  return 'selftest-user-' + randomString(15) + '@guerrillamail.com';\n}\n\nexport function login(s, username, password) {\n  var run = s.run('login');\n  run.waitSecs(15);\n  run.matchErr('Username:');\n  run.write(username + '\\n');\n  run.matchErr('Password:');\n  run.write(password + '\\n');\n  run.waitSecs(15);\n  run.matchErr('Logged in as ' + username + \".\");\n  run.expectExit(0);\n}\n\nexport function logout(s) {\n  var run = s.run('logout');\n  run.waitSecs(15);\n  run.matchErr('Logged out');\n  run.expectExit(0);\n}\n\nexport const registrationUrlRegexp =\n  /https:\\/\\/www\\.meteor\\.com\\/setPassword\\?([a-zA-Z0-9\\+\\/]+)/;\n\nexport function ddpConnect(url) {\n  return loadIsopackage('ddp-client').DDP.connect(url);\n}\n\n// Given a registration token created by doing a deferred registration\n// with `email`, makes a DDP connection to the accounts server and\n// finishes the registration process.\nexport function registerWithToken(token, username, password, email) {\n  // XXX It might make more sense to hard-code the DDP url to\n  // https://www.meteor.com, since that's who the sandboxes are talking\n  // to.\n  var accountsConn = ddpConnect(getAuthDDPUrl());\n  var registrationTokenInfo = accountsConn.call('registrationTokenInfo',\n                                                token);\n  var registrationCode = registrationTokenInfo.code;\n  accountsConn.call('register', {\n    username: username,\n    password: password,\n    emails: [email],\n    token: token,\n    code: registrationCode\n  });\n  accountsConn.close();\n}\n\nexport function randomOrgName() {\n  return \"selftestorg\" + exports.randomString(10);\n}\n\n// Logs in as the specified user and creates a randomly named\n// organization. Returns the organization name. Calls selftest.fail if\n// the organization can't be created.\nexport function createOrganization(username, password) {\n  var orgName = exports.randomOrgName();\n  withAccountsConnection(function (conn) {\n    try {\n      conn.call(\"login\", {\n        meteorAccountsLoginInfo: { username: username, password: password },\n        clientInfo: {}\n      });\n    } catch (err) {\n      fail(\"Failed to log in to Meteor developer accounts\\n\" +\n                    \"with test user: \" + err);\n    }\n\n    try {\n      conn.call(\"createOrganization\", orgName);\n    } catch (err) {\n      fail(\"Failed to create organization: \" + err);\n    }\n  })();\n\n  return orgName;\n}\n\nexport function getMeteorRuntimeConfigFromHTML(html) {\n  var m = html.match(/__meteor_runtime_config__ = JSON.parse\\(decodeURIComponent\\(\"([^\"]+?)\"\\)\\)/);\n  if (! m) {\n    fail(\"Can't find __meteor_runtime_config__\");\n  }\n  return JSON.parse(decodeURIComponent(m[1]));\n}\n\n// Poll the given app looking for the correct settings. Throws an error\n// if the settings aren't found after a timeout.\nexport const checkForSettings = markStack(function (appName, settings, timeoutSecs) {\n  var timeoutDate = new Date(new Date().valueOf() + timeoutSecs * 1000);\n  while (true) {\n    if (new Date() >= timeoutDate) {\n      fail('Expected settings not found on app ' + appName);\n    }\n\n    var result = request('http://' + appName);\n\n    // XXX This is brittle; the test will break if we start formatting the\n    // __meteor_runtime_config__ JS differently. Ideally we'd do something\n    // like point a phantom at the deployed app and actually evaluate\n    // Meteor.settings.\n    try {\n      var mrc = exports.getMeteorRuntimeConfigFromHTML(result.body);\n    } catch (e) {\n      // ignore\n      continue;\n    }\n\n    if (_.isEqual(mrc.PUBLIC_SETTINGS, settings['public'])) {\n      return;\n    }\n  }\n});\n\nexport function markThrowingMethods(prototype) {\n  Object.keys(prototype).forEach(key => {\n    const value = prototype[key];\n    if (typeof value === \"function\") {\n      const code = Function.prototype.toString.call(value);\n      if (/\\bnew TestFailure\\b/.test(code)) {\n        prototype[name] = markStack(value);\n      }\n    }\n  });\n}\n"],"file":"tools/tool-testing/test-utils.js.map"}