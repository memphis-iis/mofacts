{"version":3,"sources":["/tools/tool-testing/matcher.js"],"names":["module","export","default","Matcher","makeFulfillablePromise","link","v","TestFailure","Console","markThrowingMethods","constructor","run","buf","fullBuffer","ended","resetMatch","endPromise","Promise","resolve","resolveEndPromise","write","data","_tryMatch","getFullBuffer","mp","matchPromise","matchPattern","matchStrict","matchFullBuffer","setMatchStrict","strict","rejectMatch","error","reject","resolveMatch","value","match","pattern","timeout","matchAsync","await","Error","timer","failure","setTimeout","then","result","clearTimeout","matchBeforeEnd","_beforeEnd","promiseCallback","end","endAsync","matchEmpty","length","info","ret","RegExp","indexOf","m","index","substr","slice","i","prototype"],"mappings":"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","sourcesContent":["// Handles the job of waiting until text is seen that matches a\n// regular expression.\nimport { makeFulfillablePromise } from '../utils/fiber-helpers.js';\nimport TestFailure from './test-failure.js';\nimport { Console } from '../console/console.js';\n\nexport default class Matcher {\n  constructor(run) {\n    this.buf = \"\";\n    this.fullBuffer = \"\";\n    this.ended = false;\n    this.resetMatch();\n    this.run = run; // used only to set a field on exceptions\n    this.endPromise = new Promise((resolve) => {\n      this.resolveEndPromise = resolve;\n    });\n  }\n\n  write(data) {\n    this.buf += data;\n    this.fullBuffer += data;\n    this._tryMatch();\n  }\n\n  getFullBuffer() {\n    return this.fullBuffer;\n  }\n\n  resetMatch() {\n    const mp = this.matchPromise;\n\n    this.matchPattern = null;\n    this.matchPromise = null;\n    this.matchStrict = null;\n    this.matchFullBuffer = false;\n\n    return mp;\n  }\n\n  setMatchStrict(strict) {\n    this.matchStrict = strict;\n  }\n\n  rejectMatch(error) {\n    const mp = this.resetMatch();\n    if (mp) {\n      mp.reject(error);\n    } else {\n      // If this.matchPromise was not defined, we should not swallow this\n      // error, so we must throw it instead.\n      throw error;\n    }\n  }\n\n  resolveMatch(value) {\n    const mp = this.resetMatch();\n    if (mp) {\n      mp.resolve(value);\n    }\n  }\n\n  match(pattern, timeout, strict) {\n    return this.matchAsync(pattern, { timeout, strict }).await();\n  }\n\n  // Like match, but returns a Promise without calling .await().\n  matchAsync(pattern, {\n    timeout = null,\n    strict = false,\n    matchFullBuffer = false,\n  }) {\n    if (this.matchPromise) {\n      return Promise.reject(new Error(\"already have a match pending?\"));\n    }\n    this.matchPattern = pattern;\n    this.matchStrict = strict;\n    this.matchFullBuffer = matchFullBuffer;\n    const mp = this.matchPromise = makeFulfillablePromise();\n    this._tryMatch(); // could clear this.matchPromise\n\n    let timer = null;\n    if (timeout) {\n      const failure = new TestFailure('match-timeout', {\n        run: this.run,\n        pattern: this.matchPattern,\n      });\n\n      timer = setTimeout(() => {\n        this.rejectMatch(failure);\n      }, timeout * 1000);\n    } else {\n      return mp;\n    }\n\n    return mp.then((result) => {\n      clearTimeout(timer);\n      return result;\n    }, (error) => {\n      clearTimeout(timer);\n      throw error;\n    });\n  }\n\n  matchBeforeEnd(pattern, timeout) {\n    return this._beforeEnd(() => this.matchAsync(pattern, {\n      timeout: timeout || 15,\n      matchFullBuffer: true,\n    }));\n  }\n\n  _beforeEnd(promiseCallback) {\n    this.endPromise = this.endPromise.then(promiseCallback);\n    return this.endPromise;\n  }\n\n  end() {\n    return this.endAsync().await();\n  }\n\n  endAsync() {\n    this.resolveEndPromise();\n    return this._beforeEnd(() => {\n      this.ended = true;\n      this._tryMatch();\n      return this.matchPromise;\n    });\n  }\n\n  matchEmpty() {\n    if (this.buf.length > 0) {\n      Console.info(\"Extra junk is :\", this.buf);\n      throw new TestFailure('junk-at-end', { run: this.run });\n    }\n  }\n\n  _tryMatch() {\n    const mp = this.matchPromise;\n    if (! mp) {\n      return;\n    }\n\n    let ret = null;\n\n    if (this.matchFullBuffer) {\n      // Note: this.matchStrict is ignored if this.matchFullBuffer truthy.\n      if (this.matchPattern instanceof RegExp) {\n        ret = this.fullBuffer.match(this.matchPattern);\n      } else if (this.fullBuffer.indexOf(this.matchPattern) >= 0) {\n        ret = this.matchPattern;\n      }\n    } else if (this.matchPattern instanceof RegExp) {\n      const m = this.buf.match(this.matchPattern);\n      if (m) {\n        if (this.matchStrict && m.index !== 0) {\n          Console.info(\"Extra junk is: \", this.buf.substr(0, m.index));\n          this.rejectMatch(new TestFailure('junk-before', {\n            run: this.run,\n            pattern: this.matchPattern,\n          }));\n          return;\n        }\n        ret = m;\n        this.buf = this.buf.slice(m.index + m[0].length);\n      }\n    } else {\n      const i = this.buf.indexOf(this.matchPattern);\n      if (i !== -1) {\n        if (this.matchStrict && i !== 0) {\n          Console.info(\"Extra junk is: \", this.buf.substr(0, i));\n          this.rejectMatch(new TestFailure('junk-before', {\n            run: this.run,\n            pattern: this.matchPattern,\n          }));\n          return;\n        }\n        ret = this.matchPattern;\n        this.buf = this.buf.slice(i + this.matchPattern.length);\n      }\n    }\n\n    if (ret !== null) {\n      this.resolveMatch(ret);\n      return;\n    }\n\n    if (this.ended) {\n      this.rejectMatch(new TestFailure('no-match', {\n        run: this.run,\n        pattern: this.matchPattern,\n      }));\n      return;\n    }\n  }\n}\n\nimport { markThrowingMethods } from \"./test-utils.js\";\nmarkThrowingMethods(Matcher.prototype);\n"],"file":"tools/tool-testing/matcher.js.map"}