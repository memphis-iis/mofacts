{"version":3,"sources":["/tools/tool-env/profile-require.js"],"names":["path","require","now","Date","currentInvocation","RequireInvocation","name","filename","self","timeStarted","timeFinished","parent","children","selfTime","totalTime","prototype","isOurCode","match","ourSource","resolve","__dirname","required","dirname","length","substr","why","walk","last","basename","exports","start","moduleModule","realLoader","_load","args","id","inv","push","apply","printReport","_","computeTimes","childTime","each","child","summary","summarize","depth","time","ours","via","times","sortBy","values","reverse","ourTotal","otherTotal","item","line","toFixed","Object","keys","join","console","log","grandTotal","Error"],"mappings":";AAAA;AACA;AACA,MAAIA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAAlB,C,CAEA;;;AACA,MAAIC,GAAG,GAAG,YAAY;AACpB,WAAQ,CAAE,IAAIC,IAAJ,EAAH,GAAa,IAApB;AACD,GAFD;;AAIA,MAAIC,iBAAJ;;AACA,MAAIC,iBAAiB,GAAG,UAAUC,IAAV,EAAgBC,QAAhB,EAA0B;AAChD,QAAIC,IAAI,GAAG,IAAX;AACAA,IAAAA,IAAI,CAACF,IAAL,GAAYA,IAAZ,CAFgD,CAE9B;;AAClBE,IAAAA,IAAI,CAACD,QAAL,GAAgBA,QAAhB,CAHgD,CAGtB;;AAC1BC,IAAAA,IAAI,CAACC,WAAL,GAAmBP,GAAG,EAAtB;AACAM,IAAAA,IAAI,CAACE,YAAL,GAAoB,IAApB;AACAF,IAAAA,IAAI,CAACG,MAAL,GAAcP,iBAAd;AACAI,IAAAA,IAAI,CAACI,QAAL,GAAgB,EAAhB,CAPgD,CAO5B;;AAEpBJ,IAAAA,IAAI,CAACK,QAAL,GAAgB,IAAhB;AACAL,IAAAA,IAAI,CAACM,SAAL,GAAiB,IAAjB;AACD,GAXD;;AAaAT,EAAAA,iBAAiB,CAACU,SAAlB,CAA4BC,SAA5B,GAAwC,YAAY;AAClD,QAAIR,IAAI,GAAG,IAAX;;AAEA,QAAI,CAAEA,IAAI,CAACD,QAAX,EAAqB;AACnB,aAAOC,IAAI,CAACF,IAAL,KAAc,KAArB;AACD;;AAED,QAAI,CAAEE,IAAI,CAACF,IAAL,CAAUW,KAAV,CAAgB,IAAhB,CAAN,EAA6B;AAC3B;AACA,aAAO,KAAP;AACD;;AAED,QAAIC,SAAS,GAAGlB,IAAI,CAACmB,OAAL,CAAaC,SAAb,CAAhB;AACA,QAAIC,QAAQ,GAAGrB,IAAI,CAACmB,OAAL,CAAanB,IAAI,CAACsB,OAAL,CAAad,IAAI,CAACD,QAAlB,CAAb,EAA0CC,IAAI,CAACF,IAA/C,CAAf;;AACA,QAAIY,SAAS,CAACK,MAAV,GAAmBF,QAAQ,CAACE,MAAhC,EAAwC;AACtC,aAAO,KAAP;AACD;;AACD,WAAOF,QAAQ,CAACG,MAAT,CAAgB,CAAhB,EAAmBN,SAAS,CAACK,MAA7B,MAAyCL,SAAhD;AACD,GAlBD;;AAoBAb,EAAAA,iBAAiB,CAACU,SAAlB,CAA4BU,GAA5B,GAAkC,YAAY;AAC5C,QAAIjB,IAAI,GAAG,IAAX;AACA,QAAIkB,IAAI,GAAGlB,IAAX;AACA,QAAImB,IAAI,GAAG,IAAX;;AAEA,WAAOD,IAAI,IAAI,CAAEA,IAAI,CAACV,SAAL,EAAjB,EAAmC;AACjCW,MAAAA,IAAI,GAAGD,IAAP;AACAA,MAAAA,IAAI,GAAGA,IAAI,CAACf,MAAZ;AACD;;AAED,QAAI,CAAEe,IAAN,EAAY;AACV,aAAO,KAAP;AACD;;AACD,QAAIC,IAAJ,EAAU;AACR,aAAO3B,IAAI,CAAC4B,QAAL,CAAcF,IAAI,CAACpB,IAAnB,IAA2B,GAA3B,GAAiCN,IAAI,CAAC4B,QAAL,CAAcD,IAAI,CAACrB,IAAnB,CAAxC;AACD;;AACD,WAAON,IAAI,CAAC4B,QAAL,CAAcF,IAAI,CAACpB,IAAnB,CAAP;AACD,GAjBD;;AAmBAuB,EAAAA,OAAO,CAACC,KAAR,GAAgB,YAAY;AAC1B,QAAIC,YAAY,GAAG9B,OAAO,CAAC,QAAD,CAA1B;;AACAG,IAAAA,iBAAiB,GAAG,IAAIC,iBAAJ,CAAsB,KAAtB,CAApB;AAEA,QAAI2B,UAAU,GAAGD,YAAY,CAACE,KAA9B;;AACAF,IAAAA,YAAY,CAACE,KAAb,GAAqB,YAAmB;AAAA,wCAANC,IAAM;AAANA,QAAAA,IAAM;AAAA;;AACtC,UAAI,CAACC,EAAD,EAAK;AAAE5B,QAAAA;AAAF,OAAL,IAAqB2B,IAAzB;AACA,UAAIE,GAAG,GAAG,IAAI/B,iBAAJ,CAAsB8B,EAAtB,EAA0B5B,QAA1B,CAAV;AACA,UAAII,MAAM,GAAGP,iBAAb;AACAA,MAAAA,iBAAiB,CAACQ,QAAlB,CAA2ByB,IAA3B,CAAgCD,GAAhC;AACAhC,MAAAA,iBAAiB,GAAGgC,GAApB;;AAEA,UAAI;AACF,eAAOJ,UAAU,CAACM,KAAX,CAAiB,IAAjB,EAAuBJ,IAAvB,CAAP;AACD,OAFD,SAEU;AACRE,QAAAA,GAAG,CAAC1B,YAAJ,GAAmBR,GAAG,EAAtB;AACAE,QAAAA,iBAAiB,GAAGO,MAApB;AACD;AACF,KAbD;AAcD,GAnBD;;AAqBAkB,EAAAA,OAAO,CAACU,WAAR,GAAsB,YAAY;AAChCnC,IAAAA,iBAAiB,CAACM,YAAlB,GAAiCR,GAAG,EAApC;;AACA,QAAIsC,CAAC,GAAGvC,OAAO,CAAC,YAAD,CAAf;;AAEA,QAAIwC,YAAY,GAAG,UAAUL,GAAV,EAAe;AAChCA,MAAAA,GAAG,CAACtB,SAAJ,GAAgBsB,GAAG,CAAC1B,YAAJ,GAAmB0B,GAAG,CAAC3B,WAAvC;AAEA,UAAIiC,SAAS,GAAG,CAAhB;;AACAF,MAAAA,CAAC,CAACG,IAAF,CAAOP,GAAG,CAACxB,QAAX,EAAqB,UAAUgC,KAAV,EAAiB;AACpCH,QAAAA,YAAY,CAACG,KAAD,CAAZ;AACAF,QAAAA,SAAS,IAAIE,KAAK,CAAC9B,SAAnB;AACD,OAHD;;AAKA,UAAIsB,GAAG,CAACtB,SAAJ,KAAkB,IAAtB,EAA4B;AAC1BsB,QAAAA,GAAG,CAACvB,QAAJ,GAAeuB,GAAG,CAACtB,SAAJ,GAAgB4B,SAA/B;AACD;AACF,KAZD;;AAaAD,IAAAA,YAAY,CAACrC,iBAAD,CAAZ;AAEA,QAAIyC,OAAO,GAAG,EAAd;;AACA,QAAIC,SAAS,GAAG,UAAUV,GAAV,EAAeW,KAAf,EAAsB;AACpC;AACA;AACA,UAAI,EAAGX,GAAG,CAAC9B,IAAJ,IAAYuC,OAAf,CAAJ,EAA6B;AAC3BA,QAAAA,OAAO,CAACT,GAAG,CAAC9B,IAAL,CAAP,GAAoB;AAAEA,UAAAA,IAAI,EAAE8B,GAAG,CAAC9B,IAAZ;AAAkB0C,UAAAA,IAAI,EAAE,CAAxB;AAA2BC,UAAAA,IAAI,EAAEb,GAAG,CAACpB,SAAJ,EAAjC;AACEkC,UAAAA,GAAG,EAAE;AADP,SAApB;AAED;;AACDL,MAAAA,OAAO,CAACT,GAAG,CAAC9B,IAAL,CAAP,CAAkB0C,IAAlB,IAA0BZ,GAAG,CAACvB,QAA9B;;AACA,UAAI,CAAEuB,GAAG,CAACpB,SAAJ,EAAN,EAAuB;AACrB6B,QAAAA,OAAO,CAACT,GAAG,CAAC9B,IAAL,CAAP,CAAkB4C,GAAlB,CAAsBd,GAAG,CAACX,GAAJ,EAAtB,IAAmC,IAAnC;AACD;;AAEDe,MAAAA,CAAC,CAACG,IAAF,CAAOP,GAAG,CAACxB,QAAX,EAAqB,UAAUwB,GAAV,EAAe;AAClCU,QAAAA,SAAS,CAACV,GAAD,EAAMW,KAAK,GAAG,CAAd,CAAT;AACD,OAFD;AAGD,KAfD;;AAgBAD,IAAAA,SAAS,CAAC1C,iBAAD,EAAoB,CAApB,CAAT;;AAEA,QAAI+C,KAAK,GAAGX,CAAC,CAACY,MAAF,CAASZ,CAAC,CAACa,MAAF,CAASR,OAAT,CAAT,EAA4B,MAA5B,EAAoCS,OAApC,EAAZ;;AACA,QAAIC,QAAQ,GAAG,CAAf;AAAA,QAAkBC,UAAU,GAAG,CAA/B;;AACAhB,IAAAA,CAAC,CAACG,IAAF,CAAOQ,KAAP,EAAc,UAAUM,IAAV,EAAgB;AAC5B,UAAIC,IAAI,GAAG,CAACD,IAAI,CAACT,IAAL,GAAY,IAAb,EAAmBW,OAAnB,CAA2B,CAA3B,IAAgC,GAAhC,GAAsCF,IAAI,CAACnD,IAAtD;;AACA,UAAI,CAAEmD,IAAI,CAACR,IAAX,EAAiB;AACfS,QAAAA,IAAI,IAAI,WAAWE,MAAM,CAACC,IAAP,CAAYJ,IAAI,CAACP,GAAjB,EAAsBY,IAAtB,CAA2B,IAA3B,CAAX,GAA8C,GAAtD;AACD;;AACDC,MAAAA,OAAO,CAACC,GAAR,CAAYN,IAAZ;;AACA,UAAID,IAAI,CAACR,IAAT,EAAe;AACbM,QAAAA,QAAQ,IAAIE,IAAI,CAACT,IAAjB;AACD,OAFD,MAEO;AACLQ,QAAAA,UAAU,IAAIC,IAAI,CAACT,IAAnB;AACD;AACF,KAXD;;AAcA,QAAIiB,UAAU,GAAG7D,iBAAiB,CAACU,SAAnC;;AACA,QAAImD,UAAU,GAAGV,QAAb,GAAwBC,UAAxB,GAAqC,IAAE,IAA3C,EAAiD;AAC/C,YAAM,IAAIU,KAAJ,CAAU,oBAAV,CAAN;AACD;;AACDH,IAAAA,OAAO,CAACC,GAAR,CAAY,iBAAiB,CAACT,QAAQ,GAAG,IAAZ,EAAkBI,OAAlB,CAA0B,CAA1B,CAAjB,GACA,UADA,GACa,CAACH,UAAU,GAAG,IAAd,EAAoBG,OAApB,CAA4B,CAA5B,CADb,GAEA,gBAFA,GAEmB,CAACM,UAAU,GAAG,IAAd,EAAoBN,OAApB,CAA4B,CAA5B,CAF/B;AAGD,GA7DD","sourcesContent":["// Use path instead of files.js here because we are explicitly trying to\n// track requires, and files.js is often a culprit of slow requires.\nvar path = require('path');\n\n// seconds since epoch\nvar now = function () {\n  return (+ new Date)/1000;\n};\n\nvar currentInvocation;\nvar RequireInvocation = function (name, filename) {\n  var self = this;\n  self.name = name; // module required\n  self.filename = filename; // file doing the requiring, if known\n  self.timeStarted = now();\n  self.timeFinished = null;\n  self.parent = currentInvocation;\n  self.children = []; // array of RequireInvocation\n\n  self.selfTime = null;\n  self.totalTime = null;\n};\n\nRequireInvocation.prototype.isOurCode = function () {\n  var self = this;\n\n  if (! self.filename) {\n    return self.name === 'TOP';\n  }\n\n  if (! self.name.match(/\\//)) {\n    // we always require our stuff via a path\n    return false;\n  }\n\n  var ourSource = path.resolve(__dirname);\n  var required = path.resolve(path.dirname(self.filename), self.name);\n  if (ourSource.length > required.length) {\n    return false;\n  }\n  return required.substr(0, ourSource.length) === ourSource;\n};\n\nRequireInvocation.prototype.why = function () {\n  var self = this;\n  var walk = self;\n  var last = null;\n\n  while (walk && ! walk.isOurCode()) {\n    last = walk;\n    walk = walk.parent;\n  }\n\n  if (! walk) {\n    return \"???\";\n  }\n  if (last) {\n    return path.basename(walk.name) + \":\" + path.basename(last.name);\n  }\n  return path.basename(walk.name);\n};\n\nexports.start = function () {\n  var moduleModule = require('module');\n  currentInvocation = new RequireInvocation('TOP');\n\n  var realLoader = moduleModule._load;\n  moduleModule._load = function (...args) {\n    var [id, { filename }] = args;\n    var inv = new RequireInvocation(id, filename);\n    var parent = currentInvocation;\n    currentInvocation.children.push(inv);\n    currentInvocation = inv;\n\n    try {\n      return realLoader.apply(this, args);\n    } finally {\n      inv.timeFinished = now();\n      currentInvocation = parent;\n    }\n  };\n};\n\nexports.printReport = function () {\n  currentInvocation.timeFinished = now();\n  var _ = require('underscore');\n\n  var computeTimes = function (inv) {\n    inv.totalTime = inv.timeFinished - inv.timeStarted;\n\n    var childTime = 0;\n    _.each(inv.children, function (child) {\n      computeTimes(child);\n      childTime += child.totalTime;\n    });\n\n    if (inv.totalTime !== null) {\n      inv.selfTime = inv.totalTime - childTime;\n    }\n  };\n  computeTimes(currentInvocation);\n\n  var summary = {};\n  var summarize = function (inv, depth) {\n    // var padding = (new Array(depth*2 + 1)).join(' ');\n    // console.log(padding + inv.name + \" [\" + inv.selfTime + \"]\");\n    if (! (inv.name in summary)) {\n      summary[inv.name] = { name: inv.name, time: 0, ours: inv.isOurCode(),\n                            via: {} };\n    }\n    summary[inv.name].time += inv.selfTime;\n    if (! inv.isOurCode()) {\n      summary[inv.name].via[inv.why()] = true;\n    }\n\n    _.each(inv.children, function (inv) {\n      summarize(inv, depth + 1);\n    });\n  };\n  summarize(currentInvocation, 0);\n\n  var times = _.sortBy(_.values(summary), 'time').reverse();\n  var ourTotal = 0, otherTotal = 0;\n  _.each(times, function (item) {\n    var line = (item.time * 1000).toFixed(2) + \" \" + item.name;\n    if (! item.ours) {\n      line += \" [via \" + Object.keys(item.via).join(\", \") + \"]\";\n    }\n    console.log(line);\n    if (item.ours) {\n      ourTotal += item.time;\n    } else {\n      otherTotal += item.time;\n    }\n  });\n\n\n  var grandTotal = currentInvocation.totalTime;\n  if (grandTotal - ourTotal - otherTotal > 1/1000) {\n    throw new Error(\"Times don't add up\");\n  }\n  console.log(\"TOTAL: ours \" + (ourTotal * 1000).toFixed(2) +\n              \", other \" + (otherTotal * 1000).toFixed(2) +\n              \", grand total \" + (grandTotal * 1000).toFixed(2));\n};\n"],"file":"tools/tool-env/profile-require.js.map"}