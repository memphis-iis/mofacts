{"version":3,"sources":["/tools/packaging/package-map.js"],"names":["isIsobuildFeaturePackage","module","link","v","_","require","packageVersionParser","utils","exports","PackageMap","versions","options","self","_map","_localCatalog","localCatalog","each","version","packageName","packageSource","getPackageSource","kind","Object","assign","prototype","eachPackage","iterator","info","infoClone","clone","getInfo","has","makeSubsetMap","packageNames","subsetVersions","Error","toJSON","ret","sourceRoot","toVersionMap","isSupersetOfJSON","mapJSON","all","jsonInfo","thisInfo","fromReleaseVersion","releaseVersion","toolPackageVersion","tool","parsePackageAndVersion","toolPackage","package","toolVersion","versionMap","packages","PackageMapDelta","_changedPackages","packageMap","oldVersion","cachedVersions","_storeAddOrChange","anticipatedPrereleases","neededToUseUnanticipatedPrereleases","_storeRemove","newInfo","backwardsIncompatible","majorVersion","isPrerelease","test","isAnticipatedPrerelease","newVersion","isBackwardsIncompatible","isUnanticipatedPrerelease","eachChangedPackage","hasChanges","isEmpty","displayOnConsole","title","displayItems","anyBackwardsIncompatible","anyUnanticipatedPrerelease","push","name","description","lessThan","deprecated","deprecatedMessage","Console","printPackageList"],"mappings":"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","sourcesContent":["var _ = require('underscore');\nvar packageVersionParser = require('./package-version-parser.js');\nvar utils = require('../utils/utils.js');\nimport { isIsobuildFeaturePackage } from '../isobuild/compiler.js';\n\n// PackageMap: Represents the choices of package versions being used for a\n// project. It knows all the packages that are used (direct and indirect\n// dependencies), their versions, whether they are local or versioned packages,\n// and the PackageSource object for any local packages.  Prefer using this\n// function over arbitrary JSON representations when possible.  (A related class\n// is projectContextModule.PackageMapFile which specifically represents the\n// .meteor/packages file on disk.)\n//\n// It has a corresponding JSON format (used, eg, inside buildinfo files).\n//\n// If you specify the localCatalog option to the constructor, any package in\n// that localCatalog will be considered to be local, and all others will be\n// considered to be prebuilt versioned packages from troposphere.  If you do not\n// specify the localCatalog option, all packages will be considered to prebuilt\n// versioned packages.\nexports.PackageMap = function (versions, options) {\n  var self = this;\n  options = options || {};\n  self._map = {};\n  self._localCatalog = options.localCatalog || null;\n\n  _.each(versions, function (version, packageName) {\n    // If the constraint solver told us that we needed an isobuild feature,\n    // that's fine, but it's not a real package.\n    if (isIsobuildFeaturePackage(packageName)) {\n      return;\n    }\n\n    var packageSource = self._localCatalog &&\n          self._localCatalog.getPackageSource(packageName);\n    if (packageSource) {\n      self._map[packageName] =\n        { kind: 'local', version: version, packageSource: packageSource };\n    } else {\n      self._map[packageName] =\n        { kind: 'versioned', version: version, packageSource: null };\n    }\n  });\n};\n\nObject.assign(exports.PackageMap.prototype, {\n  eachPackage: function (iterator) {\n    var self = this;\n    _.each(self._map, function (info, packageName) {\n      // For reasons that are super unclear, if this `_.clone` is inlined into\n      // the `iterator` call, the value produced can mysteriously turn into\n      // undefined on the way into `iterator`. Presumably some sort of memory\n      // corruption, maybe Fiber-related?  Trying to minimize has been an\n      // exercise in nondeterminism. But this does seem to be a sure-fire way to\n      // fix it, for now. Who knows why, and who knows when it will recur again.\n      var infoClone = _.clone(info);\n      iterator(packageName, infoClone);\n    });\n  },\n  getInfo: function (packageName) {\n    var self = this;\n    if (_.has(self._map, packageName)) {\n      return self._map[packageName];\n    }\n    return null;\n  },\n  makeSubsetMap: function (packageNames) {\n    var self = this;\n    var subsetVersions = {};\n    _.each(packageNames, function (packageName) {\n      var info = self.getInfo(packageName);\n      if (!info) {\n        throw Error(\"not a subset: \" + packageName);\n      }\n      subsetVersions[packageName] = info.version;\n    });\n    return new exports.PackageMap(subsetVersions, {\n      localCatalog: self._localCatalog\n    });\n  },\n\n  toJSON: function () {\n    var self = this;\n    var ret = {};\n    _.each(self._map, function (info, packageName) {\n      if (info.kind === 'local') {\n        ret[packageName] = {\n          kind: 'local',\n          sourceRoot: info.packageSource.sourceRoot\n        };\n      } else {\n        ret[packageName] = {\n          kind: 'versioned',\n          version: info.version\n        };\n      }\n    });\n    return ret;\n  },\n  // Returns a map from package name to version. In most cases, this is a far\n  // worse representation than PackageMap... avoid using it!\n  toVersionMap: function () {\n    var self = this;\n    var ret = {};\n    _.each(self._map, function (info, packageName) {\n      ret[packageName] = info.version;\n    });\n    return ret;\n  },\n\n  // Given some JSON as returned from toJSON, returns true if every package in\n  // the JSON has the same mapping as in this map.\n  isSupersetOfJSON: function (mapJSON) {\n    var self = this;\n    return _.all(mapJSON, function (jsonInfo, packageName) {\n      var thisInfo = self.getInfo(packageName);\n      if (! thisInfo) {\n        return false;\n      }\n      if (jsonInfo.kind !== thisInfo.kind) {\n        return false;\n      }\n      if (thisInfo.kind === 'local') {\n        return thisInfo.packageSource.sourceRoot === jsonInfo.sourceRoot;\n      } else {\n        return thisInfo.version === jsonInfo.version;\n      }\n    });\n  }\n});\n\n// Static method: returns a PackageMap that represents a (catalog)\n// ReleaseVersion entry (including its tool).  Note that this function assumes\n// that all packages will be prebuilt versioned, not local. This is mostly used\n// to create PackageMaps to pass to tropohouse.downloadPackagesMissingFromMap;\n// it should not be used as part of a ProjectContext because it does not allow\n// you to override release packages with local packages.\nexports.PackageMap.fromReleaseVersion = function (releaseVersion) {\n  var toolPackageVersion = releaseVersion.tool &&\n        utils.parsePackageAndVersion(releaseVersion.tool);\n  if (!toolPackageVersion) {\n    throw new Error(\"bad tool in release: \" + releaseVersion.tool);\n  }\n  var toolPackage = toolPackageVersion.package;\n  var toolVersion = toolPackageVersion.version;\n\n  var versionMap = _.clone(releaseVersion.packages || {});\n  versionMap[toolPackage] = toolVersion;\n\n  // As described in this function's description, all packages in this map are\n  // versioned, so we do not specify a localCatalog.\n  return new exports.PackageMap(versionMap);\n};\n\n\n\n// PackageMapDelta: represents the change in a PackageMap between two constraint\n// solver runs.\nexports.PackageMapDelta = function (options) {\n  var self = this;\n  self._changedPackages = {};\n\n  options.packageMap.eachPackage(function (packageName, info) {\n    var oldVersion = _.has(options.cachedVersions, packageName)\n          ? options.cachedVersions[packageName] : null;\n    self._storeAddOrChange(\n      packageName, info, oldVersion, options.anticipatedPrereleases,\n      options.neededToUseUnanticipatedPrereleases);\n  });\n\n  _.each(options.cachedVersions, function (oldVersion, packageName) {\n    if (! options.packageMap.getInfo(packageName)) {\n      self._storeRemove(packageName, oldVersion);\n    }\n  });\n};\n\nObject.assign(exports.PackageMapDelta.prototype, {\n  _storeAddOrChange: function (packageName, newInfo, oldVersion,\n                               anticipatedPrereleases,\n                               neededToUseUnanticipatedPrereleases) {\n    var self = this;\n\n    // Store nothing if nothing has changed.\n    if (newInfo.version === oldVersion) {\n      return;\n    }\n\n    var backwardsIncompatible =\n          oldVersion !== null &&\n          (packageVersionParser.majorVersion(newInfo.version) !==\n           packageVersionParser.majorVersion(oldVersion));\n\n    var isPrerelease = /-/.test(newInfo.version);\n    var isAnticipatedPrerelease = _.has(anticipatedPrereleases, packageName) &&\n          _.has(anticipatedPrereleases[packageName], newInfo.version);\n    self._changedPackages[packageName] = {\n      oldVersion: oldVersion,\n      newVersion: newInfo.version,\n      isBackwardsIncompatible: backwardsIncompatible,\n      isUnanticipatedPrerelease: (neededToUseUnanticipatedPrereleases &&\n                                  isPrerelease && !isAnticipatedPrerelease)\n    };\n  },\n\n  _storeRemove: function (packageName, oldVersion) {\n    var self = this;\n    self._changedPackages[packageName] = {\n      oldVersion: oldVersion,\n      newVersion: null\n    };\n  },\n\n  eachChangedPackage: function (iterator) {\n    var self = this;\n    _.each(self._changedPackages, function (info, packageName) {\n      iterator(packageName, _.clone(info));\n    });\n  },\n\n  hasChanges: function () {\n    var self = this;\n    return ! _.isEmpty(self._changedPackages);\n  },\n\n  displayOnConsole: function (options) {\n    var self = this;\n    options = Object.assign({\n      title: \"Changes to your project's package version selections:\"\n    }, options);\n\n    // Print nothing at all if nothing changed.\n    if (! self.hasChanges()) {\n      return;\n    }\n\n    var displayItems = [];\n    var anyBackwardsIncompatible = false;\n    var anyUnanticipatedPrerelease = false;\n    self.eachChangedPackage(function (packageName, info) {\n      if (info.newVersion === null) {\n        displayItems.push({\n          name: packageName,\n          description: \"removed from your project\"\n        });\n        return;\n      }\n\n      var name = packageName;\n      if (info.isBackwardsIncompatible) {\n        name += '*';\n        anyBackwardsIncompatible = true;\n      }\n      if (info.isUnanticipatedPrerelease) {\n        name += '+';\n        anyUnanticipatedPrerelease = true;\n      }\n\n      var description;\n      if (info.oldVersion === null) {\n        description = \"added, version \" + info.newVersion;\n      } else if (packageVersionParser.lessThan(info.oldVersion,\n                                               info.newVersion)) {\n        description =\n          \"upgraded from \" + info.oldVersion + \" to \" + info.newVersion;\n      } else {\n        description =\n          \"downgraded from \" + info.oldVersion + \" to \" + info.newVersion;\n      }\n\n      if (info.deprecated) {\n        name += ' - DEPRECATED';\n        if (info.deprecatedMessage) {\n          description += ' - ' + info.deprecatedMessage;\n        }\n      }\n\n      displayItems.push({ name: name, description: description });\n    });\n\n    var Console = require('../console/console.js').Console;\n\n    Console.info();\n    Console.info(options.title);\n    Console.info();\n    utils.printPackageList(displayItems);\n    if (anyBackwardsIncompatible) {\n      Console.info(\"\\n\" +\n\"* These packages have been updated to new versions that are not backwards\\n\" +\n\"  compatible.\");\n    }\n    if (anyUnanticipatedPrerelease) {\n      Console.info(\"\\n\" +\n\"+ In order to resolve constraints, we had to use experimental versions of these\\n\" +\n\"  packages.\");\n    }\n  }\n});\n"],"file":"tools/packaging/package-map.js.map"}