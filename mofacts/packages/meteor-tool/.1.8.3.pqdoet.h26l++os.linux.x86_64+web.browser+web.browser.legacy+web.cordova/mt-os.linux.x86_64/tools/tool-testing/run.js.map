{"version":3,"sources":["/tools/tool-testing/run.js"],"names":["module","export","default","Run","spawn","link","v","files","parseStackMarkTop","parseStackParse","markTop","parse","Console","Matcher","OutputLog","randomPort","timeoutScaleFactor","sleepMs","TestFailure","execFileSync","markThrowingMethods","runningTest","constructor","execPath","options","cwd","convertToStandardPath","process","env","Object","assign","SELFTEST","METEOR_NO_WORDWRAP","_args","proc","baseTimeout","extraTime","client","stdoutMatcher","stderrMatcher","outputLog","matcherEndPromise","exitStatus","undefined","exitPromiseResolvers","opts","args","apply","fakeMongoPort","fakeMongoConnection","fakeMongo","METEOR_TEST_FAKE_MONGOD_CONTROL_PORT","onCleanup","_stopWithoutWaiting","Error","forEach","a","push","keys","key","value","connectClient","_ensureStarted","connect","matchBeforeExit","pattern","matchBeforeEnd","matchErrBeforeExit","_exited","status","stop","resolve","_endMatchers","Promise","all","endAsync","create","convertToOSPath","on","code","signal","err","stdout","setEncoding","data","write","stderr","match","_strict","timeout","matchErr","read","readErr","forbid","forbidErr","forbidAll","expectEnd","expectExit","matchEmpty","await","timer","failure","run","promise","reject","setTimeout","filter","r","clearTimeout","expected","actual","waitSecs","secs","string","stdin","_killProcess","platform","pid","kill","tellMongo","command","net","require","lastStartTime","attempts","Date","conn","setNoDelay","fail","JSON","stringify","exit","end","runTest","testList","test","testRunner","retries","startTime","e","cleanup","durationMs","error","indent","frames","outsideFiber","toolsDir","getCurrentToolsDir","pathWithLineNumber","some","frame","absPath","pathJoin","file","exists","relPath","pathRelative","parts","split","line","rawError","reason","arrowError","details","s","lines","get","length","historyLines","slice","channel","text","bare","messages","formatMessages","stack","notifyFailed","prototype"],"mappings":"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","sourcesContent":["// Represents a test run of the tool (except we also use it in\n// tests/old.js to run Node scripts). Typically created through the\n// run() method on Sandbox, but can also be created directly, say if\n// you want to do something other than invoke the 'meteor' command in\n// a nice sandbox.\n//\n// Options: args, cwd, env\n//\n// The 'execPath' argument and the 'cwd' option are assumed to be standard\n// paths.\n//\n// Arguments in the 'args' option are not assumed to be standard paths, so\n// calling any of the 'files.*' methods on them is not safe.\nimport { spawn } from 'child_process';\nimport * as files from '../fs/files';\nimport {\n  markTop as parseStackMarkTop,\n  parse as parseStackParse,\n} from '../utils/parse-stack.js';\nimport { Console } from '../console/console.js';\nimport Matcher from './matcher.js';\nimport OutputLog from './output-log.js';\nimport { randomPort, timeoutScaleFactor, sleepMs } from '../utils/utils.js';\nimport TestFailure from './test-failure.js';\nimport { execFileSync } from '../utils/processes';\n\nlet runningTest = null;\n\nexport default class Run {\n  constructor(execPath, options) {\n    this.execPath = execPath;\n    this.cwd = options.cwd || files.convertToStandardPath(process.cwd());\n    // default env variables\n    this.env = Object.assign({ SELFTEST: \"t\", METEOR_NO_WORDWRAP: \"t\" }, options.env);\n    this._args = [];\n    this.proc = null;\n    this.baseTimeout = 20;\n    this.extraTime = 0;\n    this.client = options.client;\n\n    this.stdoutMatcher = new Matcher(this);\n    this.stderrMatcher = new Matcher(this);\n    this.outputLog = new OutputLog(this);\n\n    this.matcherEndPromise = null;\n\n    this.exitStatus = undefined; // 'null' means failed rather than exited\n    this.exitPromiseResolvers = [];\n    const opts = options.args || [];\n    this.args.apply(this, opts || []);\n\n    this.fakeMongoPort = null;\n    this.fakeMongoConnection = null;\n    if (options.fakeMongo) {\n      this.fakeMongoPort = randomPort();\n      this.env.METEOR_TEST_FAKE_MONGOD_CONTROL_PORT = this.fakeMongoPort;\n    }\n\n    runningTest.onCleanup(() => {\n      this._stopWithoutWaiting();\n    });\n  }\n\n  // Set command-line arguments. This may be called multiple times as\n  // long as the run has not yet started (the run starts after the\n  // first call to a function that requires it, like match()).\n  //\n  // Pass as many arguments as you want. Non-object values will be\n  // cast to string, and object values will be treated as maps from\n  // option names to values.\n  args(...args) {\n    if (this.proc) {\n      throw new Error(\"already started?\");\n    }\n\n    args.forEach((a) => {\n      if (typeof a !== \"object\") {\n        this._args.push(`${a}`);\n      } else {\n        Object.keys(a).forEach((key) => {\n          const value = a[key];\n          this._args.push(`--${key}`);\n          this._args.push(`${value}`);\n        });\n      }\n    });\n  }\n\n  connectClient() {\n    if (!this.client) {\n      throw new Error(\"Must create Run with a client to use connectClient().\");\n    }\n\n    this._ensureStarted();\n    this.client.connect();\n  }\n\n  // Useful for matching one-time patterns not sensitive to ordering.\n  matchBeforeExit(pattern) {\n    return this.stdoutMatcher.matchBeforeEnd(pattern);\n  }\n\n  matchErrBeforeExit(pattern) {\n    return this.stderrMatcher.matchBeforeEnd(pattern);\n  }\n\n  _exited(status) {\n    if (this.exitStatus !== undefined) {\n      throw new Error(\"already exited?\");\n    }\n\n    if (this.client) {\n      this.client.stop();\n    }\n\n    this.exitStatus = status;\n    const exitPromiseResolvers = this.exitPromiseResolvers;\n    this.exitPromiseResolvers = null;\n    exitPromiseResolvers.forEach((resolve) => {\n      resolve();\n    });\n\n    this._endMatchers();\n  }\n\n  _endMatchers() {\n    this.matcherEndPromise =\n      this.matcherEndPromise || Promise.all([\n        this.stdoutMatcher.endAsync(),\n        this.stderrMatcher.endAsync()\n      ]);\n    return this.matcherEndPromise;\n  }\n\n  _ensureStarted() {\n    if (this.proc) {\n      return;\n    }\n\n    const env = Object.assign(Object.create(null), process.env);\n    Object.assign(env, this.env);\n\n    this.proc = spawn(files.convertToOSPath(this.execPath),\n      this._args, {\n        cwd: files.convertToOSPath(this.cwd),\n        env,\n      });\n\n    this.proc.on('close', (code, signal) => {\n      if (this.exitStatus === undefined) {\n        this._exited({ code, signal });\n      }\n    });\n\n    this.proc.on('exit', (code, signal) => {\n      if (this.exitStatus === undefined) {\n        this._exited({ code, signal });\n      }\n    });\n\n    this.proc.on('error', (err) => {\n      if (this.exitStatus === undefined) {\n        this._exited(null);\n      }\n    });\n\n    this.proc.stdout.setEncoding('utf8');\n    this.proc.stdout.on('data', (data) => {\n      this.outputLog.write('stdout', data);\n      this.stdoutMatcher.write(data);\n    });\n\n    this.proc.stderr.setEncoding('utf8');\n    this.proc.stderr.on('data', (data) => {\n      this.outputLog.write('stderr', data);\n      this.stderrMatcher.write(data);\n    });\n  }\n\n  // Wait until we get text on stdout that matches 'pattern', which\n  // may be a regular expression or a string. Consume stdout up to\n  // that point. If this pattern does not appear after a timeout (or\n  // the program exits before emitting the pattern), fail.\n  match(pattern, _strict) {\n    this._ensureStarted();\n\n    let timeout = this.baseTimeout + this.extraTime;\n    timeout *= timeoutScaleFactor;\n    this.extraTime = 0;\n    return this.stdoutMatcher.match(pattern, timeout, _strict);\n  }\n\n  // As expect(), but for stderr instead of stdout.\n  matchErr(pattern, _strict) {\n    this._ensureStarted();\n\n    let timeout = this.baseTimeout + this.extraTime;\n    timeout *= timeoutScaleFactor;\n    this.extraTime = 0;\n    return this.stderrMatcher.match(pattern, timeout, _strict);\n  }\n\n  // Like match(), but won't skip ahead looking for a match. It must\n  // follow immediately after the last thing we matched or read.\n  read(pattern) {\n    return this.match(pattern, true);\n  }\n\n  // As read(), but for stderr instead of stdout.\n  readErr(pattern) {\n    return this.matchErr(pattern, true);\n  }\n\n  // Assert that 'pattern' (again, a regexp or string) has not\n  // occurred on stdout at any point so far in this run. Currently\n  // this works on complete lines, so unlike match() and read(),\n  // 'pattern' cannot span multiple lines, and furthermore if it is\n  // called before the end of the program, it may not see text on a\n  // partially read line. We could lift these restrictions easily, but\n  // there may not be any benefit since the usual way to use this is\n  // to call it after expectExit or expectEnd.\n  //\n  // Example:\n  // run = s.run(\"--help\");\n  // run.expectExit(1);  // <<-- improtant to actually run the command\n  // run.forbidErr(\"unwanted string\"); // <<-- important to run **after** the\n  //                                   // command ran the process.\n  forbid(pattern) {\n    this._ensureStarted();\n    this.outputLog.forbid(pattern, 'stdout');\n  }\n\n  // As forbid(), but for stderr instead of stdout.\n  forbidErr(pattern) {\n    this._ensureStarted();\n    this.outputLog.forbid(pattern, 'stderr');\n  }\n\n  // Combination of forbid() and forbidErr(). Forbids the pattern on\n  // both stdout and stderr.\n  forbidAll(pattern) {\n    this._ensureStarted();\n    this.outputLog.forbid(pattern);\n  }\n\n  // Expect the program to exit without anything further being\n  // printed on either stdout or stderr.\n  expectEnd() {\n    this._ensureStarted();\n\n    let timeout = this.baseTimeout + this.extraTime;\n    timeout *= timeoutScaleFactor;\n    this.extraTime = 0;\n    this.expectExit();\n\n    this.stdoutMatcher.matchEmpty();\n    this.stderrMatcher.matchEmpty();\n  }\n\n  // Expect the program to exit with the given (numeric) exit\n  // status. Fail if the process exits with a different code, or if\n  // the process does not exit after a timeout. You can also omit the\n  // argument to simply wait for the program to exit.\n  expectExit(code) {\n    this._ensureStarted();\n\n    this._endMatchers().await();\n\n    if (this.exitStatus === undefined) {\n      let timeout = this.baseTimeout + this.extraTime;\n      timeout *= timeoutScaleFactor;\n      this.extraTime = 0;\n\n      let timer;\n      const failure = new TestFailure('exit-timeout', { run: this });\n      const promise = new Promise((resolve, reject) => {\n        this.exitPromiseResolvers.push(resolve);\n        timer = setTimeout(() => {\n          this.exitPromiseResolvers =\n            this.exitPromiseResolvers.filter(r => r !== resolve);\n          reject(failure);\n        }, timeout * 1000);\n      });\n\n      try {\n        promise.await();\n      } finally {\n        clearTimeout(timer);\n      }\n    }\n\n    if (! this.exitStatus) {\n      throw new TestFailure('spawn-failure', { run: this });\n    }\n    if (code !== undefined && this.exitStatus.code !== code) {\n      throw new TestFailure('wrong-exit-code', {\n        expected: { code },\n        actual: this.exitStatus,\n        run: this,\n      });\n    }\n  }\n\n  // Extend the timeout for the next operation by 'secs' seconds.\n  waitSecs(secs) {\n    this.extraTime += secs;\n  }\n\n  // Send 'string' to the program on its stdin.\n  write(string) {\n    this._ensureStarted();\n    this.proc.stdin.write(string);\n  }\n\n  // Kill the program and then wait for it to actually exit.\n  stop() {\n    if (this.exitStatus === undefined) {\n      this._ensureStarted();\n      if (this.client) {\n        this.client.stop();\n      }\n      this._killProcess();\n      this.expectExit();\n    }\n  }\n\n  // Like stop, but doesn't wait for it to exit.\n  _stopWithoutWaiting() {\n    if (this.exitStatus === undefined && this.proc) {\n      if (this.client) {\n        this.client.stop();\n      }\n      this._killProcess();\n    }\n  }\n\n  // Kills the running process and it's child processes\n  _killProcess() {\n    if (!this.proc) {\n      throw new Error(\"Unexpected: `this.proc` undefined when calling _killProcess\");\n    }\n\n    if (process.platform === \"win32\") {\n      // looks like in Windows `this.proc.kill()` doesn't kill child\n      // processes.\n      execFileSync(\"taskkill\", [\"/pid\", this.proc.pid, '/f', '/t']);\n    } else {\n      this.proc.kill();\n    }\n  }\n\n  // If the fakeMongo option was set, sent a command to the stub\n  // mongod. Available commands currently are:\n  //\n  // - { stdout: \"xyz\" } to make fake-mongod write \"xyz\" to stdout\n  // - { stderr: \"xyz\" } likewise for stderr\n  // - { exit: 123 } to make fake-mongod exit with code 123\n  //\n  // Blocks until a connection to fake-mongod can be\n  // established. Throws a TestFailure if it cannot be established.\n  tellMongo(command) {\n    if (! this.fakeMongoPort) {\n      throw new Error(\"fakeMongo option on sandbox must be set\");\n    }\n\n    this._ensureStarted();\n\n    // If it's the first time we've called tellMongo on this sandbox,\n    // open a connection to fake-mongod. Wait up to 60 seconds for it\n    // to accept the connection, retrying every 100ms.\n    //\n    // XXX we never clean up this connection. Hopefully once\n    // fake-mongod has dropped its end of the connection, and we hold\n    // no reference to our end, it will get gc'd. If not, that's not\n    // great, but it probably doesn't actually create any practical\n    // problems since this is only for testing.\n    if (! this.fakeMongoConnection) {\n      const net = require('net');\n\n      let lastStartTime = 0;\n      for (\n        let attempts = 0;\n        !this.fakeMongoConnection && attempts < 600;\n        attempts++\n      ) {\n        // Throttle attempts to one every 100ms\n        sleepMs((lastStartTime + 100) - (+ new Date()));\n        lastStartTime = +(new Date());\n\n        new Promise((resolve) => {\n          // This is all arranged so that if a previous attempt\n          // belatedly succeeds, somehow, we ignore it.\n          const conn = net.connect(this.fakeMongoPort, () => {\n            if (resolve) {\n              this.fakeMongoConnection = conn;\n              resolve(true);\n              resolve = null;\n            }\n          });\n          conn.setNoDelay();\n          function fail() {\n            if (resolve) {\n              resolve(false);\n              resolve = null;\n            }\n          }\n          conn.on('error', fail);\n          setTimeout(fail, 100); // 100ms connection timeout\n        }).await();\n      }\n\n      if (!this.fakeMongoConnection) {\n        throw new TestFailure(\"mongo-not-running\", { run: this });\n      }\n    }\n\n    this.fakeMongoConnection.write(`${JSON.stringify(command)}\\n`);\n    // If we told it to exit, then we should close our end and connect again if\n    // asked to send more.\n    if (command.exit) {\n      this.fakeMongoConnection.end();\n      this.fakeMongoConnection = null;\n    }\n  }\n\n  static runTest(testList, test, testRunner, options = {}) {\n    options.retries = options.retries || 0;\n\n    let failure = null;\n    let startTime;\n    try {\n      runningTest = test;\n      startTime = +(new Date);\n      // ensure we mark the bottom of the stack each time we start a new test\n      testRunner();\n    } catch (e) {\n      failure = e;\n    } finally {\n      runningTest = null;\n      test.cleanup();\n    }\n\n    test.durationMs = +(new Date) - startTime;\n\n    if (failure) {\n      Console.error(\"... fail!\", Console.options({ indent: 2 }));\n\n      if (options.retries > 0) {\n        Console.error(\n          \"... retrying (\" +\n          options.retries +\n          (options.retries === 1 ? \" try\" : \" tries\") +\n          \" remaining) ...\",\n          Console.options({ indent: 2 })\n        );\n\n        options.retries--;\n\n        return this.runTest(testList, test, testRunner, options);\n      }\n\n      if (failure instanceof TestFailure) {\n        const frames = parseStackParse(failure).outsideFiber;\n        const toolsDir = files.getCurrentToolsDir();\n        let pathWithLineNumber;\n        frames.some(frame => {\n          // The parsed stack trace will typically include frame.file\n          // strings of the form \"/tools/tests/whatever.js\", which can be\n          // made absolute by joining them with toolsDir. If the resulting\n          // absPath exists, then we know we interpreted the frame.file\n          // correctly, and we can normalize away the leading '/'\n          // character to get a safe relative path.\n          const absPath = files.pathJoin(toolsDir, frame.file);\n          if (files.exists(absPath)) {\n            const relPath = files.pathRelative(toolsDir, absPath);\n            const parts = relPath.split(\"/\");\n            if (parts[0] === \"tools\" &&\n                parts[1] === \"tool-testing\") {\n              // Ignore frames inside the /tools/tool-testing directory,\n              // like run.js and selftest.js.\n              return false;\n            }\n            pathWithLineNumber = `${relPath}:${frame.line}`;\n            return true;\n          }\n          // If frame.file was not joinable with toolsDir to obtain an\n          // absolute path that exists, show it to the user without trying\n          // to interpret what it means.\n          pathWithLineNumber = `${frame.file}:${frame.line}`;\n          return true;\n        });\n\n        Console.rawError(\n          `  => ${failure.reason} at ${pathWithLineNumber}\\n`);\n        if (failure.reason === 'no-match' || failure.reason === 'junk-before' ||\n            failure.reason === 'match-timeout') {\n          Console.arrowError(`Pattern: ${failure.details.pattern}`, 2);\n        }\n        if (failure.reason === \"wrong-exit-code\") {\n          const s = status => `${status.signal || status.code || \"???\"}`;\n\n          Console.rawError(\n            `  => Expected: ${s(failure.details.expected)}` +\n            `; actual: ${s(failure.details.actual)}\\n`);\n        }\n        if (failure.reason === 'expected-exception') {\n        }\n        if (failure.reason === 'not-equal') {\n          Console.rawError(\n            \"  => Expected: \" + JSON.stringify(failure.details.expected) +\n              \"; actual: \" + JSON.stringify(failure.details.actual) + \"\\n\");\n        }\n\n        if (failure.details.run) {\n          failure.details.run.outputLog.end();\n          const lines = failure.details.run.outputLog.get();\n          if (! lines.length) {\n            Console.arrowError(\"No output\", 2);\n          } else {\n            const historyLines = options.historyLines || 100;\n\n            Console.arrowError(`Last ${historyLines} lines:`, 2);\n            lines.slice(-historyLines).forEach((line) => {\n              Console.rawError(\"  \" +\n                               (line.channel === \"stderr\" ? \"2| \" : \"1| \") +\n                               line.text +\n                               (line.bare ? \"%\" : \"\") + \"\\n\");\n            });\n          }\n        }\n\n        if (failure.details.messages) {\n          Console.arrowError(\"Errors while building:\", 2);\n          Console.rawError(failure.details.messages.formatMessages() + \"\\n\");\n        }\n      } else {\n        Console.rawError(`  => Test threw exception: ${failure.stack}\\n`);\n      }\n\n      testList.notifyFailed(test, failure);\n    } else {\n      Console.error(`... ok (${test.durationMs} ms)`,\n        Console.options({ indent: 2 }));\n    }\n  }\n}\n\nimport { markThrowingMethods } from \"./test-utils.js\";\nmarkThrowingMethods(Run.prototype);\n"],"file":"tools/tool-testing/run.js.map"}