{"version":3,"sources":["/tools/meteor-services/auth-client.js"],"names":["auth","require","Console","ServiceConnection","httpHelpers","exports","AlreadyPrintedMessageError","openServiceConnection","serverUrl","headers","getUserAgent","_dontPrintErrors","handleConnectionError","error","label","errorType","errorMsg","message","warn","loggedInConnection","url","domain","sessionType","maybePrintRegistrationLink","onlyAllowIfRegistered","isLoggedIn","doUsernamePasswordLogin","retry","conn","accountsConfiguration","getAccountsConfiguration","loginWithTokenOrOAuth","err"],"mappings":"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","sourcesContent":["var auth = require('./auth.js');\nvar Console = require('../console/console.js').Console;\nvar ServiceConnection = require('./service-connection.js');\nvar httpHelpers = require('../utils/http-helpers.js');\n\nexports.AlreadyPrintedMessageError = function () {};\n\n// Opens a DDP connection to a package server. Loads the packages needed for a\n// DDP connection, then calls DDP connect to the package server URL in config,\n// using a current user-agent header composed by http-helpers.js.\nexports.openServiceConnection = function (serverUrl) {\n  return new ServiceConnection(\n    serverUrl,\n    {headers: {\"User-Agent\": httpHelpers.getUserAgent()},\n     _dontPrintErrors: true});\n};\n\n\n// Handle an error thrown on attempting to connect. Print a message if it is a\n// known error type, else throw the error.\n//\n// err: error\n// label: name of the service that we are trying to use (ex: \"package server\")\nexports.handleConnectionError = function (error, label) {\n  if (error instanceof exports.AlreadyPrintedMessageError) {\n    // do nothing\n  } else if (error.errorType === 'Meteor.Error') {\n    var errorMsg = \"Error from \" + label;\n    if (error.message) {\n      errorMsg += \": \" + error.message;\n    }\n    Console.warn(errorMsg);\n  } else if (error.errorType === \"DDP.ConnectionError\") {\n    Console.warn(\"Error connecting to \" + label + \": \"\n                 + error.message);\n  } else {\n    throw error;\n  }\n};\n\n// Returns a logged-in DDP connection to the given URL, or null if\n// we cannot log in. If an error unrelated to login occurs\n// (e.g. connection to package server times out), then it will be\n// thrown.\n//\n//  url: the url of the connection (ex: config.getPackageServerUrl)\n//  domain: the domain (ex: packages.meteor.com)\n//  sessionType: the name of the connection (ex: \"package-server\")\n//\nexports.loggedInConnection = function (url, domain, sessionType) {\n  // Make sure that we are logged in with Meteor Accounts so that we can\n  // do an OAuth flow.\n  if (auth.maybePrintRegistrationLink({onlyAllowIfRegistered: true})) {\n    // Oops, we're logged in but with a deferred-registration account.\n    // Message has already been printed.\n    throw new exports.AlreadyPrintedMessageError;\n  }\n\n  if (! auth.isLoggedIn()) {\n    // XXX we should have a better account signup page.\n    Console.error(\n      \"Please log in with your Meteor developer account.\",\n      \"If you don't have one,\",\n      \"you can quickly create one at www.meteor.com.\");\n    auth.doUsernamePasswordLogin({ retry: true });\n  }\n\n  var conn = exports.openServiceConnection(url);\n  var accountsConfiguration = auth.getAccountsConfiguration(conn);\n  try {\n    auth.loginWithTokenOrOAuth(\n      conn,\n      accountsConfiguration,\n      url,\n      domain,\n      sessionType\n    );\n  } catch (err) {\n    if (err.message === \"access-denied\") {\n      // Maybe we thought we were logged in, but our token had been\n      // revoked.\n      Console.error(\n        \"It looks like you have been logged out!\",\n        \"Please log in with your Meteor developer account. If you don't have\",\n        \"one, you can quickly create one at www.meteor.com.\");\n      auth.doUsernamePasswordLogin({ retry: true });\n      auth.loginWithTokenOrOAuth(\n        conn,\n        accountsConfiguration,\n        url,\n        domain,\n        sessionType\n      );\n    } else {\n      throw err;\n    }\n  }\n  return conn;\n};\n"],"file":"tools/meteor-services/auth-client.js.map"}