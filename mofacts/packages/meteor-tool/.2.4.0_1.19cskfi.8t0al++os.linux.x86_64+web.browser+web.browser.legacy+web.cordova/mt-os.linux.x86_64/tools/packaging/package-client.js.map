{"version":3,"sources":["/tools/packaging/package-client.js"],"names":["module1","export","bundleBuild","createAndPublishBuiltPackage","requestGarbageCollection","link","v","_","require","config","httpHelpers","release","files","utils","buildmessage","compiler","authClient","catalog","projectContextModule","colonConverter","Profile","openPackageServerConnection","packageServerUrl","serverUrl","getPackageServerUrl","openServiceConnection","generateBlankReadme","contents","excerpt","hash","blankHash","saveReadmeToTmp","readmeInfo","tempReadmeDir","mkdtemp","readmePath","pathJoin","writeFileAtomically","exports","callPackageServer","conn","connected","close","loggedInPackagesConnection","args","call","callPackageServerBM","assertInJob","apply","e","error","reason","message","loadRemotePackageData","syncToken","options","syncOpts","useShortPages","shortPagesForTest","compressCollections","updateServerPackageData","dataStore","enterJob","_updateServerPackageData","self","Error","done","ret","resetData","useProgressbar","start","undefined","state","current","end","reportProgress","getSomeData","getSyncToken","format","builds","versions","Date","now","compress","process","env","METEOR_CATALOG_COMPRESS_RPCS","remoteData","reset","collectionsCompressed","zlib","colsGzippedBuffer","Buffer","from","colsJSON","Promise","resolve","reject","gunzip","err","res","await","collections","JSON","parse","syncComplete","isEqual","upToDate","insertData","loggedInConnection","getPackageServerDomain","bundleSource","isopack","includeSources","packageDir","name","tempDir","packageTarName","version","dirToTar","convert","sourcePackageDir","mkdir_p","each","f","to","exists","copyFile","packageMapFilename","pluginProviderPackageMap","packageMapFile","PackageMapFile","filename","write","sourceTarball","createTarball","tarballHash","fileHash","treeHash","uploadFile","putUrl","filepath","size","stat","rs","createReadStream","getUrl","method","url","headers","bodyStream","bodyStreamLength","toString","isopackCache","tarballName","tarInputDir","saveToPath","includePreCompilerPluginIsopackVersions","buildTarball","ignore","relativePath","pieces","split","pathSep","length","last","includes","createBuiltPackage","bundleResult","jobHasMessages","publishBuiltPackage","uploadInfo","packageName","buildArchitectures","uploadUrl","uploadToken","handlePackageServerConnectionError","handleConnectionError","updatePackageMetadata","packageSource","connection","dataToUpdate","git","metadata","description","summary","longDescription","versionIdentifier","publishPackage","projectContext","new","existingVersion","validatePackageName","useBuildmessage","packRecord","official","getPackage","amIAuthorized","processReadme","packageDeps","getDependencyMetadata","refs","label","constraint","isCore","inCheckout","localCatalog","versionString","getLatestVersion","getIsopack","canWriteLegacyBuilds","has","references","arch","sourceFiles","getSourceFilesUnderSourceRoot","sourceRoot","testName","testIsopack","testSourceFiles","union","sourceBundleResult","existingRecord","getVersion","source","doNotPublishBuild","uploadRec","compilerVersion","BUILT_BY","containsPlugins","debugOnly","prodOnly","testOnly","deprecated","deprecatedMessage","getExports","releaseName","dependencies","readmeUrl","hashes","readmeHash","isRelease","methodName"],"mappings":"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","sourcesContent":["var _ = require('underscore');\n\nvar config = require('../meteor-services/config.js');\nvar httpHelpers = require('../utils/http-helpers.js');\nvar release = require('./release.js');\nvar files = require('../fs/files');\nvar utils = require('../utils/utils.js');\nvar buildmessage = require('../utils/buildmessage.js');\nvar compiler = require('../isobuild/compiler.js');\nvar authClient = require('../meteor-services/auth-client.js');\nvar catalog = require('./catalog/catalog.js');\nvar projectContextModule = require('../project-context.js');\nvar colonConverter = require('../utils/colon-converter.js');\nvar Profile = require('../tool-env/profile').Profile;\n\nimport { requestGarbageCollection } from \"../utils/gc.js\";\n\n// Opens a DDP connection to a package server. Loads the packages needed for a\n// DDP connection, then calls DDP connect to the package server URL in config,\n// using a current user-agent header composed by http-helpers.js.\nvar openPackageServerConnection = function (packageServerUrl) {\n  var serverUrl = packageServerUrl || config.getPackageServerUrl();\n  return authClient.openServiceConnection(serverUrl);\n};\n\n// We don't let the user upload a blank README for UX reasons, but we would\n// prefer that the server move to a world with 'readme' files for everything in\n// the future. As a way to breach these interfaces, for now, we are going to\n// upload blank documentation files when null docs are requested.\n//\n// This function generates a Readme object for a blank readme file, as well as\n// the file itself.\nvar generateBlankReadme = function () {\n  return {\n    contents: \"\",\n    excerpt: \"\",\n    hash: files.blankHash\n  };\n};\n\n// Save a readme file to a temporary path.\nvar saveReadmeToTmp = function (readmeInfo) {\n  var tempReadmeDir = files.mkdtemp('readme');\n  var readmePath = files.pathJoin(tempReadmeDir, \"Readme.md\");\n  files.writeFileAtomically(readmePath, readmeInfo.contents);\n  return readmePath;\n};\n\n// Given a connection, makes a call to the package server.  (Checks to see if\n// the connection is connected, and reconnects if needed -- a workaround for\n// the fact that connections in the tool do not reconnect)\nexports.callPackageServer = function (conn, ...args) {\n  // XXX This is broken since it doesn't actually replace the conn in the\n  // caller, so it'll happen on every subsequent call\n  if (!conn.connected) {\n    conn.close();\n    conn = exports.loggedInPackagesConnection();\n  }\n  return conn.call(...args);\n};\n\nvar callPackageServerBM = exports.callPackageServerBM = function (...args) {\n  buildmessage.assertInJob();\n  try {\n    return exports.callPackageServer.apply(null, args);\n  } catch (e) {\n    buildmessage.error(e.reason || e.message);\n    return null;\n  }\n};\n\n// Requests and returns one page of new package data that we haven't cached on\n// disk. We assume that data is cached chronologically, so essentially, we are\n// asking for a diff from the last time that we did this.\n// Takes in:\n// - conn: the connection to use (does not have to be logged in)\n// - syncToken: a syncToken object to be sent to the server that\n//   represents the last time that we talked to the server.\n// - options:\n//    - useShortPages (Boolean). Ask the server for pages of ~3 records\n//      instead of ~100, for testing pagination.\n//\n// Returns an object, containing the following fields:\n//  - syncToken: a new syncToken object, that we can pass to the server in the future.\n//  - collections: an object keyed by the name of server collections, with the\n//    records as an array of javascript objects.\nvar loadRemotePackageData = function (conn, syncToken, options) {\n  options = options || {};\n\n  // Did we get disconnected between retries somehow? Then we should open a new\n  // connection. We shouldn't use the callPackageServer method here though,\n  // since we don't need to authenticate.\n  if (!conn.connected) {\n    conn.close();\n    conn =  openPackageServerConnection();\n  }\n\n  var syncOpts = {};\n  if (options && options.useShortPages) {\n    syncOpts.shortPagesForTest = options.useShortPages;\n  }\n  if (options && options.compressCollections) {\n    syncOpts.compressCollections = options.compressCollections;\n  }\n  return conn.call('syncNewPackageData', syncToken, syncOpts);\n};\n\n// Contacts the package server to get the latest diff and writes changes to\n// disk.\n//\n// Takes in the dataStore, which is an example of the remote catalog. Contacts\n// the package server and updates the sql database with the most recent\n// information.\n//\n// Returns null if contacting the server times out, or an object with the\n// following keys:\n//     resetData : true if we should reset the database, otherwise false.\n//     connectionFailed: true if we failed to connect to the server.\n//\n// options can include:\n//  - packageStorageFile: String. The file to write the data to (overrides\n//    `config.getPackageStorage()`)\n//  - packageServerUrl: String. The package server (overrides\n//    `config.getPackageServerUrl()`)\n//  - useShortPages: Boolean. Request short pages of ~3 records from the\n//    server, instead of ~100 that it would send otherwise\nexports.updateServerPackageData = function (dataStore, options) {\n  return buildmessage.enterJob('updating package catalog', function () {\n    return _updateServerPackageData(dataStore, options);\n  });\n};\n\nvar _updateServerPackageData = function (dataStore, options) {\n  var self = this;\n  options = options || {};\n  if (dataStore === null) {\n    throw Error(\"Data store expected\");\n  }\n\n  var done = false;\n  var ret = {resetData: false};\n\n  // For now, we don't have a great progress metric, so just use a spinner\n  var useProgressbar = false;\n\n  var start = undefined;\n  // Guess that we're about an hour behind, as an opening guess\n  var state = { current: 0, end: 60 * 60 * 1000, done: false};\n  useProgressbar && buildmessage.reportProgress(state);\n\n  var conn = openPackageServerConnection(options.packageServerUrl);\n\n  // Provide some progress indication for connection\n  // XXX though it is just a hack\n  state.current = 1;\n  useProgressbar && buildmessage.reportProgress(state);\n\n  var getSomeData = function () {\n    var syncToken = dataStore.getSyncToken() || {format: \"1.1\"};\n\n    if (!start) {\n      start = {};\n      start.builds = syncToken.builds;\n      start.versions = syncToken.versions;\n      state.end = (Date.now() - start.builds) + (Date.now() - start.versions);\n    }\n    // XXX: This is a hack... syncToken should have a % done\n    state.current =\n      (syncToken.builds - start.builds) +\n      (syncToken.versions - start.versions);\n    useProgressbar && buildmessage.reportProgress(state);\n\n    var compress = !!process.env.METEOR_CATALOG_COMPRESS_RPCS;\n\n    // (loadRemotePackageData may throw)\n    var remoteData = loadRemotePackageData(conn, syncToken, {\n      useShortPages: options.useShortPages,\n      compressCollections: compress\n    });\n\n    // Is the remote server telling us to ignore everything we've heard before?\n    // OK, we can do that.\n    if (remoteData.resetData) {\n      dataStore.reset();\n      // The caller may want to take this as a cue to delete packages from the\n      // tropohouse.\n      ret.resetData = true;\n    }\n\n    if (remoteData.collectionsCompressed) {\n      var zlib = require('zlib');\n      var colsGzippedBuffer = Buffer.from(\n        remoteData.collectionsCompressed, 'base64');\n      var colsJSON = new Promise((resolve, reject) => {\n        zlib.gunzip(colsGzippedBuffer, (err, res) => {\n          err ? reject(err) : resolve(res);\n        });\n      }).await();\n      remoteData.collections = JSON.parse(colsJSON);\n      delete remoteData.collectionsCompressed;\n    }\n\n    // We always write to the data store; the fact there is no data is itself\n    // data!  e.g. the last-refresh timestamp\n    var syncComplete =\n          _.isEqual(remoteData.collections, {}) || remoteData.upToDate;\n    dataStore.insertData(remoteData, syncComplete);\n\n    // If there is no new data from the server, don't bother writing things to\n    // disk (unless we were just told to reset everything).\n    if (!remoteData.resetData && _.isEqual(remoteData.collections, {})) {\n      done = true;\n      return;\n    }\n\n    if (remoteData.upToDate) {\n      done = true;\n    }\n  };\n\n  try {\n    while (!done) {\n      getSomeData();\n      requestGarbageCollection();\n    }\n  } finally {\n    conn.close();\n  }\n\n  return ret;\n};\n\n_updateServerPackageData = Profile('package-client _updateServerPackageData',\n                                   _updateServerPackageData);\n\n// Returns a logged-in DDP connection to the package server, or null if\n// we cannot log in. If an error unrelated to login occurs\n// (e.g. connection to package server times out), then it will be\n// thrown.\nexports.loggedInPackagesConnection = function () {\n  return authClient.loggedInConnection(\n    config.getPackageServerUrl(),\n    config.getPackageServerDomain(),\n    \"package-server\"\n  );\n};\n\n// XXX this is missing a few things. In retrospect a better approach here might\n//     be to actually make \"save source somewhere else\" or perhaps \"add source\n//     to tarball\" be part of the package build itself...\nvar bundleSource = function (isopack, includeSources, packageDir) {\n  buildmessage.assertInJob();\n\n  var name = isopack.name;\n\n  var tempDir = files.mkdtemp('build-source-package-');\n  var packageTarName = name + '-' + isopack.version + '-source';\n  var dirToTar = files.pathJoin(tempDir, 'source',\n    colonConverter.convert(packageTarName));\n  // XXX name probably needs to be escaped for windows?\n  // XXX note that publish-for-arch thinks it knows how this tarball is laid\n  //     out, which is a bit of a shame\n  var sourcePackageDir = files.pathJoin(dirToTar, colonConverter.convert(name));\n  if (! files.mkdir_p(sourcePackageDir)) {\n    buildmessage.error('Failed to create temporary source directory: ' +\n                       sourcePackageDir);\n    return null;\n  }\n\n  // We copy source files into a temp directory and then tar up the temp\n  // directory. It would be great if we could avoid the copy, but as far\n  // as we can tell, this is the only way to get a tarball with the\n  // directory structure that we want (<package name>-<version-source/\n  // at the top level).\n  _.each(includeSources, function (f) {\n    const from = files.pathJoin(packageDir, f);\n    const to = files.pathJoin(sourcePackageDir, f);\n    if (files.exists(from)) {\n      files.copyFile(from, to);\n    }\n  });\n\n  // Write a package map to `.versions` inside the source tarball.  Note that\n  // this differs in two ways from the `.versions` file that is maintained\n  // inside standalone packages by 'meteor publish':\n  //  (a) It only contains the direct, directly implied, and linked-into-plugin\n  //      dependencies of the package, not all transitive dependencies.\n  //  (b) It is ALWAYS put into the source tarball, even if the package came\n  //      from inside an app, whereas the package-source-tree .versions file\n  //      is only used for standalone packages\n  var packageMapFilename = files.pathJoin(sourcePackageDir, '.versions');\n  if (files.exists(packageMapFilename)) {\n    throw Error(\".versions file already exists? \" + packageMapFilename);\n  }\n  var pluginProviderPackageMap = isopack.pluginProviderPackageMap;\n  if (! pluginProviderPackageMap) {\n    throw Error(\"no pluginProviderPackageMap on isopack?\");\n  }\n  var packageMapFile = new projectContextModule.PackageMapFile({\n    filename: packageMapFilename\n  });\n  packageMapFile.write(pluginProviderPackageMap);\n\n  // We put this inside the temp dir because mkdtemp makes sure that the\n  // temp dir gets cleaned up on process exit, so we don't have to worry\n  // about cleaning up our tarball (or our copied source files)\n  // ourselves.\n  var sourceTarball = files.pathJoin(tempDir, packageTarName + '.tgz');\n  files.createTarball(dirToTar, sourceTarball);\n\n  var tarballHash = files.fileHash(sourceTarball);\n  var treeHash = files.treeHash(dirToTar);\n\n  return {\n    sourceTarball: sourceTarball,\n    tarballHash: tarballHash,\n    treeHash: treeHash\n  };\n};\n\n// Uploads a file at a filepath to the HTTP put URL.\n//\n// Returns true on success and false on failure.\nvar uploadFile = function (putUrl, filepath) {\n  buildmessage.assertInJob();\n  var size = files.stat(filepath).size;\n  var rs = files.createReadStream(filepath);\n  try {\n    // Use getUrl instead of request, to throw on 4xx/5xx.\n    httpHelpers.getUrl({\n      method: 'PUT',\n      url: putUrl,\n      headers: {\n        'content-length': size,\n        'content-type': 'application/octet-stream',\n        'x-amz-acl': 'public-read'\n      },\n      bodyStream: rs,\n      bodyStreamLength: size\n    });\n  } catch (err) {\n    // XXX: getUrl's error handling is terrible and we should fix it there.\n    buildmessage.error(typeof err === \"string\" ? err : err.error.toString());\n    return false;\n  } finally {\n    rs.close();\n  }\n  return true;\n};\n\nexports.uploadFile = uploadFile;\n\nexport function bundleBuild(isopack, isopackCache) {\n  buildmessage.assertInJob();\n\n  var tempDir = files.mkdtemp('bp-');\n  var packageTarName = isopack.tarballName();\n  var tarInputDir = files.pathJoin(tempDir, packageTarName);\n\n  // Note that we do need to do this even though we already have the isopack on\n  // disk in an IsopackCache, because we don't want to include\n  // isopack-buildinfo.json. (We don't include it because we're not passing\n  // includeIsopackBuildInfo to saveToPath here.)\n  isopack.saveToPath(tarInputDir, {\n    // When publishing packages that don't use new registerCompiler plugins,\n    // make sure that old Meteors can use it too\n    includePreCompilerPluginIsopackVersions: true,\n    isopackCache,\n  });\n\n  var buildTarball = files.pathJoin(tempDir, packageTarName + '.tgz');\n\n  files.createTarball(tarInputDir, buildTarball);\n\n  var tarballHash = files.fileHash(buildTarball);\n  var treeHash = files.treeHash(tarInputDir, {\n    // We don't include any package.json from an npm module in the tree hash,\n    // because npm isn't super consistent about what it puts in there (eg, does\n    // it include the \"readme\" field)? This ends up leading to spurious\n    // differences. The tree hash will still notice any actual CODE changes in\n    // the npm packages.\n    ignore: function (relativePath) {\n      var pieces = relativePath.split(files.pathSep);\n      return pieces.length && _.last(pieces) === 'package.json'\n        && pieces.includes('npm');\n    }\n  });\n\n  return {\n    buildTarball: buildTarball,\n    tarballHash: tarballHash,\n    treeHash: treeHash\n  };\n}\n\nfunction createBuiltPackage(isopack, isopackCache) {\n  buildmessage.assertInJob();\n  var name = isopack.name;\n\n  // Note: we really want to do this before createPackageBuild, because the URL\n  // we get from createPackageBuild will expire!\n  var bundleResult;\n  buildmessage.enterJob(\"bundling build for \" + name, function () {\n    bundleResult = bundleBuild(isopack, isopackCache);\n  });\n  if (buildmessage.jobHasMessages()) {\n    return;\n  }\n\n  return bundleResult;\n}\n\nvar publishBuiltPackage = function (conn, isopack, bundleResult) {\n  buildmessage.assertInJob();\n  var name = isopack.name;\n\n  var uploadInfo;\n  buildmessage.enterJob('creating package build for ' + name, function () {\n    uploadInfo = callPackageServerBM(conn, 'createPackageBuild', {\n      packageName: isopack.name,\n      version: isopack.version,\n      buildArchitectures: isopack.buildArchitectures()\n    });\n  });\n  if (buildmessage.jobHasMessages()) {\n    return;\n  }\n\n  buildmessage.enterJob(\"uploading build\", function () {\n    uploadFile(uploadInfo.uploadUrl,\n               bundleResult.buildTarball);\n  });\n  if (buildmessage.jobHasMessages()) {\n    return;\n  }\n\n  buildmessage.enterJob('publishing package build for ' + name, function () {\n    callPackageServerBM(conn, 'publishPackageBuild',\n                        uploadInfo.uploadToken,\n                        bundleResult.tarballHash,\n                        bundleResult.treeHash);\n  });\n  if (buildmessage.jobHasMessages()) {\n    return;\n  }\n};\n\nexport function createAndPublishBuiltPackage(conn, isopack, isopackCache) {\n  publishBuiltPackage(\n    conn,\n    isopack,\n    createBuiltPackage(isopack, isopackCache),\n  );\n}\n\n// Handle an error thrown on trying to connect to the package server.\nexports.handlePackageServerConnectionError = function (error) {\n  authClient.handleConnectionError(error, \"package server\");\n};\n\n\n// Update the package metdata in the server catalog. Chane the docs,\n// descriptions and the Git URL to new values.\n//\n// options:\n// - packageSource: the packageSource for this package.\n// - readmeInfo: null, or an object containing docs information for this package.\n// - connection: the open, logged-in connection over which we should talk to the\n//   package server. DO NOT CLOSE this connection here.\n//\n// Return true on success and an error code otherwise.\nexports.updatePackageMetadata = function (options) {\n  buildmessage.assertInJob();\n\n  var packageSource = options.packageSource;\n  var conn = options.connection;\n  var readmeInfo = options.readmeInfo;\n\n  var name = packageSource.name;\n  var version = packageSource.version;\n\n  if (! version) {\n    buildmessage.error(\n      \"Package cannot be updated because it doesn't have a version\");\n    return;\n  }\n\n  // For now, documentation is optional on the client, so we have to give people\n  // a way to remove it with 'documentation: null'.\n  if (! readmeInfo) {\n    readmeInfo = generateBlankReadme();\n  }\n\n  var dataToUpdate = {\n    git: packageSource.metadata.git || \"\",\n    description: packageSource.metadata.summary,\n    longDescription: readmeInfo.excerpt\n  };\n\n  // Check that the metadata fits under the established limits, and give helpful\n  // feedback.\n  if (! dataToUpdate[\"description\"]) {\n    buildmessage.error(\"Please provide a short description to use in 'meteor search'\");\n    return;\n  }\n\n  if (dataToUpdate[\"description\"] &&\n      dataToUpdate[\"description\"].length > 100) {\n    buildmessage.error(\"Summary must be under 100 chars.\");\n    return;\n  }\n\n  if (dataToUpdate[\"longDescription\"].length > 1500) {\n    buildmessage.error(\n      \"Longform package description is too long. Meteor uses the section of \" +\n      \"the Markdown documentation file between the first and second \" +\n      \"headings. That section must be less than 1500 characters long.\");\n    return;\n  }\n\n  // Update the general metadata.\n  var versionIdentifier = { packageName: name, version: version };\n  buildmessage.enterJob('updating metadata', function () {\n    callPackageServerBM(\n      conn, \"changeVersionMetadata\", versionIdentifier, dataToUpdate);\n  });\n  if (buildmessage.jobHasMessages()) {\n    return;\n  }\n\n  // Upload the new Readme.\n  buildmessage.enterJob('uploading documentation', function () {\n    var readmePath = saveReadmeToTmp(readmeInfo);\n    var uploadInfo =\n          callPackageServerBM(conn, \"createReadme\", versionIdentifier);\n    if (! uploadInfo) {\n      return;\n    }\n    if (! uploadFile(uploadInfo.url, readmePath)) {\n      return;\n    }\n    callPackageServerBM(\n      conn, \"publishReadme\", uploadInfo.uploadToken, { hash: readmeInfo.hash });\n  });\n  if (buildmessage.jobHasMessages()) {\n    return;\n  }\n\n\n};\n\n// Publish the package information into the server catalog. Create new records\n// for the package (if needed), the version and the build; upload source and\n// isopack.\n//\n// options:\n// - packageSource: the packageSource for this package.\n// - connection: the open, logged-in connection over which we should talk to the\n//   package server. DO NOT CLOSE this connection here.\n// - projectContext: the (probably temporary) ProjectContext to use. Must have\\\n//   already built local packages\n// - new: this package is new, we should call createPackage to create a new\n//   package record.\n// - existingVersion: we expect the version to exist already, and for us\n//   to merely be providing a new build of the same source\n// - doNotPublishBuild: do not publish the build of this package.\n//\n// Return true on success and an error code otherwise.\nexports.publishPackage = function (options) {\n  buildmessage.assertInJob();\n  var packageSource = options.packageSource;\n  var conn = options.connection;\n  var projectContext = options.projectContext;\n\n  var name = packageSource.name;\n  var version = packageSource.version;\n\n  if (options.new && options.existingVersion) {\n    throw Error(\"is it new or does it exist?!?\");\n  }\n\n  // Check that the package name is valid.\n  utils.validatePackageName(name, { useBuildmessage: true });\n  if (buildmessage.jobHasMessages()) {\n    return;\n  }\n\n  // Check that we have a version.\n  if (! version) {\n    buildmessage.error(\n      \"Package cannot be published because it doesn't have a version\");\n    return;\n  }\n\n  // Check that the version description is under the character limit. (We check\n  // all string limits on the server, but this is the one that is mostly likely\n  // to be wrong)\n  if (! packageSource.metadata.summary) {\n    buildmessage.error(\n      \"Please describe what your package does. Set a summary \" +\n        \"in Package.describe in package.js.\");\n    return;\n  }\n\n  if (packageSource.metadata.summary.length > 100) {\n    buildmessage.error(\"Summary must be under 100 chars.\");\n    return;\n  }\n\n  // Check that we are an authorized maintainer of this package.\n  if (!options['new']) {\n    var packRecord = catalog.official.getPackage(name);\n    if (! packRecord) {\n      buildmessage.error(\n        'There is no package named ' + name +\n          '. If you are creating a new package, use the --create flag.');\n      return;\n    }\n\n    if (!exports.amIAuthorized(name, conn, false)) {\n      buildmessage.error(\n        'You are not an authorized maintainer of ' + name + '.  Only ' +\n          'authorized maintainers may publish new versions.');\n    }\n  }\n\n  // Check that our documentation exists (or we know that it doesn't) and has\n  // been filled out.\n  var readmeInfo = buildmessage.enterJob(\n    \"processing documentation\",\n    function () {\n      return packageSource.processReadme();\n  });\n  if (buildmessage.jobHasMessages()) {\n    return;\n  }\n  if (readmeInfo && (readmeInfo.hash === files.blankHash)) {\n    buildmessage.error(\n      \"Your documentation file is blank, so users may have trouble figuring \" +\n      \"out how to use your package. Please fill it out, or \" +\n      \"set 'documentation: null' in your Package.describe\");\n    return;\n  }\n\n  if (readmeInfo && readmeInfo.excerpt.length > 1500) {\n    buildmessage.error(\n      \"Longform package description is too long. Meteor uses the section of \" +\n      \"the Markdown documentation file between the first and second \" +\n      \"headings. That section must be less than 1500 characters long.\");\n    return;\n  }\n\n  // We don't let the user upload a blank README for UX reasons, but we would\n  // prefer that the server move to a world with 'readme' files for everything\n  // in the future. This helps unite these interfaces, and makes our code easier\n  // to reason about in the future.\n  if (! readmeInfo) {\n    readmeInfo = generateBlankReadme();\n  }\n  var readmePath = saveReadmeToTmp(readmeInfo);\n\n  var packageDeps = packageSource.getDependencyMetadata();\n\n  // Check that the package does not have any unconstrained references.\n  _.each(packageDeps, function(refs, label) {\n    if (refs.constraint == null) {\n      if (packageSource.isCore && files.inCheckout() &&\n          projectContext.localCatalog.getPackage(label)) {\n        // Core package is using or implying another core package,\n        // without a version number.  We fill in the version number.\n        // (Well, we're assuming that the other package is core and\n        // not some other sort of local package.)\n        var versionString =\n              projectContext.localCatalog.getLatestVersion(label).version;\n        // modify the constraint on this dep that will be sent to troposphere\n        refs.constraint = versionString;\n      } else if (label === \"meteor\") {\n        // HACK: We are willing to publish a package with a \"null\"\n        // constraint on the \"meteor\" package to troposphere.  This\n        // happens for non-core packages when not running from a\n        // checkout, because all packages implicitly depend on the\n        // \"meteor\" package, but do not necessarily specify an\n        // explicit version for it, and we don't have a great way to\n        // choose one here.\n        // XXX come back to this, especially if we are incrementing the\n        // major version of \"meteor\".  hopefully we will have more data\n        // about the package system by then.\n      } else {\n        buildmessage.error(\n          \"You must specify a version constraint for package \" + label);\n      }\n    }\n  });\n  if (buildmessage.jobHasMessages()) {\n    return;\n  }\n\n  var isopack = projectContext.isopackCache.getIsopack(name);\n  if (! isopack) {\n    throw Error(\"no isopack \" + name);\n  }\n\n  // If we aren't able to include legacy builds in this version, make sure that\n  // it has a fake dependency on isobuild:isopack-2 so that old versions of\n  // Isobuild won't accidentally use it.\n  if (!isopack.canWriteLegacyBuilds()\n      && !_.has(packageDeps, 'isobuild:isopack-2')) {\n    packageDeps['isobuild:isopack-2'] = {\n      constraint: '1.0.0',\n      // Arbitrary arch here; nothing other than meteor show really pays\n      // attention to reference arch anymore, because we no longer pay attention\n      // to the arch with the constraint in Version Solver.\n      references: [{arch: 'os'}],\n    };\n  }\n\n  var sourceFiles = isopack.getSourceFilesUnderSourceRoot(\n    packageSource.sourceRoot);\n  if (! sourceFiles) {\n    throw Error(\"isopack doesn't know what its source files are?\");\n  }\n\n  // We need to have built the test package to get all of its sources, even\n  // though we're not publishing a BUILD for the test package.\n  if (packageSource.testName) {\n    var testIsopack = projectContext.isopackCache.getIsopack(\n      packageSource.testName);\n    if (! testIsopack) {\n      throw Error(\"no testIsopack \" + packageSource.testName);\n    }\n    var testSourceFiles = testIsopack.getSourceFilesUnderSourceRoot(\n      packageSource.sourceRoot);\n    if (! testSourceFiles) {\n      throw Error(\"test isopack doesn't know what its source files are?\");\n    }\n    sourceFiles = _.union(sourceFiles, testSourceFiles);\n  }\n\n  var sourceBundleResult;\n  buildmessage.enterJob(\"bundling source for \" + name, function () {\n    sourceBundleResult = bundleSource(\n      isopack, sourceFiles, packageSource.sourceRoot);\n  });\n  if (buildmessage.jobHasMessages()) {\n    return;\n  }\n\n  // Create the package. Check that the metadata exists.\n  if (options.new) {\n    buildmessage.enterJob(\"creating package \" + name, function () {\n      callPackageServerBM(conn, 'createPackage', {\n        name: packageSource.name\n      });\n    });\n    if (buildmessage.jobHasMessages()) {\n      return;\n    }\n  }\n\n  if (options.existingVersion) {\n    var existingRecord = catalog.official.getVersion(name, version);\n    if (! existingRecord) {\n      buildmessage.error(\"Version does not exist.\");\n      return;\n    }\n    if (existingRecord.source.treeHash !== sourceBundleResult.treeHash) {\n      buildmessage.error(\"Package source differs from the existing version.\");\n      return;\n    }\n\n    if (! options.doNotPublishBuild) {\n      createAndPublishBuiltPackage(\n        conn, isopack, projectContext.isopackCache);\n\n      if (buildmessage.jobHasMessages()) {\n        return;\n      }\n    }\n\n    // XXX check that we're actually providing something new?\n  } else {\n    var uploadInfo;\n    buildmessage.enterJob(\"pre-publishing package \" + name, function () {\n      var uploadRec = {\n        packageName: packageSource.name,\n        version: version,\n        description: packageSource.metadata.summary,\n        longDescription: readmeInfo.excerpt,\n        git: packageSource.metadata.git,\n        compilerVersion: compiler.BUILT_BY,\n        containsPlugins: packageSource.containsPlugins(),\n        debugOnly: packageSource.debugOnly,\n        prodOnly: packageSource.prodOnly,\n        testOnly: packageSource.testOnly,\n\n        deprecated: packageSource.deprecated,\n        deprecatedMessage: packageSource.deprecatedMessage,\n\n        exports: packageSource.getExports(),\n        releaseName: release.current.name,\n        dependencies: packageDeps\n      };\n      uploadInfo = callPackageServerBM(conn, 'createPackageVersion', uploadRec);\n    });\n    if (buildmessage.jobHasMessages()) {\n      return;\n    }\n\n    // XXX If package version already exists, print a nice error message\n    // telling them to try 'meteor publish-for-arch' if they want to\n    // publish a new build.\n\n    // Documentation is smaller than the source. Upload it first, to minimize\n    // the chances of PUT URLs expiring. (XXX: in the far future, parallelize this)\n    buildmessage.enterJob(\"uploading documentation\", function () {\n      uploadFile(uploadInfo.readmeUrl, readmePath);\n    });\n    if (buildmessage.jobHasMessages()) {\n      return;\n    }\n\n    buildmessage.enterJob(\"uploading source\", function () {\n      uploadFile(uploadInfo.uploadUrl, sourceBundleResult.sourceTarball);\n    });\n    if (buildmessage.jobHasMessages()) {\n      return;\n    }\n\n    if (! options.doNotPublishBuild) {\n      var bundleResult = createBuiltPackage(\n        isopack,\n        projectContext.isopackCache,\n      );\n\n      if (buildmessage.jobHasMessages()) {\n        return;\n      }\n    }\n\n    var hashes = {\n      tarballHash: sourceBundleResult.tarballHash,\n      treeHash: sourceBundleResult.treeHash,\n      readmeHash: readmeInfo.hash\n    };\n    buildmessage.enterJob(\"publishing package version\", function () {\n      callPackageServerBM(\n        conn, 'publishPackageVersion', uploadInfo.uploadToken, hashes);\n    });\n    if (buildmessage.jobHasMessages()) {\n      return;\n    }\n\n    if (! options.doNotPublishBuild) {\n      publishBuiltPackage(conn, isopack, bundleResult);\n      if (buildmessage.jobHasMessages()) {\n        return;\n      }\n    }\n  }\n\n  return;\n};\n\n  // Call the server to ask if we are authorized to update this release or\n// package. This is a way to save time before sending data to the server. It\n// will mostly ignore most errors (just in case we have a flaky network connection or\n// something) and let the method deal with those.\n//\n// If this returns FALSE, then we are NOT authorized.\n// Otherwise, return true.\nexports.amIAuthorized = function (name, conn, isRelease) {\n  var methodName = \"amIAuthorized\" +\n    (isRelease ? \"Release\" : \"Package\");\n\n  try {\n    exports.callPackageServer(conn, methodName, name);\n  } catch (err) {\n    if (err.error === 401) {\n      return false;\n    }\n\n    // We don't know what this error is. Probably we can't contact the server,\n    // or the like. It would be a pity to fail all operations with the server\n    // just because a preliminary check fails, so return true for now.\n    return true;\n  }\n  return true;\n};\n"],"file":"tools/packaging/package-client.js.map"}