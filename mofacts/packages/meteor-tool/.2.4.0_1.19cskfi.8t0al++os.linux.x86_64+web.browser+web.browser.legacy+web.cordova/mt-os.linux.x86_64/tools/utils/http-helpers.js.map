{"version":3,"sources":["/tools/utils/http-helpers.js"],"names":["_objectSpread","module","link","default","v","Writable","os","require","util","_","files","auth","config","release","Console","timeoutScaleFactor","ConcatStream","constructor","chunks","size","_write","chunk","encoding","next","push","length","getBuffer","Buffer","concat","end","force","WritableWithProgress","writable","listener","self","_inner","_listener","Object","assign","prototype","write","callback","_progress","n","done","state","_state","current","progress","reportProgress","on","name","once","arguments","emit","getUserAgent","version","isCheckout","inCheckout","getToolsVersion","format","platform","type","arch","httpHelpers","exports","request","urlOrOptions","options","isObject","url","clone","outputStream","has","bodyStream","bodyStreamLength","responseLength","Error","headers","forceSSL","process","env","CAFILE","ca","readFile","followRedirect","useSessionHeader","useAuthHeader","sessionHeader","getSessionId","getAccountsDomain","authHeader","getSessionToken","promise","Promise","resolve","reject","err","response","body","setCookie","each","h","match","setSessionId","proxy","HTTP_PROXY","http_proxy","test","HTTPS_PROXY","https_proxy","timeout","onRequest","debug","method","req","error","isBuffer","contentLength","Number","actualLength","byteLength","call","isFunction","totalProgress","dest","pipe","_addProgressEvents","await","reportProgressDone","emitProgress","undefined","data","getUrl","result","e","OfflineError","href","statusCode","getUrlWithResuming","maxAttempts","retryDelaySecs","masterProgress","attempt","triesRemaining","startAt","Range","addChildTask","title","useTry","change","setTimeout","then"],"mappings":"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","sourcesContent":["///\n/// utility functions for dealing with urls and http\n///\n\nvar os = require('os');\nvar util = require('util');\n\nvar _ = require('underscore');\n\nvar files = require('../fs/files');\nvar auth = require('../meteor-services/auth.js');\nvar config = require('../meteor-services/config.js');\nvar release = require('../packaging/release.js');\nvar Console = require('../console/console.js').Console;\nvar timeoutScaleFactor = require('./utils.js').timeoutScaleFactor;\n\nimport { Writable } from \"stream\";\n\nclass ConcatStream extends Writable {\n  constructor() {\n    super();\n    this.chunks = [];\n    this.size = 0;\n  }\n\n  _write(chunk, encoding, next) {\n    this.chunks.push(chunk);\n    this.size += chunk.length;\n    next();\n  }\n\n  getBuffer() {\n    if (this.chunks.length !== 1) {\n      this.chunks[0] = Buffer.concat(this.chunks);\n      this.chunks.length = 1;\n    }\n\n    return this.chunks[0];\n  }\n\n  end(force = false) {\n    // Override the Writable#end method to ignore any .end() calls for\n    // this stream, since we likely want to resume the download later.\n    if (force === true) {\n      super.end();\n    }\n  }\n}\n\n// Helper that tracks bytes written to a writable\nvar WritableWithProgress = function (writable, listener) {\n  var self = this;\n  self._inner = writable;\n  self._listener = listener;\n};\n\nObject.assign(WritableWithProgress.prototype, {\n  write: function (chunk, encoding, callback) {\n    var self = this;\n    self._listener(chunk.length, false);\n    return self._inner.write(chunk, encoding);\n  },\n\n  end: function (chunk, encoding, callback) {\n    var self = this;\n    self._listener(chunk ? chunk.length : 0, true);\n    return self._inner.end(chunk, encoding);\n  },\n\n  _progress: function (n, done) {\n    var self = this;\n\n    var state = self._state;\n    state.current += n;\n    if (done) {\n      state.current.done = true;\n    }\n    self.progress.reportProgress(state);\n  },\n\n  on: function (name, callback) {\n    return this._inner.on(name, callback);\n  },\n\n  once: function () {\n    return this._inner.once(...arguments);\n  },\n\n  emit: function () {\n    return this._inner.emit(...arguments);\n  }\n});\n\n\n// Compose a User-Agent header.\nvar getUserAgent = function () {\n  var version;\n\n  if (release.current) {\n    version = release.current.isCheckout() ? 'checkout' : release.current.name;\n  } else {\n    // This happens when we haven't finished starting up yet (say, the\n    // user passed --release 1.2.3 and we have to download 1.2.3\n    // before we can get going), or if we are using an installed copy\n    // of Meteor to 'meteor update'ing a project that was created by a\n    // checkout and doesn't have a version yet.\n    version = files.inCheckout() ? 'checkout' : files.getToolsVersion();\n  }\n\n  return util.format('Meteor/%s OS/%s (%s; %s; %s;)', version,\n                     os.platform(), os.type(), os.release(), os.arch());\n};\n\n\nvar httpHelpers = exports;\nObject.assign(exports, {\n  getUserAgent: getUserAgent,\n\n  // A wrapper around request with the following improvements:\n  //\n  // - It will respect proxy environment variables if present\n  //   (HTTP_PROXY or HTTPS_PROXY as appropriate).\n  //\n  // - It will set a reasonable User-Agent header.\n  //\n  // - If you omit the callback it will run synchronously. The return\n  //   value will be an object with keys 'response' and 'body' (with\n  //   the same meaning as the arguments to request's normal\n  //   callback), or it will throw.\n  //\n  // - If Set-Cookie headers are present on the response, *and* you\n  //   are using a callback, it will parse the cookies and include\n  //   them as a setCookie attribute on the object passed to the\n  //   callback. setCookie is a simple map from cookie name to cookie\n  //   value. If you want expiration time and attributes you'll have\n  //   to parse it yourself. If there are multiple Set-Cookie headers\n  //   for the same cookie it is unspecified which one you'll get.\n  //\n  // - You can provide a 'bodyStream' option which is a stream that\n  //   will be used for the body of the request.\n  //\n  // - For authenticated Meteor Software services, you can set the\n  //   'useSessionHeader' and/or 'useAuthHeader' options (to true) to\n  //   send X-Meteor-Session/X-Meteor-Auth headers using values from\n  //   the session file.\n  //\n  // - forceSSL is always set to true. Always. And followRedirect is\n  //   set to false since it doesn't understand origins (see comment\n  //   in implementation).\n  //\n  // - An optional options.onRequest callback may be provided if the\n  //   caller desires access to the request object.\n  //\n  // NB: With useSessionHeader and useAuthHeader, this function will\n  // read *and possibly write to* the session file, so if you are\n  // writing auth code (in auth.js) and you call it, be sure to reread\n  // the session file afterwards.\n  request: function (urlOrOptions, callback) {\n    var options;\n    if (!_.isObject(urlOrOptions)) {\n      options = { url: urlOrOptions };\n    } else {\n      options = _.clone(urlOrOptions);\n    }\n\n    var outputStream;\n    if (_.has(options, 'outputStream')) {\n      outputStream = options.outputStream;\n      delete options.outputStream;\n    }\n\n    var bodyStream;\n    if (_.has(options, 'bodyStream')) {\n      bodyStream = options.bodyStream;\n      delete options.bodyStream;\n    }\n\n    // Body stream length for progress\n    var bodyStreamLength = 0;\n    if (_.has(options, 'bodyStreamLength')) {\n      bodyStreamLength = options.bodyStreamLength;\n      delete options.bodyStreamLength;\n    } else {\n      // Guess the body stream length as 1MB\n      // Hopefully if it's much bigger the caller will set it\n      // If it is much small, we will pleasantly surprise the user!\n      if (bodyStream) {\n        bodyStreamLength = 1024 * 1024;\n      }\n    }\n\n    // Response length for progress\n    var responseLength = 128 * 1024;\n    if (_.has(options, 'responseLength')) {\n      responseLength = options.responseLength;\n      delete options.responseLength;\n    }\n\n    var progress = null;\n    if (_.has(options, 'progress')) {\n      progress = options.progress;\n      delete options.progress;\n\n      if (callback) {\n        throw new Error(\"Not safe to use progress with callback\");\n      }\n    }\n\n    options.headers = Object.assign({\n      'User-Agent': getUserAgent()\n    }, options.headers || {});\n\n    // This should never, ever be false, or else why are you using SSL?\n    options.forceSSL = true;\n    if (process.env.CAFILE) {\n      options.ca = files.readFile(process.env.CAFILE);\n    }\n\n    // followRedirect is very dangerous because request does not\n    // appear to segregate cookies by origin, so any cookies (and\n    // apparently headers as well, eg X-Meteor-Auth) sent on the\n    // original request could get forwarded to an unexpected domain in\n    // a redirect. This is almost certainly not something you ever\n    // want.\n    options.followRedirect = false;\n\n    var useSessionHeader = options.useSessionHeader;\n    delete options.useSessionHeader;\n    var useAuthHeader = options.useAuthHeader;\n    delete options.useAuthHeader;\n    if (useSessionHeader || useAuthHeader) {\n      var sessionHeader = auth.getSessionId(config.getAccountsDomain());\n      if (sessionHeader) {\n        options.headers['X-Meteor-Session'] = sessionHeader;\n      }\n      if (callback) {\n        throw new Error(\"session header can't be used with callback\");\n      }\n    }\n    if (useAuthHeader) {\n      var authHeader = auth.getSessionToken(config.getAccountsDomain());\n      if (authHeader) {\n        options.headers['X-Meteor-Auth'] = authHeader;\n      }\n    }\n\n    var promise;\n    if (! callback) {\n      promise = new Promise(function (resolve, reject) {\n        callback = function (err, response, body) {\n          if (err) {\n            reject(err);\n            return;\n          }\n\n          var setCookie = {};\n          _.each(response.headers[\"set-cookie\"] || [], function (h) {\n            var match = h.match(/^([^=\\s]+)=([^;\\s]+)/);\n            if (match) {\n              setCookie[match[1]] = match[2];\n            }\n          });\n\n          if (useSessionHeader && _.has(response.headers, \"x-meteor-session\")) {\n            auth.setSessionId(config.getAccountsDomain(),\n                              response.headers['x-meteor-session']);\n          }\n\n          resolve({\n            response: response,\n            body: body,\n            setCookie: setCookie\n          });\n        };\n      });\n    }\n\n    // try to get proxy from environment.\n    // similar code is in packages/ddp/stream_client_nodejs.js\n    var proxy = process.env.HTTP_PROXY || process.env.http_proxy || null;\n    // if we're going to an https url, try the https_proxy env variable first.\n    if (/^https/i.test(options.url)) {\n      proxy = process.env.HTTPS_PROXY || process.env.https_proxy || proxy;\n    }\n    if (proxy && !options.proxy) {\n      options.proxy = proxy;\n    }\n\n    if (! _.has(options, \"timeout\")) {\n      // 60 seconds for timeout between initial response headers and data,\n      // and between chunks of data while reading the rest of the response.\n      options.timeout = 60 * 1000 * timeoutScaleFactor;\n    } else if (! (typeof options.timeout === \"number\" &&\n                  options.timeout > 0)) {\n      // The timeout can be disabled by passing anything other than a\n      // positive number, e.g. { timeout: null }.\n      delete options.timeout;\n    }\n\n    let onRequest;\n    if (_.has(options, \"onRequest\")) {\n      onRequest = options.onRequest;\n      delete options.onRequest;\n    }\n\n    // request is the most heavy-weight of the tool's npm dependencies; don't\n    // require it until we definitely need it.\n    Console.debug(\"Doing HTTP request: \", options.method || 'GET', options.url);\n    var request = require('request');\n    var req = request(options, function (error, response, body) {\n      if (! error &&\n          response &&\n          (typeof body === \"string\" ||\n           Buffer.isBuffer(body))) {\n        const contentLength = Number(response.headers[\"content-length\"]);\n        const actualLength = Buffer.byteLength(body);\n\n        if (contentLength > 0 &&\n            actualLength < contentLength) {\n          error = new Error(\n            \"Expected \" + contentLength + \" bytes in request body \" +\n              \"but received only \" + actualLength);\n        }\n      }\n\n      return callback.call(this, error, response, body);\n    });\n\n    if (_.isFunction(onRequest)) {\n      onRequest(req);\n    }\n\n    var totalProgress = { current: 0, end: bodyStreamLength + responseLength, done: false };\n\n    if (bodyStream) {\n      var dest = req;\n      if (progress) {\n        dest = new WritableWithProgress(dest, function (n, done) {\n          if (!totalProgress.done) {\n            totalProgress.current += n;\n            progress.reportProgress(totalProgress);\n          }\n        });\n      }\n      bodyStream.pipe(dest);\n    }\n\n    if (outputStream) {\n      req.pipe(outputStream);\n    }\n\n    if (progress) {\n      httpHelpers._addProgressEvents(req);\n      req.on('progress', function (state) {\n        if (!totalProgress.done) {\n          totalProgress.current = bodyStreamLength + state.current;\n          totalProgress.end = bodyStreamLength + state.end;\n          totalProgress.done = state.done;\n\n          progress.reportProgress(totalProgress);\n        }\n      });\n    }\n\n    if (promise) {\n      try {\n        return promise.await();\n      } finally {\n        if (progress) {\n          progress.reportProgressDone();\n        }\n      }\n    } else {\n      return req;\n    }\n  },\n\n  // Adds progress callbacks to a request\n  // Based on request-progress\n  _addProgressEvents: function (request) {\n    var state = {};\n\n    var emitProgress = function () {\n      request.emit('progress', state);\n    };\n\n    request\n      .on('response', function (response) {\n        state.end = undefined;\n        state.done = false;\n        state.current = 0;\n        var contentLength = response.headers['content-length'];\n        if (contentLength) {\n          state.end = Number(contentLength);\n        }\n        emitProgress();\n      })\n      .on('data', function (data) {\n        state.current += data.length;\n        emitProgress();\n      })\n      .on('end', function (data) {\n        state.done = true;\n        emitProgress();\n      });\n  },\n\n  // A synchronous wrapper around request(...) that returns the response \"body\"\n  // or throws.\n  //\n  // (This has gone through a few refactors and it might be possible\n  // to fully roll it into httpHelpers.request() at this point.)\n  getUrl: function (urlOrOptions) {\n    try {\n      var result = httpHelpers.request(urlOrOptions);\n    } catch (e) {\n      throw new files.OfflineError(e);\n    }\n\n    const response = result.response;\n    const body = result.body;\n    const href = response.request.href;\n\n    if (response.statusCode >= 400 && response.statusCode < 600) {\n      throw Error(\n        body ||\n          `Could not get ${href}; server returned [${response.statusCode}]`);\n    } else {\n      return body;\n    }\n  },\n\n  // More or less as above, except with support for multiple attempts per\n  // request and resuming on retries. This means if the connection is bad,\n  // we can sometimes complete a request, even if each individual attempt fails.\n  // We only use this for package downloads. In theory we could use it for\n  // all requests but that seems like overkill and it isn't well tested in\n  // other scenarioes.\n  getUrlWithResuming(urlOrOptions) {\n    const options = _.isObject(urlOrOptions) ? _.clone(urlOrOptions) : {\n      url: urlOrOptions,\n    };\n\n    const maxAttempts =\n      _.has(options, \"maxAttempts\")\n      ? options.maxAttempts : 10;\n\n    const retryDelaySecs =\n      _.has(options, \"retryDelaySecs\")\n      ? options.retryDelaySecs : 5;\n\n    const masterProgress = options.progress;\n    const outputStream = new ConcatStream();\n\n    function attempt(triesRemaining = maxAttempts, startAt = 0) {\n      if (startAt > 0) {\n        options.headers = {\n          ...options.headers,\n          Range: `bytes=${startAt}-`\n        };\n      }\n\n      if (masterProgress &&\n          masterProgress.addChildTask) {\n        options.progress = masterProgress.addChildTask({\n          title: masterProgress.title\n        });\n      }\n\n      try {\n        return Promise.resolve(httpHelpers.request({\n          outputStream,\n          ...options,\n        }));\n\n      } catch (e) {\n        const size = outputStream.size;\n        const useTry = size === startAt;\n        const change = size - startAt;\n\n        if (!useTry || triesRemaining > 0) {\n          if (useTry) {\n            Console.debug(`Request failed, ${triesRemaining - 1} attempts left`);\n          } else {\n            Console.debug(`Request failed after ${change} bytes, retrying`);\n          }\n\n          return new Promise(\n            resolve => setTimeout(resolve, retryDelaySecs * 1000)\n          ).then(() => attempt(triesRemaining - (useTry ? 1 : 0), size));\n        }\n\n        Console.debug(`Request failed ${maxAttempts} times: failing`);\n        return Promise.reject(new files.OfflineError(e));\n      }\n    }\n\n    const result = attempt().await();\n    const response = result.response\n    if (response.statusCode >= 400 && response.statusCode < 600) {\n      const href = response.request.href;\n      throw Error(`Could not get ${href}; server returned [${response.statusCode}]`);\n    }\n\n    // Really end the stream if we got this far.\n    outputStream.end(true);\n\n    return outputStream.getBuffer();\n  }\n});\n"],"file":"tools/utils/http-helpers.js.map"}