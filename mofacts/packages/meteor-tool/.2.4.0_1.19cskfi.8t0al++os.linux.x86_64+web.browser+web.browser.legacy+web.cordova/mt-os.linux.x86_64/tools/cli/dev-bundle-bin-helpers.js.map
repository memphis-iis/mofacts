{"version":3,"sources":["/tools/cli/dev-bundle-bin-helpers.js"],"names":["fs","require","path","convertToOSPath","isWindows","process","platform","extensions","hasOwn","Object","prototype","hasOwnProperty","getDevBundle","exports","getCommand","name","devBundleDir","result","replace","isValidCommand","some","ext","cmd","join","statSync","isFile","e","charAt","meteorCommandsJsonPath","meteorCommands","call","getEnv","options","devBundle","devBundlePromise","Promise","resolve","then","paths","dirname","env","create","NO_UPDATE_NOTIFIER","NPM_CONFIG_PREFIX","METEOR_ALLOW_SUPERUSER","NPM_CONFIG_UNSAFE_PERM","NPM_CONFIG_NODEDIR","PATH","Path","push","delimiter","addWindowsVariables","cachedMSVSVersion","PYTHON","GYP_MSVS_VERSION","nodeGypPylibDir","child","spawn","cwd","stdio","chunks","stdout","on","chunk","finish","codeOrError","Buffer","concat","toString"],"mappings":"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","sourcesContent":["const fs = require(\"fs\");\nconst path = require(\"path\");\nconst { convertToOSPath } = require(\"./convert-to-os-path.js\");\n\nvar isWindows = process.platform === \"win32\";\nvar extensions = isWindows ? [\".cmd\", \".exe\"] : [\"\"];\nvar hasOwn = Object.prototype.hasOwnProperty;\n\nfunction getDevBundle() {\n  return require(\"./dev-bundle.js\");\n}\nexports.getDevBundle = getDevBundle;\n\nexports.getCommand = function (name, devBundleDir) {\n  var result = null;\n\n  // Strip leading and/or trailing whitespace.\n  name = name.replace(/^\\s+|\\s+$/g, \"\");\n\n  if (! isValidCommand(name, devBundleDir)) {\n    return result;\n  }\n\n  extensions.some(function (ext) {\n    var cmd = path.join(devBundleDir, \"bin\", name + ext);\n    try {\n      if (fs.statSync(cmd).isFile()) {\n        result = cmd;\n        return true;\n      }\n    } catch (e) {\n      return false;\n    }\n  });\n\n  return result;\n};\n\nfunction isValidCommand(name, devBundleDir) {\n  if (name === \"node\" ||\n      name === \"npm\" ||\n      name === \"npx\") {\n    return true;\n  }\n\n  if (! name || name.charAt(0) === \".\") {\n    // Disallow empty commands and commands that start with a period.\n    return false;\n  }\n\n  var meteorCommandsJsonPath =\n    path.join(devBundleDir, \"bin\", \".meteor-commands.json\");\n\n  try {\n    var meteorCommands = require(meteorCommandsJsonPath);\n  } catch (e) {\n    return false;\n  }\n\n  // If `meteor <name>` is already a Meteor command, don't let anything in\n  // dev_bundle/bin override it.\n  return ! hasOwn.call(meteorCommands, name);\n}\n\nexports.getEnv = function (options) {\n  var devBundle = options && options.devBundle;\n  var devBundlePromise = typeof devBundle === \"string\"\n    ? Promise.resolve(convertToOSPath(devBundle))\n    : getDevBundle();\n\n  return devBundlePromise.then(function (devBundleDir) {\n    var paths = [\n      // When npm looks for node, it must find dev_bundle/bin/node.\n      path.join(devBundleDir, \"bin\"),\n\n      // When npm looks for meteor, it should find dev_bundle/../meteor.\n      path.dirname(devBundleDir),\n\n      // Also make available any scripts installed by packages in\n      // dev_bundle/lib/node_modules, such as node-gyp.\n      path.join(devBundleDir, \"lib\", \"node_modules\", \".bin\")\n    ];\n\n    var env = Object.create(process.env);\n\n    // Make sure notifications to update npm aren't presented to the user.\n    env.NO_UPDATE_NOTIFIER = true;\n\n    // Make sure `meteor npm install --global ...` installs into\n    // dev_bundle/lib/node_modules by default.\n    if (! env.NPM_CONFIG_PREFIX) {\n      env.NPM_CONFIG_PREFIX = devBundleDir;\n    }\n\n    if (env.METEOR_ALLOW_SUPERUSER) {\n      // Note that env.METEOR_ALLOW_SUPERUSER could be \"0\" or \"false\", which\n      // should propagate falsy semantics to NPM_CONFIG_UNSAFE_PERM.\n      env.NPM_CONFIG_UNSAFE_PERM = env.METEOR_ALLOW_SUPERUSER;\n    }\n\n    // This allows node-gyp to find Node headers and libraries in\n    // dev_bundle/include/node.\n    env.NPM_CONFIG_NODEDIR = devBundleDir;\n\n    var PATH = env.PATH || env.Path;\n    if (PATH) {\n      paths.push(PATH);\n    }\n\n    env.PATH = paths.join(path.delimiter);\n\n    if (process.platform === \"win32\") {\n      return addWindowsVariables(devBundleDir, env);\n    }\n\n    return env;\n  });\n};\n\n// Caching env.GYP_MSVS_VERSION allows us to avoid invoking Python every\n// time Meteor runs an npm command. TODO Store this on disk?\nvar cachedMSVSVersion;\n\nfunction addWindowsVariables(devBundleDir, env) {\n  // On Windows we provide a reliable version of python.exe for use by\n  // node-gyp (the tool that rebuilds binary node modules). #WinPy\n  env.PYTHON = env.PYTHON || path.join(\n    devBundleDir, \"python\", \"python.exe\");\n\n  // While the original process.env object allows for case insensitive\n  // access on Windows, Object.create interferes with that behavior,\n  // so here we ensure env.PATH === env.Path on Windows.\n  env.Path = env.PATH;\n\n  if (cachedMSVSVersion) {\n    env.GYP_MSVS_VERSION = cachedMSVSVersion;\n  }\n\n  if (env.GYP_MSVS_VERSION) {\n    return Promise.resolve(env);\n  }\n\n  // If $GYP_MSVS_VERSION was not provided, use the gyp Python library to\n  // infer it, or default to 2015 if that doesn't work.\n  return new Promise(function (resolve) {\n    var nodeGypPylibDir = path.join(\n      devBundleDir, \"lib\", \"node_modules\", \"node-gyp\", \"gyp\", \"pylib\"\n    );\n\n    var child = require(\"child_process\").spawn(env.PYTHON, [\"-c\", [\n      \"from gyp.MSVSVersion import SelectVisualStudioVersion\",\n      \"try:\",\n      \"  print SelectVisualStudioVersion(allow_fallback=False).short_name\",\n      \"except:\",\n      \"  print 2015\"\n    ].join(\"\\n\")], {\n      cwd: nodeGypPylibDir,\n      stdio: \"pipe\"\n    });\n\n    var chunks = [];\n    child.stdout.on(\"data\", function (chunk) {\n      chunks.push(chunk);\n    });\n\n    function finish(codeOrError) {\n      if (codeOrError) {\n        // In the event of any kind of error, default to 2015.\n        cachedMSVSVersion = \"2015\";\n      } else {\n        cachedMSVSVersion = Buffer.concat(chunks)\n          .toString(\"utf8\").replace(/^\\s+|\\s+$/g, \"\");\n      }\n\n      env.GYP_MSVS_VERSION = cachedMSVSVersion;\n\n      resolve(env);\n    }\n\n    child.on(\"error\", finish);\n    child.on(\"exit\", finish);\n  });\n}\n"],"file":"tools/cli/dev-bundle-bin-helpers.js.map"}