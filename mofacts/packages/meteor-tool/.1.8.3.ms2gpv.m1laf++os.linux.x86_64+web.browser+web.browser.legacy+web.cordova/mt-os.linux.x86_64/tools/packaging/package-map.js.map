{"version":3,"sources":["/tools/packaging/package-map.js"],"names":["isIsobuildFeaturePackage","module","link","v","_","require","packageVersionParser","utils","exports","PackageMap","versions","options","self","_map","_localCatalog","localCatalog","each","version","packageName","packageSource","getPackageSource","kind","extend","prototype","eachPackage","iterator","info","infoClone","clone","getInfo","has","makeSubsetMap","packageNames","subsetVersions","Error","toJSON","ret","sourceRoot","toVersionMap","isSupersetOfJSON","mapJSON","all","jsonInfo","thisInfo","fromReleaseVersion","releaseVersion","toolPackageVersion","tool","parsePackageAndVersion","toolPackage","package","toolVersion","versionMap","packages","PackageMapDelta","_changedPackages","packageMap","oldVersion","cachedVersions","_storeAddOrChange","anticipatedPrereleases","neededToUseUnanticipatedPrereleases","_storeRemove","newInfo","backwardsIncompatible","majorVersion","isPrerelease","test","isAnticipatedPrerelease","newVersion","isBackwardsIncompatible","isUnanticipatedPrerelease","eachChangedPackage","hasChanges","isEmpty","displayOnConsole","title","displayItems","anyBackwardsIncompatible","anyUnanticipatedPrerelease","push","name","description","lessThan","Console","printPackageList"],"mappings":"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","sourcesContent":["var _ = require('underscore');\nvar packageVersionParser = require('./package-version-parser.js');\nvar utils = require('../utils/utils.js');\nimport { isIsobuildFeaturePackage } from '../isobuild/compiler.js';\n\n// PackageMap: Represents the choices of package versions being used for a\n// project. It knows all the packages that are used (direct and indirect\n// dependencies), their versions, whether they are local or versioned packages,\n// and the PackageSource object for any local packages.  Prefer using this\n// function over arbitrary JSON representations when possible.  (A related class\n// is projectContextModule.PackageMapFile which specifically represents the\n// .meteor/packages file on disk.)\n//\n// It has a corresponding JSON format (used, eg, inside buildinfo files).\n//\n// If you specify the localCatalog option to the constructor, any package in\n// that localCatalog will be considered to be local, and all others will be\n// considered to be prebuilt versioned packages from troposphere.  If you do not\n// specify the localCatalog option, all packages will be considered to prebuilt\n// versioned packages.\nexports.PackageMap = function (versions, options) {\n  var self = this;\n  options = options || {};\n  self._map = {};\n  self._localCatalog = options.localCatalog || null;\n\n  _.each(versions, function (version, packageName) {\n    // If the constraint solver told us that we needed an isobuild feature,\n    // that's fine, but it's not a real package.\n    if (isIsobuildFeaturePackage(packageName)) {\n      return;\n    }\n\n    var packageSource = self._localCatalog &&\n          self._localCatalog.getPackageSource(packageName);\n    if (packageSource) {\n      self._map[packageName] =\n        { kind: 'local', version: version, packageSource: packageSource };\n    } else {\n      self._map[packageName] =\n        { kind: 'versioned', version: version, packageSource: null };\n    }\n  });\n};\n\n_.extend(exports.PackageMap.prototype, {\n  eachPackage: function (iterator) {\n    var self = this;\n    _.each(self._map, function (info, packageName) {\n      // For reasons that are super unclear, if this `_.clone` is inlined into\n      // the `iterator` call, the value produced can mysteriously turn into\n      // undefined on the way into `iterator`. Presumably some sort of memory\n      // corruption, maybe Fiber-related?  Trying to minimize has been an\n      // exercise in nondeterminism. But this does seem to be a sure-fire way to\n      // fix it, for now. Who knows why, and who knows when it will recur again.\n      var infoClone = _.clone(info);\n      iterator(packageName, infoClone);\n    });\n  },\n  getInfo: function (packageName) {\n    var self = this;\n    if (_.has(self._map, packageName)) {\n      return self._map[packageName];\n    }\n    return null;\n  },\n  makeSubsetMap: function (packageNames) {\n    var self = this;\n    var subsetVersions = {};\n    _.each(packageNames, function (packageName) {\n      var info = self.getInfo(packageName);\n      if (!info) {\n        throw Error(\"not a subset: \" + packageName);\n      }\n      subsetVersions[packageName] = info.version;\n    });\n    return new exports.PackageMap(subsetVersions, {\n      localCatalog: self._localCatalog\n    });\n  },\n\n  toJSON: function () {\n    var self = this;\n    var ret = {};\n    _.each(self._map, function (info, packageName) {\n      if (info.kind === 'local') {\n        ret[packageName] = {\n          kind: 'local',\n          sourceRoot: info.packageSource.sourceRoot\n        };\n      } else {\n        ret[packageName] = {\n          kind: 'versioned',\n          version: info.version\n        };\n      }\n    });\n    return ret;\n  },\n  // Returns a map from package name to version. In most cases, this is a far\n  // worse representation than PackageMap... avoid using it!\n  toVersionMap: function () {\n    var self = this;\n    var ret = {};\n    _.each(self._map, function (info, packageName) {\n      ret[packageName] = info.version;\n    });\n    return ret;\n  },\n\n  // Given some JSON as returned from toJSON, returns true if every package in\n  // the JSON has the same mapping as in this map.\n  isSupersetOfJSON: function (mapJSON) {\n    var self = this;\n    return _.all(mapJSON, function (jsonInfo, packageName) {\n      var thisInfo = self.getInfo(packageName);\n      if (! thisInfo) {\n        return false;\n      }\n      if (jsonInfo.kind !== thisInfo.kind) {\n        return false;\n      }\n      if (thisInfo.kind === 'local') {\n        return thisInfo.packageSource.sourceRoot === jsonInfo.sourceRoot;\n      } else {\n        return thisInfo.version === jsonInfo.version;\n      }\n    });\n  }\n});\n\n// Static method: returns a PackageMap that represents a (catalog)\n// ReleaseVersion entry (including its tool).  Note that this function assumes\n// that all packages will be prebuilt versioned, not local. This is mostly used\n// to create PackageMaps to pass to tropohouse.downloadPackagesMissingFromMap;\n// it should not be used as part of a ProjectContext because it does not allow\n// you to override release packages with local packages.\nexports.PackageMap.fromReleaseVersion = function (releaseVersion) {\n  var toolPackageVersion = releaseVersion.tool &&\n        utils.parsePackageAndVersion(releaseVersion.tool);\n  if (!toolPackageVersion) {\n    throw new Error(\"bad tool in release: \" + releaseVersion.tool);\n  }\n  var toolPackage = toolPackageVersion.package;\n  var toolVersion = toolPackageVersion.version;\n\n  var versionMap = _.clone(releaseVersion.packages || {});\n  versionMap[toolPackage] = toolVersion;\n\n  // As described in this function's description, all packages in this map are\n  // versioned, so we do not specify a localCatalog.\n  return new exports.PackageMap(versionMap);\n};\n\n\n\n// PackageMapDelta: represents the change in a PackageMap between two constraint\n// solver runs.\nexports.PackageMapDelta = function (options) {\n  var self = this;\n  self._changedPackages = {};\n\n  options.packageMap.eachPackage(function (packageName, info) {\n    var oldVersion = _.has(options.cachedVersions, packageName)\n          ? options.cachedVersions[packageName] : null;\n    self._storeAddOrChange(\n      packageName, info, oldVersion, options.anticipatedPrereleases,\n      options.neededToUseUnanticipatedPrereleases);\n  });\n\n  _.each(options.cachedVersions, function (oldVersion, packageName) {\n    if (! options.packageMap.getInfo(packageName)) {\n      self._storeRemove(packageName, oldVersion);\n    }\n  });\n};\n\n_.extend(exports.PackageMapDelta.prototype, {\n  _storeAddOrChange: function (packageName, newInfo, oldVersion,\n                               anticipatedPrereleases,\n                               neededToUseUnanticipatedPrereleases) {\n    var self = this;\n\n    // Store nothing if nothing has changed.\n    if (newInfo.version === oldVersion) {\n      return;\n    }\n\n    var backwardsIncompatible =\n          oldVersion !== null &&\n          (packageVersionParser.majorVersion(newInfo.version) !==\n           packageVersionParser.majorVersion(oldVersion));\n\n    var isPrerelease = /-/.test(newInfo.version);\n    var isAnticipatedPrerelease = _.has(anticipatedPrereleases, packageName) &&\n          _.has(anticipatedPrereleases[packageName], newInfo.version);\n    self._changedPackages[packageName] = {\n      oldVersion: oldVersion,\n      newVersion: newInfo.version,\n      isBackwardsIncompatible: backwardsIncompatible,\n      isUnanticipatedPrerelease: (neededToUseUnanticipatedPrereleases &&\n                                  isPrerelease && !isAnticipatedPrerelease)\n    };\n  },\n\n  _storeRemove: function (packageName, oldVersion) {\n    var self = this;\n    self._changedPackages[packageName] = {\n      oldVersion: oldVersion,\n      newVersion: null\n    };\n  },\n\n  eachChangedPackage: function (iterator) {\n    var self = this;\n    _.each(self._changedPackages, function (info, packageName) {\n      iterator(packageName, _.clone(info));\n    });\n  },\n\n  hasChanges: function () {\n    var self = this;\n    return ! _.isEmpty(self._changedPackages);\n  },\n\n  displayOnConsole: function (options) {\n    var self = this;\n    options = _.extend({\n      title: \"Changes to your project's package version selections:\"\n    }, options);\n\n    // Print nothing at all if nothing changed.\n    if (! self.hasChanges()) {\n      return;\n    }\n\n    var displayItems = [];\n    var anyBackwardsIncompatible = false;\n    var anyUnanticipatedPrerelease = false;\n    self.eachChangedPackage(function (packageName, info) {\n      if (info.newVersion === null) {\n        displayItems.push({\n          name: packageName,\n          description: \"removed from your project\"\n        });\n        return;\n      }\n\n      var name = packageName;\n      if (info.isBackwardsIncompatible) {\n        name += '*';\n        anyBackwardsIncompatible = true;\n      }\n      if (info.isUnanticipatedPrerelease) {\n        name += '+';\n        anyUnanticipatedPrerelease = true;\n      }\n\n      var description;\n      if (info.oldVersion === null) {\n        description = \"added, version \" + info.newVersion;\n      } else if (packageVersionParser.lessThan(info.oldVersion,\n                                               info.newVersion)) {\n        description =\n          \"upgraded from \" + info.oldVersion + \" to \" + info.newVersion;\n      } else {\n        description =\n          \"downgraded from \" + info.oldVersion + \" to \" + info.newVersion;\n      }\n      displayItems.push({ name: name, description: description });\n    });\n\n    var Console = require('../console/console.js').Console;\n\n    Console.info();\n    Console.info(options.title);\n    Console.info();\n    utils.printPackageList(displayItems);\n    if (anyBackwardsIncompatible) {\n      Console.info(\"\\n\" +\n\"* These packages have been updated to new versions that are not backwards\\n\" +\n\"  compatible.\");\n    }\n    if (anyUnanticipatedPrerelease) {\n      Console.info(\"\\n\" +\n\"+ In order to resolve constraints, we had to use experimental versions of these\\n\" +\n\"  packages.\");\n    }\n  }\n});\n"],"file":"tools/packaging/package-map.js.map"}