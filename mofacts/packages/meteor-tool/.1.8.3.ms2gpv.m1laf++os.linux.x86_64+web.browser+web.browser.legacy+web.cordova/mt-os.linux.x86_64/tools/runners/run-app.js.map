{"version":3,"sources":["/tools/runners/run-app.js"],"names":["pluginVersionsFromStarManifest","module","link","v","CordovaBuilder","closeAllWatchers","eachline","loadIsopackage","_","require","Fiber","uuid","fiberHelpers","files","watch","bundler","buildmessage","runLog","stats","Console","catalog","Profile","release","hasOwn","Object","prototype","hasOwnProperty","bashParse","s","search","Error","without","split","getNodeOptionsFromEnvironment","process","env","NODE_OPTIONS","AppProcess","options","self","projectContext","bundlePath","port","listenHost","rootUrl","mongoUrl","oplogUrl","mobileServerUrl","onExit","onListen","nodeOptions","inspect","settings","testMetadata","autoRestart","proc","madeExitCallback","extend","start","_spawn","stdout","line","match","logAppOutput","stderr","on","code","signal","_maybeCallOnExit","err","log","message","arrow","stdin","stop","pid","removeAllListeners","kill","_computeEnvironment","PORT","ROOT_URL","MONGO_URL","MOBILE_DDP_URL","MOBILE_ROOT_URL","MONGO_OPLOG_URL","METEOR_SETTINGS","TEST_METADATA","JSON","stringify","BIND_IP","APP_ID","appIdentifier","METEOR_AUTO_RESTART","HTTP_FORWARDED_COUNT","parseInt","break","METEOR_INSPECT_BRK","shellDir","getMeteorShellDirectory","mkdir_p","METEOR_SHELL_DIR","convertToOSPath","METEOR_PARENT_PID","METEOR_BAD_PARENT_PID_FOR_TEST","METEOR_PRINT_ON_LISTEN","entryPoint","pathJoin","opts","clone","push","child_process","child","spawn","execPath","stdio","enable","AppRunner","buildOptions","cordovaRunner","settingsFile","proxy","once","watchForChanges","undefined","onRunEnd","noRestartBanner","recordPackageUsage","omitPackageMapDeltaDisplayOnFirstRun","fiber","startPromise","runPromise","exitPromise","watchPromise","_promiseResolvers","_beforeStartPromise","builders","create","_makePromise","_fiber","run","await","name","Promise","resolve","_resolvePromise","value","_cleanUpPromises","each","outcome","makeBeforeStartPromise","_runOnce","firstRun","enableProgressDisplay","clearLog","setMode","getProjectLocalDirectory","cachedServerWatchSet","bundleApp","triedToRefreshRecently","reset","softRefreshIsopacks","preservePackageMap","messages","capture","readProjectMetadata","hasMessages","runResult","errors","watchSet","getProjectAndLocalPackagesWatchSet","wrongRelease","usingRightReleaseForApp","displayReleaseNeeded","releaseFile","displayReleaseName","prepareProjectForBuild","packageMapDelta","displayOnConsole","recordPackages","what","bundleResult","bundle","outputPath","includeNodeModules","hasCachedBundle","previousBuilders","allowDelayedClientBuilds","isHeadless","serverWatchSet","combinedWatchSetForBundleResult","br","merge","clientWatchSet","bundleResultOrRunResult","settingsWatchSet","WatchSet","settingsMessages","title","rootPath","cwd","getSettings","canRefreshClient","packageMap","getInfo","pluginVersions","starManifest","started","prepareProject","printWarningsIfNeeded","havePlatformsChangedSinceLastRun","havePluginsChangedSinceLastRun","listenPromise","beforeRun","appProcess","stopped","maybePrintLintWarnings","lintAppAndLocalPackages","warnings","formattedMessages","formatMessages","startRunTargets","serverWatcher","clientWatcher","Watcher","onChange","includePotentiallyUnusedFiles","async","setupClientWatcher","isUpToDate","pauseClient","arch","sendMessage","refreshClient","runPostStartupCallbacks","callbacks","postStartupCallbacks","length","fn","shift","error","postStartupResult","race","then","ret","logClientRestart","oldPromise","logTemporary","crashCount","crashTimer","resetCrashCount","setTimeout","logRestart","clearTimeout","wantExit","watcher","exports"],"mappings":"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","sourcesContent":["var _ = require('underscore');\nvar Fiber = require('fibers');\nconst uuid = require(\"uuid\");\nvar fiberHelpers = require('../utils/fiber-helpers.js');\nvar files = require('../fs/files');\nvar watch = require('../fs/watch');\nvar bundler = require('../isobuild/bundler.js');\nvar buildmessage = require('../utils/buildmessage.js');\nvar runLog = require('./run-log.js');\nvar stats = require('../meteor-services/stats.js');\nvar Console = require('../console/console.js').Console;\nvar catalog = require('../packaging/catalog/catalog.js');\nvar Profile = require('../tool-env/profile').Profile;\nvar release = require('../packaging/release.js');\nimport { pluginVersionsFromStarManifest } from '../cordova/index.js';\nimport { CordovaBuilder } from '../cordova/builder.js';\nimport { closeAllWatchers } from \"../fs/safe-watcher\";\nimport { eachline } from \"../utils/eachline\";\nimport { loadIsopackage } from '../tool-env/isopackets.js';\n\nconst hasOwn = Object.prototype.hasOwnProperty;\n\n// Parse out s as if it were a bash command line.\nvar bashParse = function (s) {\n  if (s.search(\"\\\"\") !== -1 || s.search(\"'\") !== -1) {\n    throw new Error(\"Meteor cannot currently handle quoted NODE_OPTIONS\");\n  }\n  return _.without(s.split(/\\s+/), '');\n};\n\nvar getNodeOptionsFromEnvironment = function () {\n  return bashParse(process.env.NODE_OPTIONS || \"\");\n};\n\n///////////////////////////////////////////////////////////////////////////////\n// AppProcess\n///////////////////////////////////////////////////////////////////////////////\n\n// Given a bundle, run a program in the bundle. Report when it dies.\n//\n// Call start() to start the process. You will then eventually receive\n// a call to onExit(code, signal): code is the numeric exit code of a\n// normal exit, signal is the string signal name if killed, and if\n// both are undefined it means something went wrong in invoking the\n// program and it was logged.\n//\n// If the app successfully starts up, you will also receive onListen()\n// once the app says it's ready to receive connections.\n//\n// Call stop() at any time after start() returns to terminate the\n// process if it is running. You will get an onExit callback if this\n// resulted in the process dying. stop() is idempotent.\n//\n// Required options: bundlePath, port, rootUrl, mongoUrl, oplogUrl\n// Optional options: onExit, onListen, nodeOptions, settings\n\nvar AppProcess = function (options) {\n  var self = this;\n\n  self.projectContext = options.projectContext;\n  self.bundlePath = options.bundlePath;\n  self.port = options.port;\n  self.listenHost = options.listenHost;\n  self.rootUrl = options.rootUrl;\n  self.mongoUrl = options.mongoUrl;\n  self.oplogUrl = options.oplogUrl;\n  self.mobileServerUrl = options.mobileServerUrl;\n\n  self.onExit = options.onExit;\n  self.onListen = options.onListen;\n  self.nodeOptions = options.nodeOptions || [];\n  self.inspect = options.inspect;\n  self.settings = options.settings;\n  self.testMetadata = options.testMetadata;\n  self.autoRestart = options.autoRestart;\n\n  self.proc = null;\n  self.madeExitCallback = false;\n};\n\n_.extend(AppProcess.prototype, {\n  // Call to start the process.\n  start: function () {\n    var self = this;\n\n    if (self.proc) {\n      throw new Error(\"already started?\");\n    }\n\n    // Start the app!\n    self.proc = self._spawn();\n\n    eachline(self.proc.stdout, function (line) {\n      if (line.match(/^LISTENING\\s*$/)) {\n        // This is the child process telling us that it's ready to receive\n        // connections.  (It does this because we told it to with\n        // $METEOR_PRINT_ON_LISTEN.)\n        self.onListen && self.onListen();\n\n      } else {\n        runLog.logAppOutput(line);\n      }\n    });\n\n    eachline(self.proc.stderr, function (line) {\n      runLog.logAppOutput(line, true);\n    });\n\n    // Watch for exit and for stdio to be fully closed (so that we don't miss\n    // log lines).\n    self.proc.on('close', async function (code, signal) {\n      self._maybeCallOnExit(code, signal);\n    });\n\n    self.proc.on('error', async function (err) {\n      runLog.log(\"Couldn't spawn process: \" + err.message,  { arrow: true });\n\n      // node docs say that it might make both an 'error' and a\n      // 'close' callback, so we use a guard to make sure we only call\n      // onExit once.\n      self._maybeCallOnExit();\n    });\n\n    // This happens sometimes when we write a keepalive after the app\n    // is dead. If we don't register a handler, we get a top level\n    // exception and the whole app dies.\n    // http://stackoverflow.com/questions/2893458/uncatchable-errors-in-node-js\n    self.proc.stdin.on('error', function () {});\n  },\n\n  _maybeCallOnExit: function (code, signal) {\n    var self = this;\n    if (self.madeExitCallback) {\n      return;\n    }\n    self.madeExitCallback = true;\n    self.onExit && self.onExit(code, signal);\n  },\n\n  // Idempotent. Once stop() returns it is guaranteed that you will\n  // receive no more callbacks from this AppProcess.\n  stop: function () {\n    var self = this;\n\n    if (self.proc && self.proc.pid) {\n      self.proc.removeAllListeners('close');\n      self.proc.removeAllListeners('error');\n      self.proc.kill();\n    }\n    self.proc = null;\n\n    self.onListen = null;\n    self.onExit = null;\n  },\n\n  _computeEnvironment: function () {\n    var self = this;\n    var env = _.extend({}, process.env);\n\n    env.PORT = self.port;\n    env.ROOT_URL = self.rootUrl;\n    env.MONGO_URL = self.mongoUrl;\n    if (self.mobileServerUrl) {\n      env.MOBILE_DDP_URL = self.mobileServerUrl;\n      env.MOBILE_ROOT_URL = self.mobileServerUrl;\n    }\n\n    if (self.oplogUrl) {\n      env.MONGO_OPLOG_URL = self.oplogUrl;\n    }\n    if (self.settings) {\n      env.METEOR_SETTINGS = self.settings;\n    } else {\n      // Warn the developer that we are not going to use their environment var.\n      if (env.METEOR_SETTINGS) {\n        runLog.log(\n          \"WARNING: The 'METEOR_SETTINGS' environment variable is ignored \" +\n          \"when running in development (as you are doing now).  Instead, use \" +\n          \"the '--settings settings.json' option to see reactive changes \" +\n          \"when settings are changed.  For more information, see the \" +\n          \"documentation for 'Meteor.settings': \" +\n          \"https://docs.meteor.com/api/core.html#Meteor-settings\" +\n          \"\\n\");\n      }\n\n      // To provide a consistent, reactive experience in development, do\n      // not use settings provided via the environment variable.\n      delete env.METEOR_SETTINGS;\n    }\n    if (self.testMetadata) {\n      env.TEST_METADATA = JSON.stringify(self.testMetadata);\n    } else {\n      delete env.TEST_METADATA;\n    }\n    if (self.listenHost) {\n      env.BIND_IP = self.listenHost;\n    } else {\n      delete env.BIND_IP;\n    }\n    env.APP_ID = self.projectContext.appIdentifier;\n    env.METEOR_AUTO_RESTART = self.autoRestart;\n\n    // We run the server behind our own proxy, so we need to increment\n    // the HTTP forwarded count.\n    env.HTTP_FORWARDED_COUNT =\n      \"\" + ((parseInt(process.env['HTTP_FORWARDED_COUNT']) || 0) + 1);\n\n    if (self.inspect &&\n        self.inspect.break) {\n      env.METEOR_INSPECT_BRK = self.inspect.port;\n    } else {\n      delete env.METEOR_INSPECT_BRK;\n    }\n\n    var shellDir = self.projectContext.getMeteorShellDirectory();\n    files.mkdir_p(shellDir);\n\n    // We need to convert to OS path here because the running app doesn't\n    // have access to path translation functions\n    env.METEOR_SHELL_DIR = files.convertToOSPath(shellDir);\n\n    env.METEOR_PARENT_PID =\n      process.env.METEOR_BAD_PARENT_PID_FOR_TEST ? \"foobar\" : process.pid;\n\n    env.METEOR_PRINT_ON_LISTEN = 'true';\n\n    return env;\n  },\n\n  // Spawn the server process and return the handle from child_process.spawn.\n  _spawn: function () {\n    var self = this;\n\n    // Path conversions\n    var entryPoint = files.convertToOSPath(\n      files.pathJoin(self.bundlePath, 'main.js'));\n\n    // Setting options\n    var opts = _.clone(self.nodeOptions);\n\n    if (self.inspect) {\n      // Always use --inspect rather than --inspect-brk, even when\n      // self.inspect.break is true, because --inspect-brk stops at the\n      // very first instruction executed by the child process, which is\n      // too early to set any meaningful breakpoints. Instead, we want to\n      // stop just after server code has loaded but before it begins to\n      // execute. See _computeEnvironment for logic that sets\n      // env.METEOR_INSPECT_BRK in that case.\n      opts.push(\"--inspect=\" + self.inspect.port);\n    }\n\n    opts.push(entryPoint);\n\n    // Call node\n    var child_process = require('child_process');\n    // setup the 'ipc' pipe if further communication between app and proxy is\n    // expected\n    var child = child_process.spawn(process.execPath, opts, {\n      env: self._computeEnvironment(),\n      stdio: ['pipe', 'pipe', 'pipe', 'ipc'],\n    });\n\n    // Add a child.sendMessage(topic, payload) method to this child\n    // process object.\n    loadIsopackage(\"inter-process-messaging\").enable(child);\n\n    return child;\n  }\n});\n\n///////////////////////////////////////////////////////////////////////////////\n// AppRunner\n///////////////////////////////////////////////////////////////////////////////\n\n// Given an app, bundle and run the app. If the app's source changes,\n// kill, rebundle, and rerun it. If the app dies, restart it, unless\n// it dies repeatedly immediately after being started, in which case\n// wait for source changes to restart.\n//\n// Communicates with a Proxy to tell it when the app is up,\n// temporarily down, or crashing.\n//\n// Options include:\n//\n// - onRunEnd(result): If provided, called after each run of the program (or\n//   attempted run, if, say, bundling fails). Blocks restarting until it\n//   returns. See below for the format of 'result'. Return truthy to continue;\n//   return falsey to give up (without logging any more status messages). Do not\n//   call stop() from onRunEnd as that would necessarily deadlock.\n//\n// - watchForChanges: If true, the default, then (a) the program will\n//   be killed and restarted if its source files change; (b) if\n//   something goes really wrong (bundling fails, the program crashes\n//   constantly) such that we give up, we will start trying again if\n//   the source files change. If false, then we don't do (a) and if\n//   (b) happens we just give up permanently.\n//\n// - noRestartBanner: Set to true to skip the banner that is normally\n//   printed after each restart of the app once it is ready to listen\n//   for connections.\n//\n// - Other options: port, mongoUrl, oplogUrl, buildOptions, rootUrl,\n//   settingsFile, program, proxy, recordPackageUsage, once\n//\n// To use, construct an instance of AppRunner, and then call start() to start it\n// running. To stop it, either return false from onRunEnd, or call stop().  (But\n// don't call stop() from inside onRunEnd: that causes a deadlock.)\n//\n// The 'result' argument to onRunEnd is an object with keys:\n//\n// - outcome: the reason the run ended. One of:\n//\n//   - 'terminated': the process exited. Additionally, a 'code'\n//     attribute will be set of the process exited on its own accord,\n//     a 'signal' attribute will be set if the process was killed on a\n//     signal, or neither will be set if the process could not be\n//     spawned (spawn call failed, or no such program in bundle) -- in\n//     this last case an explanation will have been written to the run\n//     log, and you may assume that it will take more than source code\n//     changes to fix the problem.\n//\n//   - 'bundle-fail': bundling failed.\n//\n//   - 'changed': watchForChanges was true and a source file changed.\n//\n//   - 'wrong-release': the release that this app targets does not\n//     match the currently running version of Meteor (eg, the user\n//     typed 'meteor update' in another window). An 'displayReleaseNeeded'\n//     attribute will be present giving the app's release name.\n//\n//   - 'conflicting-versions': the constraint solver could not find a set of\n//     package versions to use that would satisfy the constraints of\n//     .meteor/versions and .meteor/packages. This could be caused by conflicts\n//     in .meteor/versions, conflicts in .meteor/packages, and/or inconsistent\n//     changes to the dependencies in local packages.\n//\n//   - 'stopped': stop() was called while a run was in progress.\n//\n// - errors: for 'bundle-fail', the buildmessage messages object corresponding\n//      to the error\n//\n// - watchSet: for runs in which there's a reason to wait for file changes\n//      ('bundle-fail' and 'terminated'), the WatchSet to wait on.\nvar AppRunner = function (options) {\n  var self = this;\n\n  self.projectContext = options.projectContext;\n\n  // note: run-all.js updates port directly\n  self.port = options.port;\n  self.listenHost = options.listenHost;\n  self.mongoUrl = options.mongoUrl;\n  self.oplogUrl = options.oplogUrl;\n  self.buildOptions = options.buildOptions;\n  self.rootUrl = options.rootUrl;\n  self.mobileServerUrl = options.mobileServerUrl;\n  self.cordovaRunner = options.cordovaRunner;\n  self.settingsFile = options.settingsFile;\n  self.testMetadata = options.testMetadata;\n  self.inspect = options.inspect;\n  self.proxy = options.proxy;\n  self.autoRestart = !options.once;\n  self.watchForChanges =\n    options.watchForChanges === undefined ? true : options.watchForChanges;\n  self.onRunEnd = options.onRunEnd;\n  self.noRestartBanner = options.noRestartBanner;\n  self.recordPackageUsage =\n    options.recordPackageUsage === undefined ? true : options.recordPackageUsage;\n  self.omitPackageMapDeltaDisplayOnFirstRun =\n    options.omitPackageMapDeltaDisplayOnFirstRun;\n\n  self.fiber = null;\n  self.startPromise = null;\n  self.runPromise = null;\n  self.exitPromise = null;\n  self.watchPromise = null;\n  self._promiseResolvers = {};\n\n  // If this promise is set with self.makeBeforeStartPromise, then for the first\n  // run, we will wait on it just before self.appProcess.start() is called.\n  self._beforeStartPromise = null;\n\n  // Builders saved across rebuilds, so that targets can be re-written in\n  // place instead of created again from scratch.\n  self.builders = Object.create(null);\n};\n\n_.extend(AppRunner.prototype, {\n  // Start the app running, and restart it as necessary. Returns\n  // immediately.\n  start: function () {\n    var self = this;\n\n    if (self.fiber) {\n      throw new Error(\"already started?\");\n    }\n\n    self.startPromise = self._makePromise(\"start\");\n\n    self.fiber = Fiber(function () {\n      self._fiber();\n    });\n    self.fiber.run();\n\n    self.startPromise.await();\n    self.startPromise = null;\n  },\n\n  _makePromise: function (name) {\n    var self = this;\n    return new Promise(function (resolve) {\n      self._promiseResolvers[name] = resolve;\n    });\n  },\n\n  _resolvePromise: function (name, value) {\n    var resolve = this._promiseResolvers[name];\n    if (resolve) {\n      this._promiseResolvers[name] = null;\n      resolve(value);\n    }\n  },\n\n  _cleanUpPromises: function () {\n    if (this._promiseResolvers) {\n      _.each(this._promiseResolvers, function (resolve) {\n        resolve && resolve();\n      });\n      this._promiseResolvers = null;\n    }\n  },\n\n  // Shut down the app. stop() will block until the app is shut\n  // down. This may involve waiting for bundling to\n  // finish. Idempotent, however only one thread may be in stop() at a\n  // time.\n  stop: function () {\n    var self = this;\n\n    if (! self.fiber) {\n      // nothing to do\n      return;\n    }\n\n    if (self.exitPromise) {\n      throw new Error(\"another fiber already stopping?\");\n    }\n\n    // The existence of this promise makes the fiber break out of its loop.\n    self.exitPromise = self._makePromise(\"exit\");\n\n    self._resolvePromise(\"run\", { outcome: 'stopped' });\n    self._resolvePromise(\"watch\");\n\n    if (self._beforeStartPromise) {\n      // If we stopped before mongod started (eg, due to mongod startup\n      // failure), unblock the runner fiber from waiting for mongod to start.\n      self._resolvePromise(\"beforeStart\", true);\n    }\n\n    self.exitPromise.await();\n    self.exitPromise = null;\n  },\n\n  // Returns a function that can be called to resolve _beforeStartPromise.\n  makeBeforeStartPromise: function () {\n    if (this._beforeStartPromise) {\n      throw new Error(\"makeBeforeStartPromise called twice?\");\n    }\n    this._beforeStartPromise = this._makePromise(\"beforeStart\");\n    return this._promiseResolvers[\"beforeStart\"];\n  },\n\n  // Run the program once, wait for it to exit, and then return. The\n  // return value is same as onRunEnd.\n  _runOnce: function (options) {\n    var self = this;\n    options = options || {};\n    var firstRun = options.firstRun;\n\n    Console.enableProgressDisplay(true);\n\n    runLog.clearLog();\n    self.proxy.setMode(\"hold\");\n\n    // Bundle up the app\n    var bundlePath = self.projectContext.getProjectLocalDirectory('build');\n\n    // Cache the server target because the server will not change inside\n    // a single invocation of _runOnce().\n    var cachedServerWatchSet;\n\n    var bundleApp = function () {\n      if (! firstRun) {\n        // If the build fails in a way that could be fixed by a refresh, allow\n        // it even if we refreshed previously, since that might have been a\n        // little while ago.\n        catalog.triedToRefreshRecently = false;\n\n        // If this isn't the first time we've run, we need to reset the project\n        // context since everything we have cached may have changed.\n        // XXX We can try to be a little less conservative here:\n        // - Don't re-build the whole local catalog if we know which local\n        //   packages have changed.  (This one might be a little trickier due\n        //   to how the WatchSets are laid out.  Might be possible to avoid\n        //   re-building the local catalog at all if packages didn't change\n        //   at all, though.)\n        self.projectContext.reset({}, {\n          // Don't forget all Isopack objects; just make sure to check that they\n          // are up to date.\n          softRefreshIsopacks: true,\n          // Don't forget the package map we calculated last time, even if we\n          // didn't write it to disk (because, eg, we're not running with a\n          // release that matches the app's release).  While we will still check\n          // our constraints, we will use the map we calculated last time as the\n          // previous solution (not what's on disk). Package deltas should be\n          // shown from the previous solution.\n          preservePackageMap: true\n        });\n        var messages = buildmessage.capture(function () {\n          self.projectContext.readProjectMetadata();\n        });\n        if (messages.hasMessages()) {\n          return {\n            runResult: {\n              outcome: 'bundle-fail',\n              errors: messages,\n              watchSet: self.projectContext.getProjectAndLocalPackagesWatchSet()\n            }\n          };\n        }\n      }\n\n      // Check to make sure we're running the right version of Meteor.\n      var wrongRelease = ! release.usingRightReleaseForApp(self.projectContext);\n      if (wrongRelease) {\n        return {\n          runResult: {\n            outcome: 'wrong-release',\n            displayReleaseNeeded:\n              self.projectContext.releaseFile.displayReleaseName\n          }\n        };\n      }\n\n      messages = buildmessage.capture(function () {\n        self.projectContext.prepareProjectForBuild();\n      });\n      if (messages.hasMessages()) {\n        return {\n          runResult: {\n            outcome: 'bundle-fail',\n            errors: messages,\n            watchSet: self.projectContext.getProjectAndLocalPackagesWatchSet()\n          }\n        };\n      }\n\n      // Show package changes... unless it's the first time in test-packages.\n      if (!(self.omitPackageMapDeltaDisplayOnFirstRun && firstRun)) {\n        self.projectContext.packageMapDelta.displayOnConsole();\n      }\n\n      if (self.recordPackageUsage) {\n        stats.recordPackages({\n          what: \"sdk.run\",\n          projectContext: self.projectContext\n        });\n      }\n\n      var bundleResult = Profile.run((firstRun?\"B\":\"Reb\")+\"uild App\", () => {\n        return bundler.bundle({\n          projectContext: self.projectContext,\n          outputPath: bundlePath,\n          includeNodeModules: \"symlink\",\n          buildOptions: self.buildOptions,\n          hasCachedBundle: !! cachedServerWatchSet,\n          previousBuilders: self.builders,\n          // Permit delayed bundling of client architectures if the\n          // console is interactive.\n          allowDelayedClientBuilds: ! Console.isHeadless(),\n        });\n      });\n\n      // Keep the server watch set from the initial bundle, because subsequent\n      // bundles will not contain a server target.\n      if (cachedServerWatchSet) {\n        bundleResult.serverWatchSet = cachedServerWatchSet;\n      } else {\n        cachedServerWatchSet = bundleResult.serverWatchSet;\n      }\n\n      if (bundleResult.errors) {\n        return {\n          runResult: {\n            outcome: 'bundle-fail',\n            errors: bundleResult.errors,\n            watchSet: combinedWatchSetForBundleResult(bundleResult)\n          }\n        };\n      } else {\n        return { bundleResult: bundleResult };\n      }\n    };\n\n    var combinedWatchSetForBundleResult = function (br) {\n      var watchSet = br.serverWatchSet.clone();\n      watchSet.merge(br.clientWatchSet);\n      return watchSet;\n    };\n\n    var bundleResult;\n    var bundleResultOrRunResult = bundleApp();\n    if (bundleResultOrRunResult.runResult) {\n      return bundleResultOrRunResult.runResult;\n    }\n    bundleResult = bundleResultOrRunResult.bundleResult;\n\n    firstRun = false;\n\n    // Read the settings file, if any\n    var settings = null;\n    var settingsWatchSet = new watch.WatchSet;\n    var settingsMessages = buildmessage.capture({\n      title: \"preparing to run\",\n      rootPath: process.cwd()\n    }, function () {\n      if (self.settingsFile) {\n        settings = files.getSettings(self.settingsFile, settingsWatchSet);\n      }\n    });\n    if (settingsMessages.hasMessages()) {\n      return {\n        outcome: 'bundle-fail',\n        errors: settingsMessages,\n        watchSet: settingsWatchSet\n      };\n    }\n\n    var serverWatchSet = bundleResult.serverWatchSet;\n    serverWatchSet.merge(settingsWatchSet);\n\n    // We only can refresh the client without restarting the server if the\n    // client contains the 'autoupdate' package.\n    var canRefreshClient = self.projectContext.packageMap &&\n          self.projectContext.packageMap.getInfo('autoupdate');\n\n    if (! canRefreshClient) {\n      // Restart server on client changes if we can't refresh the client.\n      serverWatchSet = combinedWatchSetForBundleResult(bundleResult);\n    }\n\n    const cordovaRunner = self.cordovaRunner;\n    if (cordovaRunner) {\n      const pluginVersions =\n        pluginVersionsFromStarManifest(bundleResult.starManifest);\n\n      if (!cordovaRunner.started) {\n        const { settingsFile, mobileServerUrl } = self;\n        const messages = buildmessage.capture(() => {\n          cordovaRunner.prepareProject(bundlePath, pluginVersions,\n            { settingsFile, mobileServerUrl });\n        });\n\n        if (messages.hasMessages()) {\n          return {\n            outcome: 'bundle-fail',\n            errors: messages,\n            watchSet: combinedWatchSetForBundleResult(bundleResult)\n          };\n        }\n        cordovaRunner.printWarningsIfNeeded();\n      } else {\n        // If the set of Cordova platforms or plugins changes from one run\n        // to the next, we just exit, because we don't yet have a way to,\n        // for example, get the new plugins to the mobile clients or stop a\n        // running client on a platform that has been removed.\n\n        if (cordovaRunner.havePlatformsChangedSinceLastRun()) {\n          return { outcome: 'outdated-cordova-platforms' };\n        }\n\n        if (cordovaRunner.havePluginsChangedSinceLastRun(pluginVersions)) {\n          return { outcome: 'outdated-cordova-plugins' };\n        }\n      }\n    }\n\n    // Atomically (1) see if we've been stop()'d, (2) if not, create a\n    // promise that can be used to stop() us once we start running.\n    if (self.exitPromise) {\n      return { outcome: 'stopped' };\n    }\n\n    // We should have reset self.runPromise to null by now, but await it\n    // just in case it's still defined.\n    Promise.await(self.runPromise);\n\n    var runPromise = self.runPromise = self._makePromise(\"run\");\n    var listenPromise = self._makePromise(\"listen\");\n\n    // Run the program\n    options.beforeRun && options.beforeRun();\n    var appProcess = new AppProcess({\n      projectContext: self.projectContext,\n      bundlePath: bundlePath,\n      port: self.port,\n      listenHost: self.listenHost,\n      rootUrl: self.rootUrl,\n      mongoUrl: self.mongoUrl,\n      oplogUrl: self.oplogUrl,\n      mobileServerUrl: self.mobileServerUrl,\n      onExit: function (code, signal) {\n        self._resolvePromise(\"run\", {\n          outcome: 'terminated',\n          code: code,\n          signal: signal,\n          watchSet: combinedWatchSetForBundleResult(bundleResult)\n        });\n      },\n      inspect: self.inspect,\n      onListen: function () {\n        self.proxy.setMode(\"proxy\");\n        options.onListen && options.onListen();\n        self._resolvePromise(\"start\");\n        self._resolvePromise(\"listen\");\n      },\n      nodeOptions: getNodeOptionsFromEnvironment(),\n      settings: settings,\n      testMetadata: self.testMetadata,\n      autoRestart: self.autoRestart,\n    });\n\n    if (options.firstRun && self._beforeStartPromise) {\n      var stopped = self._beforeStartPromise.await();\n      if (stopped) {\n        return true;\n      }\n    }\n\n    appProcess.start();\n    function maybePrintLintWarnings(bundleResult) {\n      if (! (self.projectContext.lintAppAndLocalPackages &&\n             bundleResult.warnings)) {\n        return;\n      }\n      if (bundleResult.warnings.hasMessages()) {\n        const formattedMessages = bundleResult.warnings.formatMessages();\n        runLog.log(\n          `Linted your app.\\n\\n${ formattedMessages }`,\n          { arrow: true });\n      } else {\n        runLog.log('Linted your app. No linting errors.',\n                   { arrow: true });\n      }\n    }\n    maybePrintLintWarnings(bundleResult);\n\n    if (cordovaRunner && !cordovaRunner.started) {\n      cordovaRunner.startRunTargets();\n    }\n\n    // Start watching for changes for files if requested. There's no\n    // hurry to do this, since clientWatchSet contains a snapshot of the\n    // state of the world at the time of bundling, in the form of\n    // hashes and lists of matching files in each directory.\n    var serverWatcher;\n    var clientWatcher;\n\n    if (self.watchForChanges) {\n      serverWatcher = new watch.Watcher({\n        watchSet: serverWatchSet,\n        onChange: function () {\n          self._resolvePromise(\"run\", {\n            outcome: 'changed'\n          });\n        },\n        includePotentiallyUnusedFiles: false,\n        async: true,\n      });\n    }\n\n    var setupClientWatcher = function () {\n      clientWatcher && clientWatcher.stop();\n      clientWatcher = new watch.Watcher({\n        watchSet: bundleResult.clientWatchSet,\n        onChange: function () {\n          // Pass false for the includePotentiallyUnusedFiles parameter (which\n          // defaults to true) to avoid restarting the server due to changes in\n          // files that were not used by the server bundle. This assumes we have\n          // already called PackageSourceBatch.computeJsOutputFilesMap and\n          // _watchOutputFiles to finalize the usage statuses of potentially\n          // unused files in serverWatchSet, which is a safe assumption here.\n          var outcome = watch.isUpToDate(serverWatchSet, false)\n                      ? 'changed-refreshable' // only a client asset has changed\n                      : 'changed'; // both a client and server asset changed\n          self._resolvePromise('run', { outcome: outcome });\n        },\n        async: true\n      });\n    };\n    if (self.watchForChanges && canRefreshClient) {\n      setupClientWatcher();\n    }\n\n    function pauseClient(arch) {\n      return appProcess.proc.sendMessage(\"webapp-pause-client\", { arch });\n    }\n\n    async function refreshClient(arch) {\n      if (typeof arch === \"string\") {\n        // This message will reload the client program and unpause it.\n        await appProcess.proc.sendMessage(\"webapp-reload-client\", { arch });\n      }\n      // If arch is not a string, the receiver of this message should\n      // assume all clients need to be refreshed.\n      await appProcess.proc.sendMessage(\"client-refresh\");\n    }\n\n    function runPostStartupCallbacks(bundleResult) {\n      const callbacks = bundleResult.postStartupCallbacks;\n      if (! callbacks) return;\n\n      const messages = buildmessage.capture({\n        title: \"running post-startup callbacks\"\n      }, () => {\n        while (callbacks.length > 0) {\n          const fn = callbacks.shift();\n          try {\n            Promise.await(fn({\n              // Miscellany that the callback might find useful.\n              pauseClient,\n              refreshClient,\n              runLog,\n            }));\n          } catch (error) {\n            buildmessage.error(error.message);\n          }\n        }\n      });\n\n      if (messages.hasMessages()) {\n        return {\n          outcome: \"bundle-fail\",\n          errors: messages,\n          watchSet: bundleResult.clientWatchSet,\n        };\n      }\n    }\n\n    Console.enableProgressDisplay(false);\n\n    const postStartupResult = Promise.race([\n      listenPromise,\n      runPromise\n    ]).then(() => {\n      return runPostStartupCallbacks(bundleResult);\n    }).await();\n\n    if (postStartupResult) return postStartupResult;\n\n    // Wait for either the process to exit, or (if watchForChanges) a\n    // source file to change. Or, for stop() to be called.\n    var ret = runPromise.await();\n\n    try {\n      while (ret.outcome === 'changed-refreshable') {\n        if (! canRefreshClient) {\n          throw Error(\"Can't refresh client?\");\n        }\n\n        // We stay in this loop as long as only refreshable assets have changed.\n        // When ret.refreshable becomes false, we restart the server.\n        bundleResultOrRunResult = bundleApp();\n        if (bundleResultOrRunResult.runResult) {\n          return bundleResultOrRunResult.runResult;\n        }\n        bundleResult = bundleResultOrRunResult.bundleResult;\n\n        maybePrintLintWarnings(bundleResult);\n\n        runLog.logClientRestart();\n\n        var oldPromise = self.runPromise = self._makePromise(\"run\");\n\n        refreshClient();\n\n        // Establish a watcher on the new files.\n        setupClientWatcher();\n\n        const postStartupResult = runPostStartupCallbacks(bundleResult);\n        if (postStartupResult) return postStartupResult;\n\n        // Wait until another file changes.\n        ret = oldPromise.await();\n      }\n    } finally {\n      self.runPromise = null;\n\n      if (ret.outcome === 'changed') {\n        runLog.logTemporary(\"=> Server modified -- restarting...\");\n      }\n\n      self.proxy.setMode(\"hold\");\n      appProcess.stop();\n\n      serverWatcher && serverWatcher.stop();\n      clientWatcher && clientWatcher.stop();\n    }\n\n    return ret;\n  },\n\n  _fiber: function () {\n    var self = this;\n\n    var crashCount = 0;\n    var crashTimer = null;\n    var firstRun = true;\n\n    while (true) {\n\n      var resetCrashCount = function () {\n        crashTimer = setTimeout(function () {\n          crashCount = 0;\n        }, 8000);\n      };\n\n      var runResult = self._runOnce({\n        onListen: function () {\n          if (! self.noRestartBanner && ! firstRun) {\n            runLog.logRestart();\n            Console.enableProgressDisplay(false);\n          }\n        },\n        beforeRun: resetCrashCount,\n        firstRun: firstRun\n      });\n      firstRun = false;\n\n      clearTimeout(crashTimer);\n      if (runResult.outcome !== \"terminated\") {\n        crashCount = 0;\n      }\n\n      var wantExit = self.onRunEnd ? !self.onRunEnd(runResult) : false;\n      if (wantExit || self.exitPromise || runResult.outcome === \"stopped\") {\n        break;\n      }\n\n      if (runResult.outcome === \"wrong-release\" ||\n          runResult.outcome === \"conflicting-versions\") {\n        // Since the only implementation of onRunEnd sets wantExit on these\n        // outcomes, we will never get here currently. Moreover, it's not\n        // actually possible for us to handle these cases correctly, because our\n        // contract says that we should wait for changes, but runResult doesn't\n        // actually contain a watchset. Oops. Just throw an exception for now.\n        throw new Error(\"can't handle outcome \" + runResult.outcome);\n      }\n\n      else if (runResult.outcome === \"bundle-fail\") {\n        runLog.log(\"Errors prevented startup:\\n\\n\" +\n                        runResult.errors.formatMessages(),  { arrow: true });\n        if (self.watchForChanges) {\n          runLog.log(\"Your application has errors. \" +\n                     \"Waiting for file change.\",  { arrow: true });\n          Console.enableProgressDisplay(false);\n        }\n      }\n\n      else if (runResult.outcome === \"changed\") {\n        continue;\n      } else if (runResult.outcome === \"terminated\") {\n        if (runResult.signal) {\n          runLog.log('Exited from signal: ' + runResult.signal, { arrow: true });\n        } else if (runResult.code !== undefined) {\n          runLog.log('Exited with code: ' + runResult.code, { arrow: true });\n        } else {\n          // explanation should already have been logged\n        }\n\n        crashCount ++;\n        if (crashCount < 3) {\n          continue;\n        }\n\n        if (self.watchForChanges) {\n          runLog.log(\"Your application is crashing. \" +\n                     \"Waiting for file change.\",\n                     { arrow: true });\n          Console.enableProgressDisplay(false);\n        }\n      }\n\n      else {\n        throw new Error(\"unknown run outcome?\");\n      }\n\n      if (self.watchForChanges) {\n        self.watchPromise = self._makePromise(\"watch\");\n\n        if (!runResult.watchSet) {\n          throw Error(\"watching for changes with no watchSet?\");\n        }\n        // XXX reference to watcher is lost later?\n        var watcher = new watch.Watcher({\n          watchSet: runResult.watchSet,\n          onChange: function () {\n            self._resolvePromise(\"watch\");\n          }\n        });\n        self.proxy.setMode(\"errorpage\");\n        // If onChange wasn't called synchronously (clearing watchPromise), wait\n        // on it.\n        self.watchPromise && self.watchPromise.await();\n        // While we were waiting, did somebody stop() us?\n        if (self.exitPromise) {\n          break;\n        }\n        runLog.log(\"Modified -- restarting.\",  { arrow: true });\n        Console.enableProgressDisplay(true);\n        continue;\n      }\n\n      break;\n    }\n\n    // Allow the process to exit normally, since optimistic file watchers\n    // may be keeping the event loop busy.\n    closeAllWatchers();\n\n    // Giving up for good.\n    self._cleanUpPromises();\n\n    self.fiber = null;\n  }\n});\n\n///////////////////////////////////////////////////////////////////////////////\n\nexports.AppRunner = AppRunner;\n"],"file":"tools/runners/run-app.js.map"}