{"version":3,"sources":["/tools/isobuild/package-source.js"],"names":["_objectSpread","module1","link","default","v","Builder","SourceArch","PackageNamespace","PackageNpm","PackageCordova","PackageAPI","TEST_FILENAME_REGEXPS","APP_TEST_FILENAME_REGEXPS","isTestFilePath","convertColonsInPath","convert","optimisticReadFile","optimisticHashOrNull","optimisticStatOrNull","optimisticReadMeteorIgnore","optimisticLookupPackageJson","_","require","sourcemap","files","utils","watch","buildmessage","meteorNpm","archinfo","catalog","packageVersionParser","compiler","Profile","AUTO_TEST_PREFIX","isTestName","name","nameStart","slice","length","genTestName","loadOrderSort","sourceProcessorSet","arch","isTemplate","memoize","filename","classification","classifyFilename","type","sourceProcessors","Error","legacyIsTemplate","a","b","isTemplate_a","pathBasename","isTemplate_b","ismain_a","indexOf","ismain_b","islib_a","pathSep","islib_b","a_parts","split","b_parts","len_a","len_b","i","a_part","b_part","splitConstraint","c","parsed","parsePackageConstraint","package","constraint","constraintString","getExcerptFromReadme","text","commonmark","reader","DocParser","parse","relevantNodes","any","children","child","isHeader","t","push","isEmpty","textLines","start","start_line","stop","last","end_line","excerpt","join","replace","SymlinkLoopChecker","constructor","sourceRoot","_seenPaths","check","relDir","quietly","absPath","pathJoin","realPath","realpath","e","code","has","error","PackageSource","self","serveRoot","metadata","docsExplicitlyProvided","version","versionExplicitlyProvided","architectures","pluginInfo","pluginWatchSet","WatchSet","npmDependencies","npmDiscards","npmCacheDirectory","cordovaDependencies","testName","isTest","debugOnly","prodOnly","testOnly","includeTool","isCore","extend","prototype","initEmpty","initFromOptions","options","sources","ensureOnlyValidVersions","forCordova","isString","npmDir","map","source","relPath","sourceArch","kind","uses","use","getFiles","localNodeModulesDirs","_checkCrossUnibuildVersionConstraints","initFromPackageDir","dir","assertInCapture","isPortable","initFromPackageDirOptions","documentation","inCheckout","packDir","getCurrentToolsDir","pathDirname","exists","packageFileHashes","Object","create","packageJsPath","packageJsCode","pkgJsonPath","pkgJsonStat","isFile","watchPackageFiles","watchSet","each","hash","path","addFile","Package","Npm","Cordova","runJavaScript","toString","symbols","exception","_fileAndDepLoader","_dependencies","validatePackageName","versionParserError","message","api","buildingIsopackets","markBoundary","console","log","stack","ALL_ARCHES","assets","doNotDepOnSelf","dep","label","implies","releaseRecords","setFromRel","newConstraint","releaseRecord","packages","reduce","x","y","pathResolve","_discards","process","env","NO_METEOR_PACKAGE","alreadyDependsOnMeteor","find","u","unshift","result","relPathToSourceObj","forEach","_findSources","isApp","fileOptions","lazy","declaredExports","exports","_hasTests","_readAndWatchDirectory","include","exclude","names","readAndWatchDirectory","initFromAppDir","projectContext","ignoreFiles","appDir","projectDir","projectConstraintsFile","eachConstraint","projectWatchSet","getProjectWatchSet","mainModulesByArch","meteorConfig","getMainModulesByArch","testModulesByArch","getTestModulesByArch","nodeModulesToRecompileByArch","getNodeModulesToRecompileByArch","merge","platformList","getCordovaPlatforms","mainModule","getMainModule","testModule","getTestModule","nodeModulesToRecompile","getNodeModulesToRecompile","findOptions","missingMainModule","sort","_inferAppFileOptions","_findAssets","origAppDir","getOriginalAppDirForTestPackages","origNodeModulesDir","origNodeModulesStat","statOrNull","isDirectory","sourcePath","local","isAppTest","global","testCommandMetadata","isTestFile","dirs","matches","endsWith","bare","_findSourcesCache","Set","loopChecker","isWeb","sourceReadOptions","appReadDirectoryOptions","controlFiles","anyLevelExcludes","topLevelExcludes","nodeModulesReadOptions","concat","baseCacheKey","JSON","stringify","excludes","key","value","isRegExp","flags","makeCacheKey","dotMeteorIgnoreFiles","removeIgnoredFilesFrom","array","keys","ignoreDir","ignore","target","item","pathRelative","startsWith","ignores","depth","inNodeModules","cacheKey","absDir","readOptions","pkgJson","difference","subdirectories","nodeModulesDir","subdir","test","withCache","assetDir","assetDirs","isEqual","shift","substr","assetsAndSubdirs","normalize","containsPlugins","getDependencyMetadata","ret","_computeDependencyMetadata","logError","getPackagesToLoadFirst","packageMap","processUse","weak","unordered","isIsobuildFeaturePackage","packageInfo","getInfo","info","spec","parsedSpec","getExports","exp","arches","processReadme","assertInJob","fullReadme","readFile","err","errorMessage","contents","sha256","dependencies","allConstraints","failed","implied","skipWeak","skipUnordered","references","d","reference","withoutSpecificOs","partial","constraints","uniq","displayName","module"],"mappings":"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","sourcesContent":["var _ = require('underscore');\nvar sourcemap = require('source-map');\n\nvar files = require('../fs/files');\nvar utils = require('../utils/utils.js');\nvar watch = require('../fs/watch');\nvar buildmessage = require('../utils/buildmessage.js');\nvar meteorNpm = require('./meteor-npm.js');\nimport Builder from './builder.js';\nvar archinfo = require('../utils/archinfo');\nvar catalog = require('../packaging/catalog/catalog.js');\nvar packageVersionParser = require('../packaging/package-version-parser.js');\nvar compiler = require('./compiler.js');\nvar Profile = require('../tool-env/profile').Profile;\n\nimport SourceArch from './source-arch.js';\nimport { PackageNamespace } from \"./package-namespace.js\";\nimport { PackageNpm } from \"./package-npm.js\";\nimport { PackageCordova } from \"./package-cordova.js\";\nimport { PackageAPI } from \"./package-api.js\";\n\nimport {\n  TEST_FILENAME_REGEXPS,\n  APP_TEST_FILENAME_REGEXPS,\n  isTestFilePath,\n} from './test-files';\n\nimport {\n  convert as convertColonsInPath\n} from '../utils/colon-converter.js';\n\nimport {\n  optimisticReadFile,\n  optimisticHashOrNull,\n  optimisticStatOrNull,\n  optimisticReadMeteorIgnore,\n  optimisticLookupPackageJson,\n} from \"../fs/optimistic\";\n\n// XXX: This is a medium-term hack, to avoid having the user set a package name\n// & test-name in package.describe. We will change this in the new control file\n// world in some way.\nvar AUTO_TEST_PREFIX = \"local-test:\";\nvar isTestName = function (name) {\n  var nameStart = name.slice(0, AUTO_TEST_PREFIX.length);\n  return nameStart === AUTO_TEST_PREFIX;\n};\nvar genTestName = function (name) {\n  return AUTO_TEST_PREFIX + name;\n};\n\n// Returns a sort comparator to order files into load order.\nvar loadOrderSort = function (sourceProcessorSet, arch) {\n  const isTemplate = _.memoize((filename) => {\n    const classification = sourceProcessorSet.classifyFilename(filename, arch);\n    switch (classification.type) {\n    case 'extension':\n    case 'filename':\n      if (! classification.sourceProcessors) {\n        // This is *.js, not a template. #HardcodeJs\n        return false;\n      }\n      if (classification.sourceProcessors.length > 1) {\n        throw Error(\"conflicts in compiler?\");\n      }\n      return classification.sourceProcessors[0].isTemplate;\n\n    case 'legacy-handler':\n      return classification.legacyIsTemplate;\n\n    case 'wrong-arch':\n    case 'unmatched':\n    case 'meteor-ignore':\n      return false;\n\n    default:\n      throw Error(`surprising type ${classification.type} for ${filename}`);\n    }\n  });\n\n  return function (a, b) {\n    // XXX MODERATELY SIZED HACK --\n    // push template files ahead of everything else. this is\n    // important because the user wants to be able to say\n    //   Template.foo.events = { ... }\n    // in a JS file and not have to worry about ordering it\n    // before the corresponding .html file.\n    //\n    // maybe all of the templates should go in one file?\n    var isTemplate_a = isTemplate(files.pathBasename(a));\n    var isTemplate_b = isTemplate(files.pathBasename(b));\n    if (isTemplate_a !== isTemplate_b) {\n      return (isTemplate_a ? -1 : 1);\n    }\n\n    // main.* loaded last\n    var ismain_a = (files.pathBasename(a).indexOf('main.') === 0);\n    var ismain_b = (files.pathBasename(b).indexOf('main.') === 0);\n    if (ismain_a !== ismain_b) {\n      return (ismain_a ? 1 : -1);\n    }\n\n    // /lib/ loaded first\n    var islib_a = (a.indexOf(files.pathSep + 'lib' + files.pathSep) !== -1 ||\n                   a.indexOf('lib' + files.pathSep) === 0);\n    var islib_b = (b.indexOf(files.pathSep + 'lib' + files.pathSep) !== -1 ||\n                   b.indexOf('lib' + files.pathSep) === 0);\n    if (islib_a !== islib_b) {\n      return (islib_a ? -1 : 1);\n    }\n\n    var a_parts = a.split(files.pathSep);\n    var b_parts = b.split(files.pathSep);\n\n    // deeper paths loaded first.\n    var len_a = a_parts.length;\n    var len_b = b_parts.length;\n    if (len_a < len_b) {\n      return 1;\n    }\n    if (len_b < len_a) {\n      return -1;\n    }\n\n    // Otherwise compare path components lexicographically.\n    for (var i = 0; i < len_a; ++i) {\n      var a_part = a_parts[i];\n      var b_part = b_parts[i];\n      if (a_part < b_part) {\n        return -1;\n      }\n      if (b_part < a_part) {\n        return 1;\n      }\n    }\n\n    // Never reached unless there are somehow duplicate paths.\n    return 0;\n  };\n};\n\nvar splitConstraint = function (c) {\n  // XXX print error better (w/ buildmessage?)?\n  var parsed = utils.parsePackageConstraint(c);\n  return { package: parsed.package,\n           constraint: parsed.constraintString || null };\n};\n\n// Given the text of a README.md file, excerpts the text between the first and\n// second heading.\n//\n// Specifically - if there is text between the document name, and the first\n// subheading, it will take that text. If there is no text there, and only text\n// after the first subheading, it will take that text. It won't look any deeper\n// than that (in case the user intentionally wants to leave the section blank\n// for some reason). Skips lines that start with an exclamation point.\nvar getExcerptFromReadme = function (text) {\n  // Don't waste time parsing if the document is empty.\n  if (! text) {\n    return \"\";\n  }\n\n  // Split into lines with Commonmark.\n  var commonmark = require('commonmark');\n  var reader = new commonmark.DocParser();\n  var parsed = reader.parse(text);\n\n  // Commonmark will parse the Markdown into an array of nodes. These are the\n  // nodes that represent the text between the first and second heading.\n  var relevantNodes = [];\n\n  // Go through the document until we get the nodes that we are looking for,\n  // then stop.\n  _.any(parsed.children, function (child) {\n    var isHeader = (child.t === \"Header\");\n    // Don't excerpt anything before the first header.\n    if (! isHeader) {\n      // If we are currently in the middle of excerpting, continue doing that\n      // until we hit hit a header (and this is not a header). Otherwise, if\n      // this is text, we should begin to excerpt it.\n      relevantNodes.push(child);\n    } else if (! _.isEmpty(relevantNodes) && isHeader) {\n      // We have been excerpting, and came across a header. That means\n      // that we are done.\n      return true;\n    }\n    return false;\n  });\n\n  // If we have not found anything, we are done.\n  if (_.isEmpty(relevantNodes)) {\n    return \"\";\n  }\n\n  // For now, we will do the simple thing of just taking the raw markdown from\n  // the start of the excerpt to the end.\n  var textLines = text.split(\"\\n\");\n  var start = relevantNodes[0].start_line - 1;\n  var stop = _.last(relevantNodes).end_line;\n  // XXX: There is a bug in commonmark that happens when processing the last\n  // node in the document. Here is the github issue:\n  // https://github.com/jgm/CommonMark/issues/276\n  // Remove this workaround when the issue is fixed.\n  if (stop === _.last(parsed.children).end_line) {\n    stop++;\n  }\n  var excerpt = textLines.slice(start, stop).join(\"\\n\");\n\n  // Strip the preceeding and trailing new lines.\n  return excerpt.replace(/^\\n+|\\n+$/g, \"\");\n};\n\nclass SymlinkLoopChecker {\n  constructor(sourceRoot) {\n    this.sourceRoot = sourceRoot;\n    this._seenPaths = {};\n  }\n\n  check(relDir, quietly = true) {\n    const absPath = files.pathJoin(this.sourceRoot, relDir);\n\n    try {\n      var realPath = files.realpath(absPath);\n    } catch (e) {\n      if (!e || e.code !== 'ELOOP') {\n        throw e;\n      }\n      // else leave realPath undefined\n    }\n\n    if (! realPath || _.has(this._seenPaths, realPath)) {\n      if (! quietly) {\n        buildmessage.error(\"Symlink cycle detected at \" + relDir);\n      }\n\n      return true;\n    }\n\n    this._seenPaths[realPath] = true;\n\n    return false;\n  }\n}\n\n///////////////////////////////////////////////////////////////////////////////\n// PackageSource\n///////////////////////////////////////////////////////////////////////////////\n\nvar PackageSource = function () {\n  var self = this;\n\n  // The name of the package, or null for an app pseudo-package or\n  // collection. The package's exports will reside in Package.<name>.\n  // When it is null it is linked like an application instead of like\n  // a package.\n  self.name = null;\n\n  // The path relative to which all source file paths are interpreted\n  // in this package. Also used to compute the location of the\n  // package's .npm directory (npm shrinkwrap state).\n  self.sourceRoot = null;\n\n  // Path that will be prepended to the URLs of all resources emitted\n  // by this package (assuming they don't end up getting\n  // concatenated). For non-web targets, the only effect this will\n  // have is to change the actual on-disk paths of the files in the\n  // bundle, for those that care to open up the bundle and look (but\n  // it's still nice to get it right).\n  self.serveRoot = null;\n\n  // Package metadata. Keys are 'summary', 'git' and 'documentation'. Currently\n  // all of these are optional.\n  self.metadata = {};\n  self.docsExplicitlyProvided = false;\n\n  // Package version as a meteor-version string. Optional; not all packages\n  // (for example, the app) have versions.\n  // XXX when we have names, maybe we want to say that all packages\n  // with names have versions? certainly the reverse is true\n  self.version = null;\n  self.versionExplicitlyProvided = false;\n\n  // Available architectures of this package. Array of SourceArch.\n  self.architectures = [];\n\n  // The information necessary to build the plugins in this\n  // package. Map from plugin name to object with keys 'name', 'use',\n  // 'sources', and 'npmDependencies'.\n  self.pluginInfo = {};\n\n  // Analogous to watchSet in SourceArch but for plugins. At this\n  // stage will typically contain just 'package.js'.\n  self.pluginWatchSet = new watch.WatchSet;\n\n  // npm packages used by this package (on os.* architectures only).\n  // Map from npm package name to the required version of the package\n  // as a string.\n  self.npmDependencies = {};\n\n  // Files to be stripped from the installed NPM dependency tree. See the\n  // Npm.strip comment below for further usage information.\n  self.npmDiscards = null;\n\n  // Absolute path to a directory on disk that serves as a cache for\n  // the npm dependencies, so we don't have to fetch them on every\n  // build. Required not just if we have npmDependencies, but if we\n  // ever could have had them in the past.\n  self.npmCacheDirectory = null;\n\n  // cordova plugins used by this package (on os.* architectures only).\n  // Map from cordova plugin name to the required version of the package\n  // as a string.\n  self.cordovaDependencies = {};\n\n  // If this package has a corresponding test package (for example,\n  // underscore-test), defined in the same package.js file, store its value\n  // here.\n  self.testName = null;\n\n  // Test packages are dealt with differently in the linker (and not published\n  // to the catalog), so we need to keep track of them.\n  self.isTest = false;\n\n  // Some packages belong to a test framework and should never be bundled into\n  // production. A package with this flag should not be picked up by the bundler\n  // for production builds.\n  self.debugOnly = false;\n\n  // A package marked prodOnly is ONLY picked up by the bundler for production\n  // builds.\n  self.prodOnly = false;\n\n  // A package marked testOnly is ONLY picked up by the bundler as\n  // part of the `meteor test` command.\n  self.testOnly = false;\n\n  // If this is set, we will take the currently running git checkout and bundle\n  // the meteor tool from it inside this package as a tool. We will include\n  // built copies of all known isopackets.\n  self.includeTool = false;\n\n  // Is this a core package? Core packages don't record version files, because\n  // core packages are only ever run from checkout. For the preview release,\n  // core packages do not need to specify their versions at publication (since\n  // there isn't likely to be any exciting version skew yet), but we will\n  // specify the correct restrictions at 0.90.\n  // XXX: 0.90 package versions.\n  self.isCore = false;\n};\n\n\n_.extend(PackageSource.prototype, {\n  // Make a dummy (empty) packageSource that contains nothing of interest.\n  // XXX: Do we need this\n  initEmpty: function (name) {\n    var self = this;\n    self.name = name;\n  },\n\n  // Programmatically initialize a PackageSource from scratch.\n  //\n  // Unlike user-facing methods of creating a package\n  // (initFromPackageDir, initFromAppDir) this does not implicitly add\n  // a dependency on the 'meteor' package. If you want such a\n  // dependency then you must add it yourself.\n  //\n  // If called inside a buildmessage job, it will keep going if things\n  // go wrong. Be sure to call jobHasMessages to see if it actually\n  // succeeded.\n  //\n  // The architecture is hardcoded to be \"os\".\n  //\n  // Note that this does not set a version on the package!\n  //\n  // Options:\n  // - sourceRoot (required if sources present)\n  // - serveRoot (required if sources present)\n  // - use\n  // - sources (array of paths or relPath/fileOptions objects), note that this\n  // doesn't support assets at this time. If you want to pass assets here, you\n  // should add a new option to this function called `assets`.\n  // - npmDependencies\n  // - cordovaDependencies\n  // - npmDir\n  // - localNodeModulesDirs\n  initFromOptions: function (name, options) {\n    var self = this;\n    self.name = name;\n\n    if (options.sources && ! _.isEmpty(options.sources) &&\n        (! options.sourceRoot || ! options.serveRoot)) {\n      throw new Error(\"When source files are given, sourceRoot and \" +\n                      \"serveRoot must be specified\");\n    }\n\n    // sourceRoot is a relative file system path, one slash identifies a root\n    // relative to some starting location\n    self.sourceRoot = options.sourceRoot || files.pathSep;\n    // serveRoot is actually a part of a url path, root here is a forward slash\n    self.serveRoot = options.serveRoot || '/';\n\n    utils.ensureOnlyValidVersions(options.npmDependencies, {forCordova: false});\n    self.npmDependencies = options.npmDependencies;\n\n    // If options.npmDir is a string, make sure it contains no colons.\n    self.npmCacheDirectory = _.isString(options.npmDir)\n      ? convertColonsInPath(options.npmDir)\n      : options.npmDir;\n\n    utils.ensureOnlyValidVersions(options.cordovaDependencies, {forCordova: true});\n    self.cordovaDependencies = options.cordovaDependencies;\n\n    const sources = options.sources.map((source) => {\n      if (typeof source === \"string\") {\n        return {\n          relPath: source\n        };\n      }\n\n      return source;\n    });\n\n    const sourceArch = new SourceArch(self, {\n      kind: options.kind,\n      arch: \"os\",\n      sourceRoot: self.sourceRoot,\n      uses: _.map(options.use, splitConstraint),\n      getFiles() {\n        // TODO We might want to call _findSources here, if we want plugins to\n        // be able to import compiled files that were not explicitly included in\n        // the sources array passed to Package.registerBuildPlugin.\n        return {\n          sources: sources\n        }\n      }\n    });\n\n    if (options.localNodeModulesDirs) {\n      _.extend(sourceArch.localNodeModulesDirs,\n               options.localNodeModulesDirs);\n    }\n\n    self.architectures.push(sourceArch);\n\n    if (! self._checkCrossUnibuildVersionConstraints()) {\n      throw new Error(\"only one unibuild, so how can consistency check fail?\");\n    }\n  },\n\n  // Initialize a PackageSource from a package.js-style package directory. Uses\n  // the name field provided and the name/test fields in the package.js file to\n  // figre out if this is a test package (load from onTest) or a use package\n  // (load from onUse).\n  //\n  // name: name of the package.\n  // dir: location of directory on disk.\n  // options:\n  // - name: override the name of this package with a different name.\n  // - buildingIsopackets: true if this is being scanned in the process\n  //   of building isopackets\n  initFromPackageDir: Profile(\"PackageSource#initFromPackageDir\", function (dir, options) {\n    var self = this;\n    buildmessage.assertInCapture();\n    var isPortable = true;\n    options = options || {};\n    var initFromPackageDirOptions = options;\n\n    // If we know what package we are initializing, we pass in a\n    // name. Otherwise, we are intializing the base package specified by 'name:'\n    // field in Package.Describe. In that case, it is clearly not a test\n    // package. (Though we could be initializing a specific package without it\n    // being a test, for a variety of reasons).\n    if (options.name) {\n      self.isTest = isTestName(options.name);\n      self.name = options.name;\n    }\n\n    // Give the package a default version. We do not set\n    // versionExplicitlyProvided unless the package configuration file actually\n    // sets a version.\n    self.version = \"0.0.0\";\n\n    // To make the transition to using README.md files in Isobuild easier, we\n    // initialize the documentation directory to README.md by default.\n    self.metadata.documentation = \"README.md\";\n\n    self.sourceRoot = dir;\n\n    // If we are running from checkout we may be looking at a core package. If\n    // we are, let's remember this for things like not recording version files.\n    if (files.inCheckout()) {\n      var packDir = files.pathJoin(files.getCurrentToolsDir(), 'packages');\n      if (files.pathDirname(self.sourceRoot) === packDir) {\n        self.isCore = true;\n      }\n    }\n    if (! files.exists(self.sourceRoot)) {\n      throw new Error(\"putative package directory \" + dir + \" doesn't exist?\");\n    }\n\n    const packageFileHashes = Object.create(null);\n    const packageJsPath = files.pathJoin(self.sourceRoot, 'package.js');\n    const packageJsCode = optimisticReadFile(packageJsPath);\n    packageFileHashes[packageJsPath] =\n      optimisticHashOrNull(packageJsPath);\n\n    const pkgJsonPath = files.pathJoin(self.sourceRoot, 'package.json');\n    const pkgJsonStat = optimisticStatOrNull(pkgJsonPath);\n    if (pkgJsonStat &&\n        pkgJsonStat.isFile()) {\n      packageFileHashes[pkgJsonPath] =\n        optimisticHashOrNull(pkgJsonPath);\n    }\n\n    function watchPackageFiles(watchSet) {\n      _.each(packageFileHashes, (hash, path) => {\n        watchSet.addFile(path, hash);\n      });\n    }\n\n    // Any package that depends on us needs to be rebuilt if our package.js file\n    // changes, because a change to package.js might add or remove a plugin,\n    // which could change a file from being handled by plugin vs treated as\n    // an asset.\n    watchPackageFiles(self.pluginWatchSet);\n\n    /**\n     * @global\n     * @name  Package\n     * @summary The Package object in package.js\n     * @namespace\n     * @locus package.js\n     */\n    const Package = new PackageNamespace(this);\n\n    /**\n     * @namespace Npm\n     * @global\n     * @summary The Npm object in package.js and package source files.\n     */\n    const Npm = new PackageNpm();\n\n    /**\n     * @namespace Cordova\n     * @global\n     * @summary The Cordova object in package.js.\n     */\n    const Cordova = new PackageCordova();\n\n    try {\n      files.runJavaScript(packageJsCode.toString('utf8'), {\n        filename: 'package.js',\n        symbols: { Package, Npm, Cordova }\n      });\n    } catch (e) {\n      buildmessage.exception(e);\n\n      // Could be a syntax error or an exception. Recover by\n      // continuing as if package.js is empty. (Pressing on with\n      // whatever handlers were registered before the exception turns\n      // out to feel pretty disconcerting -- definitely violates the\n      // principle of least surprise.) Leave the metadata if we have\n      // it, though.\n      Package._fileAndDepLoader = null;\n      self.pluginInfo = {};\n      Npm._dependencies = null;\n      Cordova._dependencies = null;\n    }\n\n    // In the past, we did not require a Package.Describe.name field. So, it is\n    // possible that we are initializing a package that doesn't use it and\n    // expects us to be implicit about it.\n    if (!self.name) {\n      // For backwards-compatibility, we will take the package name from the\n      // directory of the package. That was what we used to do: in fact, we used\n      // to only do that.\n      self.name = files.pathBasename(dir);\n    }\n\n    // Check to see if our name is valid.\n\n    try {\n      utils.validatePackageName(self.name);\n    } catch (e) {\n      if (!e.versionParserError) {\n        throw e;\n      }\n      buildmessage.error(e.message);\n      // recover by ignoring\n    }\n\n    // We want the \"debug mode\" to be a property of the *bundle* operation\n    // (turning a set of packages, including the app, into a star), not the\n    // *compile* operation (turning a package source into an isopack). This is\n    // so we don't have to publish two versions of each package. But we have no\n    // way to mark a file in an isopack as being the result of running a plugin\n    // from a debugOnly dependency, and so there is no way to tell which files\n    // to exclude in production mode from a published package. Eventually, we'll\n    // add such a flag to the isopack format, but until then we'll sidestep the\n    // issue by disallowing build plugins in debugOnly packages.\n    if ((self.debugOnly || self.prodOnly || self.testOnly) && !_.isEmpty(self.pluginInfo)) {\n      buildmessage.error(\n        \"can't register build plugins in debugOnly, prodOnly or testOnly packages\");\n      // recover by ignoring\n    }\n\n    // For this old-style, onUse/onTest/where-based package, figure\n    // out its dependencies by calling its on_xxx functions and seeing\n    // what it does.\n    //\n    // We have a simple strategy. Call its on_xxx handler with no\n    // 'where', which is what happens when the package is added\n    // directly to an app, and see what files it adds to the client\n    // and the server. When a package is used, include it in both the client\n    // and the server by default. This simple strategy doesn't capture even\n    // 10% of the complexity possible with onUse, onTest, and where, but\n    // probably is sufficient for virtually all packages that actually\n    // exist in the field, if not every single one. #OldStylePackageSupport\n\n    var api = new PackageAPI({\n      buildingIsopackets: !! initFromPackageDirOptions.buildingIsopackets\n    });\n\n    if (Package._fileAndDepLoader) {\n      try {\n        buildmessage.markBoundary(Package._fileAndDepLoader)(api);\n      } catch (e) {\n        console.log(e.stack); // XXX should we keep this here -- or do we want broken\n                              // packages to fail silently?\n        buildmessage.exception(e);\n\n        // Recover by ignoring all of the source files in the\n        // packages and any remaining handlers. It violates the\n        // principle of least surprise to half-run a handler\n        // and then continue.\n        api.files = {};\n        _.each(compiler.ALL_ARCHES, function (arch) {\n          api.files[arch] = {\n            sources: [],\n            assets: []\n          };\n        });\n\n        Package._fileAndDepLoader = null;\n        self.pluginInfo = {};\n        Npm._dependencies = null;\n        Cordova._dependencies = null;\n      }\n    }\n\n    // By the way, you can't depend on yourself.\n    var doNotDepOnSelf = function (dep) {\n      if (dep.package === self.name) {\n        buildmessage.error(\"Circular dependency found: \"\n                           + self.name +\n                           \" depends on itself.\\n\");\n      }\n    };\n    _.each(compiler.ALL_ARCHES, function (label) {\n      _.each(api.uses[label], doNotDepOnSelf);\n      _.each(api.implies[label], doNotDepOnSelf);\n    });\n\n    // Cause packages that use `prodOnly` to automatically depend on the\n    // `isobuild:prod-only` feature package, which will cause an error\n    // when a package using `prodOnly` is run by a version of the tool\n    // that doesn't support the feature.  The choice of 'os' architecture\n    // is arbitrary, as the version solver combines the dependencies of all\n    // arches.\n    if (self.prodOnly) {\n      api.uses['os'].push({\n        package: 'isobuild:prod-only', constraint: '1.0.0'\n      });\n    }\n\n    // If we have specified some release, then we should go through the\n    // dependencies and fill in the unspecified constraints with the versions in\n    // the releases (if possible).\n    if (!_.isEmpty(api.releaseRecords)) {\n\n      // Given a dependency object with keys package (the name of the package)\n      // and constraint (the version constraint), if the constraint is null,\n      // look in the packages field in the release record and fill in from\n      // there.\n      var setFromRel = function (dep) {\n        if (dep.constraint) {\n          return dep;\n        }\n        var newConstraint = [];\n        _.each(api.releaseRecords, function (releaseRecord) {\n          var packages = releaseRecord.packages;\n          if(_.has(packages, dep.package)) {\n            newConstraint.push(packages[dep.package]);\n          }\n        });\n        if (_.isEmpty(newConstraint)) {\n          return dep;\n        }\n        dep.constraint = _.reduce(newConstraint,\n          function(x, y) {\n            return x + \" || \" + y;\n          });\n        return dep;\n      };\n\n      // For all api.implies and api.uses, fill in the unspecified dependencies from the\n      // release.\n      _.each(compiler.ALL_ARCHES, function (label) {\n        api.uses[label] = _.map(api.uses[label], setFromRel);\n        api.implies[label] = _.map(api.implies[label], setFromRel);\n      });\n     };\n\n    // Make sure that if a dependency was specified in multiple\n    // unibuilds, the constraint is exactly the same.\n    if (! self._checkCrossUnibuildVersionConstraints()) {\n      // A build error was written. Recover by ignoring the\n      // fact that we have differing constraints.\n    }\n\n    // Save information about npm dependencies. To keep metadata\n    // loading inexpensive, we won't actually fetch them until build\n    // time.\n\n    // We used to put the cache directly in .npm, but in linker-land,\n    // the package's own NPM dependencies go in .npm/package and build\n    // plugin X's goes in .npm/plugin/X. Notably, the former is NOT an\n    // ancestor of the latter, so that a build plugin does NOT see the\n    // package's node_modules.  XXX maybe there should be separate NPM\n    // dirs for use vs test?\n    self.npmCacheDirectory =\n      files.pathResolve(files.pathJoin(self.sourceRoot, '.npm', 'package'));\n    self.npmDependencies = Npm._dependencies;\n    self.npmDiscards = Npm._discards;\n\n    self.cordovaDependencies = Cordova._dependencies;\n\n    // Create source architectures, one for the server and one for each web\n    // arch.\n    _.each(compiler.ALL_ARCHES, function (arch) {\n      // Everything depends on the package 'meteor', which sets up\n      // the basic environment) (except 'meteor' itself).\n      if (self.name !== \"meteor\" && !process.env.NO_METEOR_PACKAGE) {\n        // Don't add the dependency if one already exists. This allows the\n        // package to create an unordered dependency and override the one that\n        // we'd add here. This is necessary to resolve the circular dependency\n        // between meteor and underscore (underscore has an unordered\n        // dependency on meteor dating from when the .js extension handler was\n        // in the \"meteor\" package).\n        var alreadyDependsOnMeteor =\n              !! _.find(api.uses[arch], function (u) {\n                return u.package === \"meteor\";\n              });\n        if (! alreadyDependsOnMeteor) {\n          api.uses[arch].unshift({ package: \"meteor\" });\n        }\n      }\n\n      // Each unibuild has its own separate WatchSet. This is so that, eg, a test\n      // unibuild's dependencies doesn't end up getting merged into the\n      // pluginWatchSet of a package that uses it: only the use unibuild's\n      // dependencies need to go there!\n      var watchSet = new watch.WatchSet();\n      watchPackageFiles(watchSet);\n\n      self.architectures.push(new SourceArch(self, {\n        kind: \"main\",\n        arch: arch,\n        sourceRoot: self.sourceRoot,\n        uses: api.uses[arch],\n        implies: api.implies[arch],\n        getFiles(sourceProcessorSet, watchSet) {\n          const result = api.files[arch];\n          const relPathToSourceObj = Object.create(null);\n          const sources = result.sources;\n\n          // Files explicitly passed to api.addFiles remain at the\n          // beginning of api.files[arch].sources in their given order.\n          sources.forEach(source => {\n            relPathToSourceObj[source.relPath] = source;\n          });\n\n          self._findSources({\n            sourceProcessorSet,\n            watchSet,\n            sourceArch: this,\n            isApp: false\n          }).forEach(relPath => {\n            const source = relPathToSourceObj[relPath];\n\n            if (source) {\n              const fileOptions = source.fileOptions ||\n                (source.fileOptions = Object.create(null));\n\n              // Since this file was explicitly added with api.addFiles or\n              // api.mainModule, it should be loaded eagerly unless the\n              // caller specified a boolean fileOptions.lazy value.\n              if (typeof fileOptions.lazy !== \"boolean\") {\n                fileOptions.lazy = false;\n              }\n\n            } else {\n              const fileOptions = Object.create(null);\n\n              // Since this file was not explicitly added with\n              // api.addFiles, it should not be evaluated eagerly.\n              fileOptions.lazy = true;\n\n              sources.push(relPathToSourceObj[relPath] = {\n                relPath,\n                fileOptions,\n              });\n            }\n          });\n\n          return result;\n        },\n        declaredExports: api.exports[arch],\n        watchSet: watchSet\n      }));\n    });\n\n    // Serve root of the package.\n    self.serveRoot = files.pathJoin('/packages/', self.name);\n\n    // Name of the test.\n    if (Package._hasTests) {\n      self.testName = genTestName(self.name);\n    }\n  }),\n\n  _readAndWatchDirectory(relDir, watchSet, {include, exclude, names}) {\n    return watch.readAndWatchDirectory(watchSet, {\n      absPath: files.pathJoin(this.sourceRoot, relDir),\n      include, exclude, names\n    }).map(name => files.pathJoin(relDir, name));\n  },\n\n  // Initialize a package from an application directory (has .meteor/packages).\n  initFromAppDir: Profile(\"initFromAppDir\", function (projectContext, ignoreFiles) {\n    var self = this;\n    var appDir = projectContext.projectDir;\n    self.name = null;\n    self.sourceRoot = appDir;\n    self.serveRoot = '/';\n\n    // Determine used packages. Note that these are the same for all arches,\n    // because there's no way to specify otherwise in .meteor/packages.\n    var uses = [];\n    projectContext.projectConstraintsFile.eachConstraint(function (constraint) {\n      uses.push({ package: constraint.package,\n                  constraint: constraint.constraintString });\n    });\n\n    const projectWatchSet = projectContext.getProjectWatchSet();\n\n    const mainModulesByArch =\n      projectContext.meteorConfig.getMainModulesByArch();\n\n    const testModulesByArch =\n      projectContext.meteorConfig.getTestModulesByArch();\n\n    const nodeModulesToRecompileByArch =\n      projectContext.meteorConfig.getNodeModulesToRecompileByArch();\n\n    projectWatchSet.merge(projectContext.meteorConfig.watchSet);\n\n    _.each(compiler.ALL_ARCHES, function (arch) {\n      // We don't need to build a Cordova SourceArch if there are no Cordova\n      // platforms.\n      if (arch === 'web.cordova' &&\n          _.isEmpty(projectContext.platformList.getCordovaPlatforms())) {\n        return;\n      }\n\n      const mainModule = projectContext.meteorConfig\n        .getMainModule(arch, mainModulesByArch);\n\n      const testModule = projectContext.meteorConfig\n        .getTestModule(arch, testModulesByArch);\n\n      const nodeModulesToRecompile = projectContext.meteorConfig\n        .getNodeModulesToRecompile(arch, nodeModulesToRecompileByArch);\n\n      // XXX what about /web.browser/* etc, these directories could also\n      // be for specific client targets.\n\n      // Create unibuild\n      var sourceArch = new SourceArch(self, {\n        kind: 'app',\n        arch: arch,\n        sourceRoot: self.sourceRoot,\n        uses: uses,\n        getFiles(sourceProcessorSet, watchSet) {\n          sourceProcessorSet.watchSet = watchSet;\n\n          const findOptions = {\n            sourceProcessorSet,\n            watchSet,\n            sourceArch: this,\n            ignoreFiles,\n            isApp: true,\n            testModule,\n            nodeModulesToRecompile,\n          };\n\n          // If this architecture has a mainModule defined in\n          // package.json, it's an error if _findSources doesn't find that\n          // module. If no mainModule is defined, anything goes.\n          let missingMainModule = !! mainModule;\n\n          const sources = self._findSources(findOptions).sort(\n            loadOrderSort(sourceProcessorSet, arch)\n          ).map(relPath => {\n            if (relPath === mainModule) {\n              missingMainModule = false;\n            }\n\n            const fileOptions = self._inferAppFileOptions(relPath, {\n              arch,\n              mainModule,\n              testModule,\n            });\n\n            return {\n              relPath,\n              fileOptions,\n            };\n          });\n\n          if (missingMainModule) {\n            buildmessage.error([\n              \"Could not find mainModule for '\" + arch + \"' architecture: \" + mainModule,\n              'Check the \"meteor\" section of your package.json file?'\n            ].join(\"\\n\"));\n          }\n\n          const assets = self._findAssets(findOptions);\n\n          return {\n            sources,\n            assets,\n          };\n        }\n      });\n\n      const origAppDir = projectContext.getOriginalAppDirForTestPackages();\n\n      const origNodeModulesDir = origAppDir &&\n        files.pathJoin(origAppDir, \"node_modules\");\n\n      const origNodeModulesStat = origNodeModulesDir &&\n        files.statOrNull(origNodeModulesDir);\n\n      if (origNodeModulesStat &&\n          origNodeModulesStat.isDirectory()) {\n        sourceArch.localNodeModulesDirs[\"node_modules\"] = {\n          // Override these properties when calling\n          // addNodeModulesDirectory in compileUnibuild.\n          sourceRoot: origAppDir,\n          sourcePath: origNodeModulesDir,\n          local: false,\n        };\n      }\n\n      self.architectures.push(sourceArch);\n\n      // sourceArch's WatchSet should include all the project metadata files\n      // read by the ProjectContext.\n      sourceArch.watchSet.merge(projectWatchSet);\n    });\n\n    if (! self._checkCrossUnibuildVersionConstraints()) {\n      // should never happen since we created the unibuilds from\n      // .meteor/packages, which doesn't have a way to express\n      // different constraints for different unibuilds\n      throw new Error(\"conflicting constraints in a package?\");\n    }\n  }),\n\n  _inferAppFileOptions(relPath, {\n    arch,\n    mainModule,\n    testModule,\n  }) {\n    const fileOptions = Object.create(null);\n    const {\n      isTest = false,\n      isAppTest = false,\n    } = global.testCommandMetadata || {};\n\n    let isTestFile = false;\n    if (isTest || isAppTest) {\n      if (typeof testModule === \"undefined\") {\n        // If a testModule was not configured in the \"meteor\" section of\n        // package.json for this architecture, then isTestFilePath should\n        // determine whether this file loads eagerly.\n        isTestFile = isTestFilePath(relPath);\n      } else if (relPath === testModule) {\n        // If testModule is a string === relPath, then it is the entry\n        // point for tests, and should be loaded eagerly.\n        isTestFile = true;\n        fileOptions.lazy = false;\n        fileOptions.testModule = true;\n      } else {\n        // If testModule was defined but !== relPath, this file should not\n        // be loaded eagerly during tests. Setting fileOptions.testModule\n        // to false indicates that a testModule was configured, but this\n        // was not it. ResourceSlot#_isLazy (in compiler-plugin.js) will\n        // use this information (together with fileOptions.mainModule) to\n        // make the final call as to whether this file should be loaded\n        // eagerly or lazily.\n        isTestFile = false;\n        fileOptions.testModule = false;\n      }\n    }\n\n    // If running in test mode (`meteor test`), all files other than\n    // test files should be loaded lazily.\n    if (isTest && ! isTestFile) {\n      fileOptions.lazy = true;\n      // Ignore any meteor.mainModule that was specified, since we're\n      // running `meteor test` without the --full-app option.\n      mainModule = void 0;\n    }\n\n    const dirs = files.pathDirname(relPath).split(files.pathSep);\n\n    for (var i = 0; i < dirs.length; ++i) {\n      let dir = dirs[i];\n\n      if (dir === \"node_modules\") {\n        fileOptions.lazy = true;\n\n        // We used to disable transpilation for modules within node_modules,\n        // mostly for build performance reasons, but now that we have a lazy\n        // compilation system, we no longer need to worry about build times\n        // for unused modules, which unlocks opportunities such as compiling\n        // ECMAScript import/export syntax in npm packages.\n        // fileOptions.transpile = false;\n\n        // Return immediately so that we don't apply special meanings to\n        // client or server directories inside node_modules directories.\n        return fileOptions;\n      }\n\n      // Files in `imports/` and `tests/` directories should be lazily\n      // loaded *apart* from tests.\n      if ((dir === \"imports\" || dir === \"tests\") && ! isTestFile) {\n        fileOptions.lazy = true;\n      }\n\n      // If the file is restricted to the opposite architecture, make sure\n      // it is not evaluated eagerly.\n      if (archinfo.matches(arch, \"os\")) {\n        if (dir === \"client\") {\n          fileOptions.lazy = true;\n        }\n      } else if (dir === \"server\") {\n        fileOptions.lazy = true;\n      }\n\n      // Special case: in app code on the client, JavaScript files in a\n      // `client/compatibility` directory don't get wrapped in a closure.\n      if (i > 0 &&\n          dirs[i - 1] === \"client\" &&\n          dir === \"compatibility\" &&\n          archinfo.matches(arch, \"web\") &&\n          relPath.endsWith(\".js\")) {\n        fileOptions.bare = true;\n      }\n    }\n\n    if (typeof mainModule !== \"undefined\") {\n      // Note: if mainModule === false, no JavaScript modules will be\n      // loaded eagerly unless explicitly added with !fileOptions.lazy by\n      // a compiler plugin. This can be useful for building an app that\n      // does not run any application JS on the client (or the server). Of\n      // course, Meteor packages may still run JS on startup, but they\n      // have their own rules for lazy/eager loading of modules.\n      if (relPath === mainModule) {\n        fileOptions.lazy = false;\n        fileOptions.mainModule = true;\n      } else {\n        // Used in ResourceSlot#_isLazy (in compiler-plugin.js) to make a\n        // final determination of whether the file should be lazy.\n        fileOptions.mainModule = false;\n      }\n    }\n\n    return fileOptions;\n  },\n\n  // This cache survives for the duration of the process, and stores the\n  // complete list of source files for directories within node_modules.\n  _findSourcesCache: Object.create(null),\n\n  _findSources: Profile(\"PackageSource#_findSources\", function ({\n    sourceProcessorSet,\n    watchSet,\n    isApp,\n    sourceArch,\n    testModule,\n    nodeModulesToRecompile = new Set,\n    loopChecker = new SymlinkLoopChecker(this.sourceRoot),\n    ignoreFiles = []\n  }) {\n    const self = this;\n    const arch = sourceArch.arch;\n    const isWeb = archinfo.matches(arch, \"web\");\n    const sourceReadOptions =\n      sourceProcessorSet.appReadDirectoryOptions(arch);\n\n    // Adding, removing, or modifying a .meteorignore file should trigger\n    // a rebuild with the new rules applied.\n    sourceReadOptions.names.push(\".meteorignore\");\n\n    // Ignore files starting with dot (unless they are explicitly in\n    // sourceReadOptions.names, e.g. .meteorignore, added above).\n    sourceReadOptions.exclude.push(/^\\./);\n\n    // Ignore the usual ignorable files.\n    sourceReadOptions.exclude.push(...ignoreFiles);\n\n    // Read top-level source files, excluding control files that were not\n    // explicitly included.\n    const controlFiles = ['mobile-config.js'];\n\n    if (! isApp) {\n      controlFiles.push('package.js');\n    }\n\n    const anyLevelExcludes = [];\n\n    if (testModule || !isApp) {\n      // If we have a meteor.testModule from package.json, then we don't\n      // need to exclude tests/ directories or *.tests.js files from the\n      // search, because we trust meteor.testModule to identify a single\n      // test entry point. Likewise, in packages (!isApp), test files are\n      // added explicitly, and thus do not need to be excluded here.\n    } else {\n      anyLevelExcludes.push(/^tests\\/$/);\n\n      const {\n        isTest = false,\n        isAppTest = false,\n      } = global.testCommandMetadata || {};\n\n      if (isTest || isAppTest) {\n        // If we're running `meteor test` without the --full-app option,\n        // ignore app-test-only files like *.app-tests.js.\n        if (! isAppTest) {\n          sourceReadOptions.exclude.push(\n            ...APP_TEST_FILENAME_REGEXPS,\n          );\n        }\n\n        // If we're running `meteor test` with the --full-app option,\n        // ignore non-app-test files like *.tests.js. The wisdom of this\n        // behavior is debatable, since you might want to run non-app\n        // tests even when you're using the --full-app option, but it's\n        // legacy behavior at this point, and it doesn't matter if you're\n        // using meteor.testModule anyway (recommended).\n        if (! isTest) {\n          sourceReadOptions.exclude.push(\n            ...TEST_FILENAME_REGEXPS,\n          );\n        }\n\n      } else {\n        // If we're not running `meteor test` (and meteor.testModule is\n        // not defined in package.json), ignore all test files.\n        sourceReadOptions.exclude.push(\n          ...APP_TEST_FILENAME_REGEXPS,\n          ...TEST_FILENAME_REGEXPS,\n        );\n      }\n    }\n\n    if (isApp) {\n      // In the app, server/ directories are ignored by client builds, and\n      // client/ directories are ignored by server builds. In packages,\n      // these directories should not matter (#10393).\n      anyLevelExcludes.push(\n        archinfo.matches(arch, \"os\")\n          ? /^client\\/$/\n          : /^server\\/$/\n      );\n    }\n\n    anyLevelExcludes.push(\n      ...sourceReadOptions.exclude,\n    );\n\n    const topLevelExcludes = isApp ? [\n      ...anyLevelExcludes,\n      /^packages\\/$/,\n      /^programs\\/$/,\n      /^public\\/$/, /^private\\/$/,\n      /^cordova-build-override\\/$/,\n      /^acceptance-tests\\/$/,\n    ] : anyLevelExcludes;\n\n    const nodeModulesReadOptions = {\n      ...sourceReadOptions,\n      // When we're in a node_modules directory, we can avoid collecting\n      // .js and .json files, because (unlike .less or .coffee files) they\n      // are allowed to be imported later by the ImportScanner, as they do\n      // not require custom processing by compiler plugins.\n      exclude: sourceReadOptions.exclude.concat(/\\.js(on)?$/i),\n    };\n\n    const baseCacheKey = JSON.stringify({\n      isApp,\n      arch,\n      sourceRoot: self.sourceRoot,\n      excludes: anyLevelExcludes,\n    }, (key, value) => {\n      if (_.isRegExp(value)) {\n        return [value.source, value.flags];\n      }\n      return value;\n    });\n\n    function makeCacheKey(dir) {\n      return baseCacheKey + \"\\0\" + dir;\n    }\n\n    const dotMeteorIgnoreFiles = Object.create(null);\n\n    function removeIgnoredFilesFrom(array) {\n      Object.keys(dotMeteorIgnoreFiles).forEach(ignoreDir => {\n        const ignore = dotMeteorIgnoreFiles[ignoreDir];\n        let target = 0;\n\n        array.forEach(item => {\n          let relPath = files.pathRelative(ignoreDir, item);\n\n          if (! relPath.startsWith(\"..\")) {\n            if (item.endsWith(\"/\")) {\n              // The trailing slash is discarded by files.pathRelative.\n              relPath += \"/\";\n            }\n\n            if (ignore.ignores(relPath)) {\n              return;\n            }\n          }\n\n          array[target++] = item;\n        });\n\n        array.length = target;\n      });\n\n      return array;\n    }\n\n    function find(dir, depth, inNodeModules) {\n      // Remove trailing slash.\n      dir = dir.replace(/\\/$/, \"\");\n\n      // If we're in a node_modules directory, cache the results of the\n      // find function for the duration of the process.\n      let cacheKey = inNodeModules && makeCacheKey(dir);\n      if (cacheKey &&\n          cacheKey in self._findSourcesCache) {\n        return self._findSourcesCache[cacheKey];\n      }\n\n      if (loopChecker.check(dir)) {\n        // Pretend we found no files.\n        return [];\n      }\n\n      const absDir = files.pathJoin(self.sourceRoot, dir);\n      if (! inNodeModules) {\n        const ignore = optimisticReadMeteorIgnore(absDir);\n        if (ignore) {\n          dotMeteorIgnoreFiles[dir] = ignore;\n        }\n      }\n\n      let readOptions = sourceReadOptions;\n      if (inNodeModules) {\n        const pkgJson = optimisticLookupPackageJson(self.sourceRoot, dir);\n        if (pkgJson && nodeModulesToRecompile.has(pkgJson.name)) {\n          // Avoid caching node_modules code recompiled by Meteor.\n          cacheKey = false;\n        } else {\n          readOptions = nodeModulesReadOptions;\n        }\n      }\n\n      const sources = _.difference(\n        self._readAndWatchDirectory(dir, watchSet, readOptions),\n        depth > 0 ? [] : controlFiles\n      );\n\n      const subdirectories = self._readAndWatchDirectory(dir, watchSet, {\n        include: [/\\/$/],\n        exclude: depth > 0\n          ? anyLevelExcludes\n          : topLevelExcludes\n      });\n\n      removeIgnoredFilesFrom(sources);\n      removeIgnoredFilesFrom(subdirectories);\n\n      let nodeModulesDir;\n\n      subdirectories.forEach(subdir => {\n        if (/(^|\\/)node_modules\\/$/.test(subdir)) {\n          // Defer handling node_modules until after we handle all other\n          // subdirectories, so that we know whether we need to descend\n          // further. If sources is still empty after we handle everything\n          // else in dir, then nothing in this node_modules subdir can be\n          // imported by anthing outside of it, so we can ignore it.\n          nodeModulesDir = subdir;\n\n          // A \"local\" node_modules directory is one that's managed by the\n          // application developer using npm, rather than by Meteor using\n          // Npm.depends, which is available only in Meteor packages, and\n          // installs its dependencies into .npm/*/node_modules. Local\n          // node_modules directories may contain other nested node_modules\n          // directories, but we care about recording only the top-level\n          // node_modules directories here (hence !inNodeModules).\n          if (!inNodeModules && (isApp || !subdir.startsWith(\".npm/\"))) {\n            sourceArch.localNodeModulesDirs[subdir] = true;\n          }\n\n        } else {\n          sources.push(...find(subdir, depth + 1, inNodeModules));\n        }\n      });\n\n      if (nodeModulesDir && (!inNodeModules || sources.length > 0)) {\n        // If we found a node_modules subdirectory above, and either we\n        // are not already inside another node_modules directory or we\n        // found source files elsewhere in this directory or its other\n        // subdirectories, continue searching this node_modules directory,\n        // so that any non-.js(on) files it contains can be imported by\n        // the app (#6037).\n        sources.push(...find(nodeModulesDir, depth + 1, true));\n      }\n\n      delete dotMeteorIgnoreFiles[dir];\n\n      if (cacheKey) {\n        self._findSourcesCache[cacheKey] = sources;\n      }\n\n      return sources;\n    }\n\n    return files.withCache(() => find(\"\", 0, false));\n  }),\n\n  _findAssets({\n    sourceProcessorSet,\n    watchSet,\n    isApp,\n    sourceArch,\n    loopChecker = new SymlinkLoopChecker(this.sourceRoot),\n    ignoreFiles = [],\n  }) {\n    // Now look for assets for this unibuild.\n    const arch = sourceArch.arch;\n    const assetDir = archinfo.matches(arch, \"web\") ? \"public/\" : \"private/\";\n    var assetDirs = this._readAndWatchDirectory('', watchSet, {\n      names: [assetDir]\n    });\n\n    const assets = [];\n\n    if (!_.isEmpty(assetDirs)) {\n      if (!_.isEqual(assetDirs, [assetDir])) {\n        throw new Error(\"Surprising assetDirs: \" + JSON.stringify(assetDirs));\n      }\n\n      while (!_.isEmpty(assetDirs)) {\n        var dir = assetDirs.shift();\n        // remove trailing slash\n        dir = dir.substr(0, dir.length - 1);\n\n        if (loopChecker.check(dir)) {\n          // pretend we found no files\n          return [];\n        }\n\n        // Find asset files in this directory.\n        var assetsAndSubdirs = this._readAndWatchDirectory(dir, watchSet, {\n          include: [/.?/],\n          // we DO look under dot directories here\n          exclude: ignoreFiles\n        });\n\n        _.each(assetsAndSubdirs, function (item) {\n          if (item[item.length - 1] === '/') {\n            // Recurse on this directory.\n            assetDirs.push(item);\n          } else {\n            // This file is an asset. Make sure filenames are Unicode\n            // normalized.\n            assets.push({\n              relPath: item.normalize('NFC')\n            });\n          }\n        });\n      }\n    }\n\n    return assets;\n  },\n\n  // True if the package defines any plugins.\n  containsPlugins: function () {\n    var self = this;\n    return ! _.isEmpty(self.pluginInfo);\n  },\n\n  // Return dependency metadata for all unibuilds, in the format needed\n  // by the package catalog.\n  //\n  // This *DOES* include isobuild:* pseudo-packages!\n  //\n  // Options:\n  // - logError: if true, if something goes wrong, log a buildmessage\n  //   and return null rather than throwing an exception.\n  // - skipWeak: omit weak dependencies\n  // - skipUnordered: omit unordered dependencies\n  getDependencyMetadata: function (options) {\n    var self = this;\n    options = options || {};\n    var ret = self._computeDependencyMetadata(options);\n    if (! ret) {\n      if (options.logError) {\n        return null;\n      } else {\n        throw new Error(\"inconsistent dependency constraint across unibuilds?\");\n      }\n    }\n    return ret;\n  },\n\n  // Returns a list of package names which should be loaded before building this\n  // package. This is all the packages that we directly depend on in a unibuild\n  // or from a plugin.\n  //\n  // (It's possible that we could do something slightly fancier where we only\n  // need to load those dependencies (including implied dependencies) which we\n  // know contain plugins first, plus the transitive closure of all the packages\n  // we depend on which contain a plugin. This seems good enough, though.)\n  //\n  // Note that this method filters out isobuild:* pseudo-packages, so it is NOT\n  // to be used to create input to Version Solver (see\n  // _computeDependencyMetadata for that).\n  //\n  // Note also that \"load\" here specifically means \"load into the IsopackCache\n  // at build time\", not \"load into a running Meteor app at run\n  // time\". Specifically, weak constraints do create a run-time load order\n  // dependency (if the package is in the app at all) but they do not create a\n  // build-time IsopackCache load order dependency (because weak dependencies do\n  // not provide plugins).\n  getPackagesToLoadFirst: function (packageMap) {\n    var self = this;\n    var packages = {};\n    var processUse = function (use) {\n      // We don't have to build weak or unordered deps first (eg they can't\n      // contribute to a plugin).\n      if (use.weak || use.unordered) {\n        return;\n      }\n      // Only include real packages, not isobuild:* pseudo-packages.\n      if (compiler.isIsobuildFeaturePackage(use.package)) {\n        return;\n      }\n\n      var packageInfo = packageMap.getInfo(use.package);\n      if (! packageInfo) {\n        throw Error(\"Depending on unknown package \" + use.package);\n      }\n      packages[use.package] = true;\n    };\n\n    _.each(self.architectures, function (arch) {\n      // We need to iterate over both uses and implies, since implied packages\n      // also constitute dependencies. We don't have to include the dependencies\n      // of implied packages directly here, since their own\n      // getPackagesToLoadFirst will include those.\n      _.each(arch.uses, processUse);\n      _.each(arch.implies, processUse);\n    });\n\n    _.each(self.pluginInfo, function (info) {\n      // info.use is currently just an array of strings, and there's\n      // no way to specify weak/unordered. Much like an app.\n      _.each(info.use, function (spec) {\n        var parsedSpec = splitConstraint(spec);\n        if (! compiler.isIsobuildFeaturePackage(parsedSpec.package)) {\n          packages[parsedSpec.package] = true;\n        }\n      });\n    });\n    return _.keys(packages);\n  },\n\n  // Returns an array of objects, representing this package's public\n  // exports. Each object has the following keys:\n  //  - name: export name (ex: \"Accounts\")\n  //  - arch: an array of strings representing architectures for which this\n  //    export is declared.\n  //\n  // This ignores testOnly exports.\n  getExports: function () {\n    var self = this;\n    var ret = {};\n    // Go over all of the architectures, and aggregate the exports together.\n    _.each(self.architectures, function (arch) {\n      _.each(arch.declaredExports, function (exp) {\n        // Skip testOnly exports -- the flag is intended for use in testing\n        // only, so it is not of any interest outside this package.\n        if (exp.testOnly) {\n          return;\n        }\n        // Add the export to the export map.\n        if (! _.has(ret, exp.name)) {\n          ret[exp.name] = [arch.arch];\n        } else {\n          ret[exp.name].push(arch.arch);\n        }\n     });\n    });\n    return _.map(ret, function (arches, name) {\n      return { name: name, architectures: arches };\n    });\n   },\n\n  // Processes the documentation provided in Package.describe. Returns an object\n  // with the following keys:\n  //   - path: full filepath to the Readme file\n  //   - excerpt: the subsection between the first and second heading of the\n  //     Readme, to be used as a longform package description.\n  //   - hash: hash of the full text of this Readme, or \"\" if the Readme is\n  //     blank.\n  //\n  // Returns null if the documentation is marked as null, or throws a\n  // buildmessage error if the documentation could not be read.\n  //\n  // This function reads and performs string operations on a (potentially) long\n  // file. We do not call it unless we actually need this information.\n  processReadme: function () {\n    var self = this;\n    buildmessage.assertInJob();\n    if (! self.metadata.documentation) {\n      return null;\n    }\n\n    // To ensure atomicity, we want to copy the README to a temporary file.\n    var ret = {};\n    ret.path =\n      files.pathJoin(self.sourceRoot, self.metadata.documentation);\n    // Read in the text of the Readme.\n    try {\n      var fullReadme = files.readFile(ret.path);\n    } catch (err) {\n      var errorMessage = \"\";\n      if (err.code === \"ENOENT\") {\n        // This is the most likely and common case, especially when we are\n        // inferring the docs as a default value.\n        errorMessage = \"Documentation not found: \" + self.metadata.documentation;\n      } else {\n        // This is weird, and we don't usually protect the user from errors like\n        // this, but maybe we should.\n        errorMessage =\n          \"Documentation couldn't be read: \" + self.metadata.documentation + \" \";\n        errorMessage += \"(Error: \" + err.message + \")\";\n      }\n\n      // The user might not understand that we are automatically inferring\n      // README.md as the docs! If they want to avoid pushing anything, explain\n      // how to do that.\n      if (! self.docsExplicitlyProvided) {\n        errorMessage += \"\\n\" +\n          \"If you don't want to publish any documentation, \" +\n          \"please set 'documentation: null' in Package.describe\";\n      }\n      buildmessage.error(errorMessage);\n      // Recover by returning null\n      return null;\n    }\n\n    var text = fullReadme.toString();\n    return {\n      contents: text,\n      hash: utils.sha256(text),\n      excerpt: getExcerptFromReadme(text)\n    };\n  },\n\n  // If dependencies aren't consistent across unibuilds, return false and\n  // also log a buildmessage error if inside a buildmessage job. Else\n  // return true.\n  // XXX: Check that this is used when refactoring is done.\n  _checkCrossUnibuildVersionConstraints: function () {\n    var self = this;\n    return !! self._computeDependencyMetadata({ logError: true });\n  },\n\n  // Compute the return value for getDependencyMetadata, or return\n  // null if there is a dependency that doesn't have the same\n  // constraint across all unibuilds (and, if logError is true, log a\n  // buildmessage error).\n  //\n  // This *DOES* include isobuild:* pseudo-packages!\n  //\n  // For options, see getDependencyMetadata.\n  _computeDependencyMetadata: function (options) {\n    var self = this;\n    options = options || {};\n\n    var dependencies = {};\n    var allConstraints = {}; // for error reporting. package name to array\n    var failed = false;\n\n    _.each(self.architectures, function (arch) {\n      // We need to iterate over both uses and implies, since implied packages\n      // also constitute dependencies.\n      var processUse = function (implied, use) {\n        // We can't really have a weak implies (what does that even mean?) but\n        // we check for that elsewhere.\n        if ((use.weak && options.skipWeak) ||\n            (use.unordered && options.skipUnordered)) {\n          return;\n        }\n\n        if (!_.has(dependencies, use.package)) {\n          dependencies[use.package] = {\n            constraint: null,\n            references: []\n          };\n          allConstraints[use.package] = [];\n        }\n        var d = dependencies[use.package];\n\n        if (use.constraint) {\n          allConstraints[use.package].push(use.constraint);\n\n          if (d.constraint === null) {\n            d.constraint = use.constraint;\n          } else if (d.constraint !== use.constraint) {\n            failed = true;\n          }\n        }\n\n        var reference = {\n          arch: archinfo.withoutSpecificOs(arch.arch)\n        };\n        if (use.weak) {\n          reference.weak = true;\n        }\n        if (use.unordered) {\n          reference.unordered = true;\n        }\n        if (implied) {\n          reference.implied = true;\n        }\n        d.references.push(reference);\n      };\n      _.each(arch.uses, _.partial(processUse, false));\n      _.each(arch.implies, _.partial(processUse, true));\n    });\n\n    _.each(self.pluginInfo, function (info) {\n      _.each(info.use, function (spec) {\n        var parsedSpec = splitConstraint(spec);\n        if (!_.has(dependencies, parsedSpec.package)) {\n          dependencies[parsedSpec.package] = {\n            constraint: null,\n            references: []\n          };\n          allConstraints[parsedSpec.package] = [];\n        }\n        var d = dependencies[parsedSpec.package];\n\n        if (parsedSpec.constraint) {\n          allConstraints[parsedSpec.package].push(parsedSpec.constraint);\n          if (d.constraint === null) {\n            d.constraint = parsedSpec.constraint;\n          } else if (d.constraint !== parsedSpec.constraint) {\n            failed = true;\n          }\n        }\n        d.references.push({arch: 'plugin'});\n      });\n    });\n\n    if (failed && options.logError) {\n      _.each(allConstraints, function (constraints, name) {\n        constraints = _.uniq(constraints);\n        if (constraints.length > 1) {\n          buildmessage.error(\n            \"The version constraint for a dependency must be the same \" +\n              \"at every place it is mentioned in a package. \" +\n              \"'\" + name + \"' is constrained both as \"  +\n              constraints.join(' and ') + \". Change them to match.\");\n          // recover by returning false (the caller had better detect\n          // this and use its own recovery logic)\n        }\n      });\n    }\n\n    return failed ? null : dependencies;\n  },\n\n  displayName() {\n    return this.name === null ? 'the app' : this.name;\n  }\n});\n\nmodule.exports = PackageSource;\n"],"file":"tools/isobuild/package-source.js.map"}