{"version":3,"sources":["/tools/packaging/catalog/catalog-local.js"],"names":["KNOWN_ISOBUILD_FEATURE_PACKAGES","module","link","v","glob","sync","Profile","optimisticHashOrNull","_","require","buildmessage","files","watch","PackageSource","LocalCatalog","options","self","packages","initialized","localPackageSearchDirs","explicitlyAddedLocalPackageDirs","effectiveLocalPackageDirs","packageLocationWatchSet","WatchSet","_nextId","extend","prototype","toString","JSON","stringify","initialize","assertInCapture","addPatternsToList","patterns","list","forEach","pattern","process","platform","convertToOSPath","charAt","slice","convertToPosixPath","p","push","pathResolve","_computeEffectiveLocalPackages","_loadLocalPackages","buildingIsopackets","_requireInitialized","Error","getAllPackageNames","keys","getAllNonTestPackageNames","includeNonCore","ret","nonCoreDir","pathJoin","getCurrentToolsDir","pathSep","each","name","packageSource","sourceRoot","versionRecord","isTest","startsWith","getPackage","has","packageRecord","getSortedVersions","version","getSortedVersionRecords","map","packageName","dependencies","getVersion","getLatestVersion","getVersionBySourceRoot","packageObj","find","enterJob","explicitDir","packageJsPath","packageJsHash","addFile","error","file","searchDir","possiblePackageDirs","readAndWatchDirectory","absPath","include","subdir","substr","length","absPackageDir","initSourceFromDir","packageDir","definiteName","title","rootPath","initFromPackageDirOptions","initFromPackageDir","jobHasMessages","_id","maintainers","lastUpdated","testName","publishedBy","description","metadata","summary","git","getDependencyMetadata","source","published","debugOnly","prodOnly","testOnly","containsPlugins","dir","getPackageSource","method","exports"],"mappings":"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","sourcesContent":["var _ = require('underscore');\nvar buildmessage = require('../../utils/buildmessage.js');\nvar files = require('../../fs/files');\nvar watch = require('../../fs/watch');\nvar PackageSource = require('../../isobuild/package-source.js');\nimport { KNOWN_ISOBUILD_FEATURE_PACKAGES } from '../../isobuild/compiler.js';\nimport { sync as glob } from \"glob\";\nimport { Profile } from \"../../tool-env/profile\";\nimport {\n  optimisticHashOrNull,\n} from \"../../fs/optimistic\";\n\n// LocalCatalog represents packages located in the application's\n// package directory, other package directories specified via an\n// environment variable, and core packages in the repo if meteor is\n// being run from a git checkout.\nvar LocalCatalog = function (options) {\n  var self = this;\n  options = options || {};\n\n  // Package server data.  Maps package name to a {packageSource, packageRecord,\n  // versionRecord} object.\n  self.packages = {};\n\n  self.initialized = false;\n\n    // Local directories to search for package source trees\n  self.localPackageSearchDirs = null;\n\n  // Package source trees added explicitly through a directory (not through a\n  // parent search directory). We mainly use this to allow the user to run\n  // test-packages against a package in a specific directory.\n  self.explicitlyAddedLocalPackageDirs = [];\n\n  // All packages found either by localPackageSearchDirs or\n  // explicitlyAddedLocalPackageDirs. There is a hierarchy of packages, as\n  // detailed below and there can only be one local version of a package at a\n  // time. This refers to the package by the specific package directory that we\n  // need to process.\n  self.effectiveLocalPackageDirs = [];\n\n  // A WatchSet that detects when the set of packages and their locations\n  // changes. ie, the listings of 'packages' directories, and the contents of\n  // package.js files underneath.  It does NOT track the rest of the source of\n  // the packages: that wouldn't be helpful to the runner since it would be too\n  // coarse to tell if a change is client-only or not.  (But any change to the\n  // layout of where packages live counts as a non-client-only change.)\n  self.packageLocationWatchSet = new watch.WatchSet;\n\n  self._nextId = 1;\n};\n\n_.extend(LocalCatalog.prototype, {\n  toString: function () {\n    var self = this;\n    return \"LocalCatalog [localPackageSearchDirs=\" +\n      JSON.stringify(self.localPackageSearchDirs) + \"]\";\n  },\n\n  // Initialize the Catalog. This must be called before any other\n  // Catalog function.\n\n  // options:\n  //  - localPackageSearchDirs: an array of paths on local disk, that contain\n  //    subdirectories, that each contain a source tree for a package that\n  //    should override the packages on the package server. For example, if\n  //    there is a package 'foo' that we find through localPackageSearchDirs,\n  //    then we will ignore all versions of 'foo' that we find through the\n  //    package server. Directories that don't exist (or paths that aren't\n  //    directories) will be silently ignored.\n  //  - explicitlyAddedLocalPackageDirs: an array of paths which THEMSELVES\n  //    are package source trees.  Takes precedence over packages found\n  //    via localPackageSearchDirs.\n  //  - buildingIsopackets: true if we are building isopackets\n  initialize(options) {\n    var self = this;\n    buildmessage.assertInCapture();\n\n    options = options || {};\n\n    const addPatternsToList =\n      Profile(\"addPatternsToList\", (patterns, list) => {\n        if (! patterns) {\n          return;\n        }\n\n        patterns.forEach(pattern => {\n          if (process.platform === \"win32\") {\n            pattern = files.convertToOSPath(pattern);\n\n            if (pattern.charAt(1) === \":\") {\n              // Get rid of drive prefix, e.g. C:\n              pattern = pattern.slice(2);\n            }\n\n            // Convert to /forward/slash/path without /C\n            pattern = files.convertToPosixPath(pattern, true);\n          }\n\n          // Note: glob expects POSIX-style paths, even on Windows.\n          // https://github.com/isaacs/node-glob/blob/master/README.md#windows\n          glob(pattern).forEach(\n            p => list.push(files.pathResolve(p))\n          );\n        });\n      });\n\n    addPatternsToList(\n      options.localPackageSearchDirs,\n      self.localPackageSearchDirs = [],\n    );\n\n    addPatternsToList(\n      options.explicitlyAddedLocalPackageDirs,\n      self.explicitlyAddedLocalPackageDirs = [],\n    );\n\n    self._computeEffectiveLocalPackages();\n    self._loadLocalPackages(options.buildingIsopackets);\n    self.initialized = true;\n  },\n\n  // Throw if the catalog's self.initialized value has not been set to true.\n  _requireInitialized: function () {\n    var self = this;\n\n    if (! self.initialized)\n      throw new Error(\"catalog not initialized yet?\");\n  },\n\n  // Return an array with the names of all of the packages that we know about,\n  // in no particular order.\n  getAllPackageNames: function (options) {\n    var self = this;\n    self._requireInitialized();\n\n    return _.keys(self.packages);\n  },\n\n  // Return an array with the names of all of the non-test packages that we know\n  // about, in no particular order.\n  getAllNonTestPackageNames: function ({\n    // Iff options.includeNonCore is truthy, packages in\n    // meteor/packages/non-core/*/packages will be returned.\n    includeNonCore = true,\n  } = {}) {\n    var self = this;\n    self._requireInitialized();\n\n    var ret = [];\n\n    const nonCoreDir = files.pathJoin(\n      files.getCurrentToolsDir(),\n      \"packages\",\n      \"non-core\"\n    ) + files.pathSep;\n\n    _.each(self.packages, function ({\n      packageSource: { sourceRoot },\n      versionRecord: { isTest },\n    }, name) {\n      if (isTest) {\n        return;\n      }\n\n      if (! includeNonCore &&\n          sourceRoot.startsWith(nonCoreDir)) {\n        return;\n      }\n\n      ret.push(name);\n    });\n\n    return ret;\n  },\n\n  // Returns general (non-version-specific) information about a\n  // package, or null if there is no such package.\n  getPackage: function (name, options) {\n    var self = this;\n    self._requireInitialized();\n    options = options || {};\n\n    if (!_.has(self.packages, name))\n      return null;\n    return self.packages[name].packageRecord;\n  },\n\n  // Given a package, returns an array of the versions available (ie, the one\n  // version we have, or an empty array).\n  getSortedVersions: function (name) {\n    var self = this;\n    self._requireInitialized();\n\n    if (!_.has(self.packages, name))\n      return [];\n    return [self.packages[name].versionRecord.version];\n  },\n\n  // Given a package, returns an array of the version records available (ie, the\n  // one version we have, or an empty array). This method is intended for use by\n  // Version Solver's CatalogLoader.\n  //\n  // As a special case, if name is an isobuild:* pseudo-package, returns\n  // (minimal) information about it as well.\n  getSortedVersionRecords: function (name) {\n    var self = this;\n    self._requireInitialized();\n\n    if (_.has(KNOWN_ISOBUILD_FEATURE_PACKAGES, name)) {\n      return KNOWN_ISOBUILD_FEATURE_PACKAGES[name].map(\n        version => ({version, packageName: name, dependencies: {}})\n      );\n    }\n\n    if (!_.has(self.packages, name))\n      return [];\n    return [self.packages[name].versionRecord];\n  },\n\n  // Return information about a particular version of a package, or\n  // null if there is no such package or version.\n  getVersion: function (name, version) {\n    var self = this;\n    self._requireInitialized();\n\n    if (!_.has(self.packages, name))\n      return null;\n    var versionRecord = self.packages[name].versionRecord;\n    if (versionRecord.version !== version)\n      return null;\n    return versionRecord;\n  },\n\n  // As getVersion, but returns info on the latest version of the\n  // package, or null if the package doesn't exist or has no versions.\n  getLatestVersion: function (name) {\n    var self = this;\n\n    if (!_.has(self.packages, name))\n      return null;\n    return self.packages[name].versionRecord;\n  },\n\n  getVersionBySourceRoot: function (sourceRoot) {\n    var self = this;\n    var packageObj = _.find(self.packages, function (p) {\n      return p.packageSource.sourceRoot === sourceRoot;\n    });\n    if (! packageObj)\n      return null;\n    return packageObj.versionRecord;\n  },\n\n  // Compute self.effectiveLocalPackageDirs from self.localPackageSearchDirs and\n  // self.explicitlyAddedLocalPackageDirs.\n  _computeEffectiveLocalPackages() {\n    var self = this;\n    buildmessage.assertInCapture();\n\n    self.effectiveLocalPackageDirs = [];\n\n    buildmessage.enterJob(\"looking for packages\", function () {\n      _.each(self.explicitlyAddedLocalPackageDirs, (explicitDir) => {\n        const packageJsPath = files.pathJoin(explicitDir, \"package.js\");\n        const packageJsHash = optimisticHashOrNull(packageJsPath);\n\n        if (packageJsHash) {\n          self.packageLocationWatchSet.addFile(\n            packageJsPath,\n            packageJsHash,\n          );\n\n          self.effectiveLocalPackageDirs.push(explicitDir);\n\n        } else {\n          // We asked specifically for this directory, but it has no package!\n          buildmessage.error(\"package has no package.js file\", {\n            file: explicitDir\n          });\n        }\n      });\n\n      _.each(self.localPackageSearchDirs, function (searchDir) {\n        var possiblePackageDirs = watch.readAndWatchDirectory(\n          self.packageLocationWatchSet, {\n            absPath: searchDir,\n            include: [/\\/$/]\n          });\n        // Not a directory? Ignore.\n        if (possiblePackageDirs === null)\n          return;\n\n        _.each(possiblePackageDirs, function (subdir) {\n          // readAndWatchDirectory adds a slash to the end of directory names to\n          // differentiate them from filenames. Remove it.\n          subdir = subdir.substr(0, subdir.length - 1);\n          var absPackageDir = files.pathJoin(searchDir, subdir);\n\n          // Consider a directory to be a package source tree if it contains\n          // 'package.js'. (We used to support isopacks in\n          // localPackageSearchDirs, but no longer.)\n\n          const packageJsPath = files.pathJoin(absPackageDir, \"package.js\");\n          const packageJsHash = optimisticHashOrNull(packageJsPath);\n\n          if (packageJsHash) {\n            // Let earlier package directories override later package\n            // directories.\n            self.packageLocationWatchSet.addFile(\n              packageJsPath,\n              packageJsHash,\n            );\n\n            // We don't know the name of the package, so we can't deal with\n            // duplicates yet. We are going to have to rely on the fact that we\n            // are putting these in in order, to be processed in order.\n            self.effectiveLocalPackageDirs.push(absPackageDir);\n          }\n        });\n      });\n    });\n  },\n\n  _loadLocalPackages(buildingIsopackets) {\n    var self = this;\n    buildmessage.assertInCapture();\n\n    // Load the package source from a directory. We don't know the names of our\n    // local packages until we do this.\n    //\n    // THIS MUST BE RUN IN LOAD ORDER. Let's say that we have two directories\n    // for mongo-livedata. The first one processed by this function will be\n    // canonical.  The second one will be ignored.\n    //\n    // (note: this is the behavior that we want for overriding things in\n    //  checkout.  It is not clear that you get good UX if you have two packages\n    //  with the same name in your app. We don't check that.)\n    var initSourceFromDir = function (packageDir, definiteName) {\n      var packageSource = new PackageSource;\n      buildmessage.enterJob({\n        title: \"reading package from `\" + packageDir + \"`\",\n        rootPath: packageDir\n      }, function () {\n        var initFromPackageDirOptions = {\n          buildingIsopackets: !! buildingIsopackets\n        };\n        // If we specified a name, then we know what we want to get and should\n        // pass that into the options. Otherwise, we will use the 'name'\n        // attribute from package-source.js.\n        if (definiteName) {\n          initFromPackageDirOptions.name = definiteName;\n        }\n        packageSource.initFromPackageDir(packageDir, initFromPackageDirOptions);\n        if (buildmessage.jobHasMessages())\n          return;  // recover by ignoring\n\n        // Now that we have initialized the package from package.js, we know its\n        // name.\n        var name = packageSource.name;\n\n        // We should only have one package dir for each name; in this case, we\n        // are going to take the first one we get (since we preserved the order\n        // in which we loaded local package dirs when running this function.)\n        if (_.has(self.packages, name))\n          return;\n\n        self.packages[name] = {\n          packageSource: packageSource,\n          packageRecord: {\n            _id: \"PID\" + self._nextId++,\n            name: name,\n            maintainers: null,\n            lastUpdated: null\n          },\n          versionRecord: {\n            _id: \"VID\" + self._nextId++,\n            packageName: name,\n            testName: packageSource.testName,\n            version: packageSource.version,\n            publishedBy: null,\n            description: packageSource.metadata.summary,\n            git: packageSource.metadata.git,\n            dependencies: packageSource.getDependencyMetadata(),\n            source: null,\n            lastUpdated: null,\n            published: null,\n            isTest: packageSource.isTest,\n            debugOnly: packageSource.debugOnly,\n            prodOnly: packageSource.prodOnly,\n            testOnly: packageSource.testOnly,\n            containsPlugins: packageSource.containsPlugins()\n          }\n        };\n\n        // If this is NOT a test package AND it has tests (tests will be\n        // marked as test packages by package source, so we will not recurse\n        // infinitely), then process that too.\n        if (!packageSource.isTest && packageSource.testName) {\n          initSourceFromDir(packageSource.sourceRoot, packageSource.testName);\n        }\n      });\n    };\n\n    // Load the package sources for packages and their tests into\n    // self.packages.\n    buildmessage.enterJob('initializing packages', function() {\n      _.each(self.effectiveLocalPackageDirs, function (dir) {\n        initSourceFromDir(dir);\n      });\n    });\n  },\n\n  getPackageSource: function (name) {\n    var self = this;\n    if (! _.has(self.packages, name))\n      return null;\n    return self.packages[name].packageSource;\n  }\n});\n\n[\"initialize\",\n \"_computeEffectiveLocalPackages\",\n \"_loadLocalPackages\",\n].forEach(function (method) {\n  this[method] = Profile(\"LocalCatalog#\" + method, this[method]);\n}, LocalCatalog.prototype);\n\nexports.LocalCatalog = LocalCatalog;\n"],"file":"tools/packaging/catalog/catalog-local.js.map"}