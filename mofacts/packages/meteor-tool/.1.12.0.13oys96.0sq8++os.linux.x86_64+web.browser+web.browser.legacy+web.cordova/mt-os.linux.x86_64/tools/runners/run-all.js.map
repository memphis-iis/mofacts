{"version":3,"sources":["/tools/runners/run-all.js"],"names":["_objectSpread","module","link","default","v","_objectWithoutProperties","_","require","files","buildmessage","utils","runLog","release","Console","Proxy","Selenium","AppRunner","MongoRunner","Updater","Runner","constructor","appHost","appPort","banner","disableOplog","cordovaRunner","mongoUrl","onFailure","oplogUrl","projectContext","proxyHost","proxyPort","quiet","rootUrl","selenium","seleniumBrowser","noReleaseCheck","optionsForAppRunner","self","Error","listenPort","mongoPort","parseInt","specifiedAppPort","regenerateAppPort","stopped","convertToOSPath","prettyPath","projectDir","formatUrl","protocol","hostname","port","proxy","listenHost","proxyToPort","proxyToHost","capture","resolveConstraints","packageMap","hasMongoDevServerPackage","getInfo","mongoRunner","process","env","METEOR_TEST_FAKE_MONGOD_CONTROL_PORT","projectLocalDir","multiple","METEOR_TEST_MULTIPLE_MONGOD_REPLSET","updater","appRunner","noRestartBanner","runner","browser","start","log","arrow","unblockAppRunner","makeBeforeStartPromise","startMongo","tries","_startMongoAsync","then","ok","error","left","message","stop","setTimeout","_fail","enterJob","title","UNIX_SOCKET_PATH","platform","finish","randomPort","exports","run","options","runOptions","clone","once","promise","Promise","resolve","outcome","onRunEnd","result","signal","undefined","code","watchForChanges","buildMode","buildOptions","NODE_ENV","nodeEnv","await","from","current","getDisplayName","to","displayReleaseNeeded","arrowError","errors","formatMessages"],"mappings":"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","sourcesContent":["const _ = require('underscore');\n\nconst files = require('../fs/files');\nconst buildmessage = require('../utils/buildmessage.js');\nconst utils = require('../utils/utils.js');\nconst runLog = require('./run-log.js');\nconst release = require('../packaging/release.js');\n\nconst Console = require('../console/console.js').Console;\n\nconst Proxy = require('./run-proxy.js').Proxy;\nconst Selenium = require('./run-selenium.js').Selenium;\nconst AppRunner = require('./run-app.js').AppRunner;\nconst MongoRunner = require('./run-mongo.js').MongoRunner;\nconst Updater = require('./run-updater.js').Updater;\n\nclass Runner {\n  constructor({\n    appHost,\n    appPort,\n    banner,\n    disableOplog,\n    cordovaRunner,\n    mongoUrl,\n    onFailure,\n    oplogUrl,\n    projectContext,\n    proxyHost,\n    proxyPort,\n    quiet,\n    rootUrl,\n    selenium,\n    seleniumBrowser,\n    noReleaseCheck,\n    ...optionsForAppRunner\n  }) {\n    const self = this;\n    self.projectContext = projectContext;\n\n    if (typeof proxyPort === 'undefined') {\n      throw new Error('no proxyPort?');\n    }\n\n    const listenPort = proxyPort;\n    const mongoPort = parseInt(listenPort, 10) + 1;\n    self.specifiedAppPort = appPort;\n    self.regenerateAppPort();\n\n    self.stopped = false;\n    self.noReleaseCheck = noReleaseCheck;\n    self.quiet = quiet;\n    self.banner = banner || files.convertToOSPath(\n      files.prettyPath(self.projectContext.projectDir)\n    );\n\n    if (rootUrl) {\n      self.rootUrl = rootUrl;\n    } else {\n      self.rootUrl = utils.formatUrl({\n        protocol: 'http',\n        hostname: proxyHost || \"localhost\",\n        port: listenPort,\n      });\n    }\n\n    self.proxy = new Proxy({\n      listenPort,\n      listenHost: proxyHost,\n      proxyToPort: self.appPort,\n      proxyToHost: appHost,\n      onFailure\n    });\n\n    buildmessage.capture(function () {\n      self.projectContext.resolveConstraints();\n    });\n\n    const packageMap = self.projectContext.packageMap;\n    const hasMongoDevServerPackage =\n      packageMap && packageMap.getInfo('mongo-dev-server') != null;\n    self.mongoRunner = null;\n    if (mongoUrl) {\n      oplogUrl = disableOplog ? null : oplogUrl;\n    } else if (hasMongoDevServerPackage\n        || process.env.METEOR_TEST_FAKE_MONGOD_CONTROL_PORT) {\n      // The mongo-dev-server package is required to start Mongo, but\n      // tests using fake-mongod are exempted.\n      self.mongoRunner = new MongoRunner({\n        projectLocalDir: self.projectContext.projectLocalDir,\n        port: mongoPort,\n        onFailure,\n        // For testing mongod failover, run with 3 mongod if the env var is\n        // set. Note that data is not preserved from one run to the next.\n        multiple: !!process.env.METEOR_TEST_MULTIPLE_MONGOD_REPLSET\n      });\n\n      mongoUrl = self.mongoRunner.mongoUrl();\n      oplogUrl = disableOplog ? null : self.mongoRunner.oplogUrl();\n    } else {\n      // Don't start a mongodb server.\n      // Set monogUrl to a specific value to prevent MongoDB connections\n      // and to allow a check for printing a message if `mongo-dev-server`\n      // is added while the app is running.\n      // The check and message is printed by the `mongo-dev-server` package.\n      mongoUrl = 'no-mongo-server';\n    }\n\n    self.updater = new Updater();\n\n    self.appRunner = new AppRunner({\n      ...optionsForAppRunner,\n      projectContext: self.projectContext,\n      port: self.appPort,\n      listenHost: appHost,\n      mongoUrl,\n      oplogUrl,\n      rootUrl: self.rootUrl,\n      proxy: self.proxy,\n      noRestartBanner: self.quiet,\n      cordovaRunner: cordovaRunner\n    });\n\n    self.selenium = null;\n    if (selenium) {\n      self.selenium = new Selenium({\n        runner: self,\n        browser: seleniumBrowser\n      });\n    }\n  }\n\n  // XXX leave a pidfile and check if we are already running\n  start() {\n    const self = this;\n\n    self.proxy.start();\n\n    // print the banner only once we've successfully bound the port\n    if (! self.quiet && ! self.stopped) {\n      runLog.log(\"[[[[[ \" + self.banner + \" ]]]]]\\n\");\n      runLog.log(\"Started proxy.\",  { arrow: true });\n    }\n\n    var unblockAppRunner = self.appRunner.makeBeforeStartPromise();\n\n    function startMongo(tries = 3) {\n      self._startMongoAsync().then(\n        ok => unblockAppRunner(),\n        error => {\n          --tries;\n          const left = tries + (tries === 1 ? \" try\" : \" tries\");\n          Console.error(\n            `Error starting Mongo (${left} left): ${error.message}`\n          );\n\n          if (tries > 0) {\n            self.mongoRunner.stop();\n            setTimeout(() => startMongo(tries), 1000);\n          } else {\n            self.mongoRunner._fail();\n          }\n        }\n      );\n    }\n\n    startMongo();\n\n    if (!self.noReleaseCheck && ! self.stopped) {\n      self.updater.start();\n    }\n\n    if (! self.stopped) {\n      buildmessage.enterJob({ title: \"starting your app\" }, function () {\n        self.appRunner.start();\n      });\n      if (! self.quiet && ! self.stopped) {\n        runLog.log(\"Started your app.\",  { arrow: true });\n      }\n    }\n\n    if (! self.stopped && ! self.quiet) {\n      runLog.log(\"\");\n      if (process.env.UNIX_SOCKET_PATH) {\n        runLog.log(\n          `App running; UNIX domain socket: ${process.env.UNIX_SOCKET_PATH}`,\n          { arrow: true }\n        );\n      } else {\n        runLog.log(\"App running at: \" + self.rootUrl,  { arrow: true });\n      }\n\n      if (process.platform === \"win32\") {\n        runLog.log(\"   Type Control-C twice to stop.\");\n        runLog.log(\"\");\n      }\n    }\n\n    if (self.selenium && ! self.stopped) {\n      buildmessage.enterJob({ title: \"starting Selenium\" }, function () {\n        self.selenium.start();\n      });\n      if (! self.quiet && ! self.stopped) {\n        runLog.log(\"Started Selenium.\", { arrow: true });\n      }\n    }\n\n    // XXX It'd be nice to (cosmetically) handle failure better. Right\n    // now we overwrite the \"starting foo...\" message with the\n    // error. It'd be better to overwrite it with \"failed to start\n    // foo\" and then print the error.\n  }\n\n  async _startMongoAsync() {\n    if (! this.stopped && this.mongoRunner) {\n      this.mongoRunner.start();\n      if (! this.stopped && ! this.quiet) {\n        runLog.log(\"Started MongoDB.\", { arrow: true });\n      }\n    }\n  }\n\n  // Idempotent\n  stop() {\n    const self = this;\n    if (self.stopped) {\n      return;\n    }\n\n    self.stopped = true;\n    self.proxy.stop();\n    self.updater.stop();\n    self.mongoRunner && self.mongoRunner.stop();\n    self.appRunner.stop();\n    self.selenium && self.selenium.stop();\n    // XXX does calling this 'finish' still make sense now that runLog is a\n    // singleton?\n    runLog.finish();\n  }\n\n  // Call this whenever you want to regenerate the app's port (if it is not\n  // explicitly specified by the user).\n  //\n  // Rationale: if we randomly chose a port that's in use and the app failed to\n  // listen on it, we should try a different port when we restart the app!\n  regenerateAppPort() {\n    const self = this;\n    if (self.specifiedAppPort) {\n      self.appPort = self.specifiedAppPort;\n    } else {\n      self.appPort = require('../utils/utils.js').randomPort();\n    }\n    if (self.proxy) {\n      self.proxy.proxyToPort = self.appPort;\n    }\n    if (self.appRunner) {\n      self.appRunner.port = self.appPort;\n    }\n  }\n}\n\n// Run the app and all of its associated processes. Runs (and does not\n// return) until an unrecoverable failure happens. Logs to\n// stdout. Returns a suggested exit code.\n//\n// If 'once' is set, run the app process exactly once and pass through\n// its exit code. Return an exit code of 255 if the app process was\n// killed by a signal and 254 if the app process could not start\n// (build failure, invalid program name, database couldn't start, and\n// so on).\n//\n// If the 'once' option is not set, the default, restart the app\n// process if it crashes or if source files change. (Non-app\n// processes, such as the database, are always restarted as\n// necessary.) The function will only return if there is an\n// unrecoverable error, which generally means an error that could not\n// be fixed by source code changes (such as the database refusing to\n// run), but also currently includes Meteor version mismatches. So the\n// exit code will always be 254 because in all other cases we'll\n// persevere.\n//\n// Options:\n//\n// - proxyPort: the port to connect to to access the application (we will\n//   run a proxy here that proxies to the actual app process). required\n// - buildOptions: 'buildOptions' argument to bundler.bundle()\n// - settingsFile: path to file containing deploy-time settings\n// - once: see above\n// - banner: replace the application path that is normally printed on\n//   startup with an arbitrary string (eg, 'Tests')\n// - rootUrl: tell the app that traffic at this URL will be routed to\n//   it at '/' (used by the app to construct absolute URLs)\n// - disableOplog: don't use oplog tailing\n// - mongoUrl: don't start a mongo process; instead use the mongo at\n//   this mongo URL\n// - oplogUrl: URL of the mongo oplog to use. if mongoUrl isn't\n//   set (we're starting a mongo) a default will be provided, but can\n//   be overridden. if mongoUrl is set, you must set this or you don't\n//   get oplog tailing.\n// - recordPackageUsage: (default true) if set to false, don't send\n//   information about packages used by this app to the package stats\n//   server.\nexports.run = function (options) {\n  var runOptions = _.clone(options);\n  var once = runOptions.once;\n\n  var promise = new Promise(function (resolve) {\n    runOptions.onFailure = function () {\n      // Ensure that runner stops now. You might think this is unnecessary\n      // because the runner is stopped immediately after promise.await(), but if\n      // the failure happens while runner.start() is still running, we want the\n      // rest of start to stop, and it's not like resolve() magically makes\n      // us jump to a promise.await() that hasn't happened yet!.\n      runner.stop();\n      resolve({ outcome: 'failure' });\n    };\n\n    runOptions.onRunEnd = function (result) {\n      if (once ||\n          result.outcome === \"conflicting-versions\" ||\n          result.outcome === \"wrong-release\" ||\n          result.outcome === \"outdated-cordova-platforms\" ||\n          result.outcome === \"outdated-cordova-plugins\" ||\n          (result.outcome === \"terminated\" &&\n           result.signal === undefined && result.code === undefined)) {\n        resolve(result);\n        return false;  // stop restarting\n      }\n      runner.regenerateAppPort();\n      return true;  // restart it\n    };\n  });\n\n  runOptions.watchForChanges = ! once;\n  runOptions.quiet = false;\n\n  // Ensure process.env.NODE_ENV matches the build mode, with the following precedence:\n  // 1. Passed in build mode (if development or production)\n  // 2. Existing process.env.NODE_ENV (if it's valid)\n  // 3. Default to development (in both cases) otherwise\n\n  // NOTE: because this code only runs when using `meteor run` or `meteor test[-packages`,\n  // We *don't* end up defaulting NODE_ENV in this way when bundling/deploying.\n  // In those cases, it will default to \"production\" in packages/meteor/*_env.js\n\n  // We *override* NODE_ENV if build mode is one of these values\n  let buildMode = runOptions.buildOptions.buildMode;\n  if (buildMode === \"development\" || buildMode === \"production\") {\n    process.env.NODE_ENV = buildMode;\n  }\n\n  let nodeEnv = process.env.NODE_ENV;\n  // We *never* override buildMode (it can be \"test\")\n  if (!buildMode) {\n    if (nodeEnv === \"development\" || nodeEnv === \"production\") {\n      runOptions.buildOptions.buildMode = nodeEnv;\n    } else {\n      runOptions.buildOptions.buildMode = \"development\";\n    }\n  }\n\n  if (!nodeEnv) {\n    process.env.NODE_ENV = \"development\";\n  }\n\n  var runner = new Runner(runOptions);\n  runner.start();\n  var result = promise.await();\n  runner.stop();\n\n  if (result.outcome === \"conflicting-versions\") {\n    Console.error(\n      \"The constraint solver could not find a set of package versions to\",\n      \"use that would satisfy the constraints of .meteor/versions and\",\n      \".meteor/packages. This could be caused by conflicts in\",\n      \".meteor/versions, conflicts in .meteor/packages, and/or\",\n      \"inconsistent changes to the dependencies in local packages.\");\n    return 254;\n  }\n\n  if (result.outcome === \"outdated-cordova-plugins\") {\n    Console.error(\"Your app's Cordova plugins have changed.\");\n    Console.error(\"Restart meteor to use the new set of plugins.\");\n    return 254;\n  }\n\n  if (result.outcome === \"outdated-cordova-platforms\") {\n    Console.error(\"Your app's platforms have changed.\");\n    Console.error(\"Restart meteor to use the new set of platforms.\");\n    return 254;\n  }\n\n  if (result.outcome === \"wrong-release\") {\n    if (once) {\n      // We lost a race where the user ran 'meteor update' and 'meteor\n      // run --once' simultaneously.\n      throw new Error(\"wrong release?\");\n    }\n\n    // If the user did not specify a --release on the command line,\n    // and simultaneously runs `meteor update` during this run, just\n    // exit and let them restart the run. (We can do something fancy\n    // like allowing this to work if the tools version didn't change,\n    // or even springboarding if the tools version does change, but\n    // this (which prevents weird errors) is a start.)\n    var from = release.current.getDisplayName();\n    var to = result.displayReleaseNeeded;\n    Console.error(\n      \"Your app has been updated to \" + to + \" from \" + from + \".\",\n      \"Restart meteor to use the new release.\");\n    return 254;\n  }\n\n  if (result.outcome === \"failure\" ||\n      (result.outcome === \"terminated\" &&\n       result.signal === undefined && result.code === undefined)) {\n    // Fatal problem with something other than the app process. An\n    // explanation should already have been logged.\n    return 254;\n  }\n\n  if (once && result.outcome === \"bundle-fail\") {\n    Console.arrowError(\"Build failed:\\n\\n\" +\n                       result.errors.formatMessages());\n    return 254;\n  }\n\n  if (once && result.outcome === \"terminated\") {\n    if (result.signal) {\n      Console.error(\"Killed (\" + result.signal + \")\");\n      return 255;\n    } else if (typeof result.code === \"number\") {\n      // We used to print 'Your application is exiting' here, but that\n      // seems unnecessarily chatty? once mode is otherwise silent\n      return result.code;\n    } else {\n      // If there is neither a code nor a signal, it means that we\n      // failed to start the process. We logged the reason. Probably a\n      // bad program name.\n      return 254;\n    }\n  }\n\n  throw new Error(\"unexpected outcome \" + result.outcome);\n};\n"],"file":"tools/runners/run-all.js.map"}