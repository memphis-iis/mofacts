{"version":3,"sources":["/tools/cli/dev-bundle.js"],"names":["fs","require","path","links","rootDir","resolve","__dirname","defaultDevBundlePromise","Promise","join","getDevBundleDir","releaseFile","find","process","cwd","makeStatTest","localDir","dirname","statOrNull","mkdirSync","e","devBundleLink","devBundleStat","readLink","release","readFileSync","replace","test","getDevBundleForRelease","then","devBundleDir","makeLink","parts","split","length","track","version","slice","packageMetadataDir","meteorToolDir","meteorToolStat","dbPath","dbStat","sqlite3","db","Database","reject","get","error","data","tool","JSON","parse","content","getHostArch","catch","console","stack","statMethod","stat","statSync","code","dir","predicate","joinArgs","Array","prototype","call","arguments","unshift","joined","apply","parentDir","method","file","platform","module","exports"],"mappings":"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","sourcesContent":["// Note that this file is required before we install our Babel hooks in\n// ../tool-env/install-babel.js, so we can't use ES2015+ syntax here.\n\n// This file replicates some functionality from elsewhere in tools code,\n// but that's unavoidable if we don't want to install Babel and load all\n// the rest of the code every time we run `meteor npm` or `meteor node`.\n\nvar fs = require(\"fs\");\nvar path = require(\"path\");\nvar links = require(\"./dev-bundle-links.js\");\nvar rootDir = path.resolve(__dirname, \"..\", \"..\");\nvar defaultDevBundlePromise =\n  Promise.resolve(path.join(rootDir, \"dev_bundle\"));\n\nfunction getDevBundleDir() {\n  // Note that this code does not care if we are running meteor from a\n  // checkout, because it's always better to respect the .meteor/release\n  // file of the current app, if possible.\n\n  var releaseFile = find(\n    process.cwd(),\n    makeStatTest(\"isFile\"),\n    \".meteor\", \"release\"\n  );\n\n  if (! releaseFile) {\n    return defaultDevBundlePromise;\n  }\n\n  var localDir = path.join(path.dirname(releaseFile), \"local\");\n  if (! statOrNull(localDir, \"isDirectory\")) {\n    try {\n      fs.mkdirSync(localDir);\n    } catch (e) {\n      return defaultDevBundlePromise;\n    }\n  }\n\n  var devBundleLink = path.join(localDir, \"dev_bundle\");\n  var devBundleStat = statOrNull(devBundleLink);\n  if (devBundleStat) {\n    return new Promise(function (resolve) {\n      resolve(links.readLink(devBundleLink));\n    });\n  }\n\n  var release = fs.readFileSync(\n    releaseFile, \"utf8\"\n  ).replace(/^\\s+|\\s+$/g, \"\");\n\n  if (! /^METEOR@\\d+/.test(release)) {\n    return defaultDevBundlePromise;\n  }\n\n  return Promise.resolve(\n    getDevBundleForRelease(release)\n  ).then(function (devBundleDir) {\n    if (devBundleDir) {\n      links.makeLink(devBundleDir, devBundleLink);\n      return devBundleDir;\n    }\n\n    return defaultDevBundlePromise;\n  });\n}\n\nfunction getDevBundleForRelease(release) {\n  var parts = release.split(\"@\");\n  if (parts.length < 2) {\n    return null;\n  }\n\n  var track = parts[0];\n  var version = parts.slice(1).join(\"@\");\n\n  var packageMetadataDir = find(\n    rootDir,\n    makeStatTest(\"isDirectory\"),\n    \".meteor\", \"package-metadata\"\n  );\n\n  if (! packageMetadataDir) {\n    return null;\n  }\n\n  var meteorToolDir = path.resolve(\n    packageMetadataDir,\n    \"..\", \"packages\", \"meteor-tool\"\n  );\n\n  var meteorToolStat = statOrNull(meteorToolDir, \"isDirectory\");\n  if (! meteorToolStat) {\n    return null;\n  }\n\n  var dbPath = path.join(\n    packageMetadataDir,\n    \"v2.0.1\",\n    \"packages.data.db\"\n  );\n\n  var dbStat = statOrNull(dbPath, \"isFile\");\n  if (! dbStat) {\n    return null;\n  }\n\n  var sqlite3 = require(\"sqlite3\");\n  var db = new sqlite3.Database(dbPath);\n\n  return new Promise(function (resolve, reject) {\n    db.get(\n      \"SELECT content FROM releaseVersions WHERE track=? AND version=?\",\n      [track, version],\n      function (error, data) {\n        error ? reject(error) : resolve(data);\n      }\n    );\n\n  }).then(function (data) {\n    if (data) {\n      var tool = JSON.parse(data.content).tool;\n      var devBundleDir = path.join(\n        meteorToolDir,\n        tool.split(\"@\").slice(1).join(\"@\"),\n        \"mt-\" + getHostArch(),\n        \"dev_bundle\"\n      );\n\n      var devBundleStat = statOrNull(devBundleDir, \"isDirectory\");\n      if (devBundleStat) {\n        return devBundleDir;\n      }\n    }\n\n    return null;\n\n  }).catch(function (error) {\n    console.error(error.stack || error);\n    return null;\n  });\n}\n\nfunction statOrNull(path, statMethod) {\n  try {\n    var stat = fs.statSync(path);\n  } catch (e) {\n    if (e.code !== \"ENOENT\") {\n      throw e;\n    }\n  }\n\n  if (stat) {\n    if (typeof statMethod === \"string\") {\n      if (stat[statMethod]()) {\n        return stat;\n      }\n    } else {\n      return stat;\n    }\n  }\n\n  return null;\n}\n\nfunction find(dir, predicate) {\n  var joinArgs = Array.prototype.slice.call(arguments, 2);\n  joinArgs.unshift(null);\n\n  while (true) {\n    joinArgs[0] = dir;\n    var joined = path.join.apply(path, joinArgs);\n    if (predicate(joined)) {\n      return joined;\n    }\n\n    var parentDir = path.dirname(dir);\n    if (parentDir === dir) break;\n    dir = parentDir;\n  }\n\n  return null;\n}\n\nfunction makeStatTest(method) {\n  return function (file) {\n    return statOrNull(file, method);\n  };\n}\n\nfunction getHostArch() {\n  if (process.platform === \"win32\") {\n    return \"os.windows.x86_64\";\n  }\n\n  if (process.platform === \"linux\") {\n    return \"os.linux.x86_64\";\n  }\n\n  if (process.platform === \"darwin\") {\n    return \"os.osx.x86_64\";\n  }\n}\n\nmodule.exports = getDevBundleDir().catch(function (error) {\n  return defaultDevBundlePromise;\n});\n"],"file":"tools/cli/dev-bundle.js.map"}