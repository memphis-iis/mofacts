{"version":3,"sources":["/tools/utils/fiber-helpers.js"],"names":["_","require","Fiber","exports","parallelEach","collection","callback","context","errors","results","Promise","all","map","args","run","apply","catch","error","push","await","length","disallowedYield","Error","disallowed","noYieldsAllowed","f","savedYield","yield","call","nodeCodeMustBeInFiber","current","nextSlot","EnvironmentVariable","defaultValue","self","slot","extend","prototype","get","_meteorDynamics","has","set","value","fiber","currentValues","saved","withValue","func","reset","bindEnvironment","boundValues","clone","runWithEnvironment","savedValues","makeFulfillablePromise","resolve","reject","promise","res","rej"],"mappings":"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","sourcesContent":["var _ = require(\"underscore\");\nvar Fiber = require(\"fibers\");\n\nexports.parallelEach = function (collection, callback, context) {\n  const errors = [];\n  context = context || null;\n\n  const results = Promise.all(_.map(collection, (...args) => {\n    async function run() {\n      return callback.apply(context, args);\n    }\n\n    return run().catch(error => {\n      // Collect the errors but do not propagate them so that we can\n      // re-throw the first error after all iterations have completed.\n      errors.push(error);\n    });\n  })).await();\n\n  if (errors.length > 0) {\n    throw errors[0];\n  }\n\n  return results;\n};\n\nfunction disallowedYield() {\n  throw new Error(\"Can't call yield in a noYieldsAllowed block!\");\n}\n// Allow testing Fiber.yield.disallowed.\ndisallowedYield.disallowed = true;\n\nexports.noYieldsAllowed = function (f, context) {\n  var savedYield = Fiber.yield;\n  Fiber.yield = disallowedYield;\n  try {\n    return f.call(context || null);\n  } finally {\n    Fiber.yield = savedYield;\n  }\n};\n\n// Borrowed from packages/meteor/dynamics_nodejs.js\n// Used by buildmessage\n\nexports.nodeCodeMustBeInFiber = function () {\n  if (!Fiber.current) {\n    throw new Error(\"Meteor code must always run within a Fiber. \" +\n                    \"Try wrapping callbacks that you pass to non-Meteor \" +\n                    \"libraries with Meteor.bindEnvironment.\");\n  }\n};\n\nvar nextSlot = 0;\nexports.EnvironmentVariable = function (defaultValue) {\n  var self = this;\n  self.slot = 'slot' + nextSlot++;\n  self.defaultValue = defaultValue;\n};\n\n_.extend(exports.EnvironmentVariable.prototype, {\n  get() {\n    var self = this;\n    exports.nodeCodeMustBeInFiber();\n\n    if (!Fiber.current._meteorDynamics) {\n      return self.defaultValue;\n    }\n    if (!_.has(Fiber.current._meteorDynamics, self.slot)) {\n      return self.defaultValue;\n    }\n    return Fiber.current._meteorDynamics[self.slot];\n  },\n\n  set(value) {\n    exports.nodeCodeMustBeInFiber();\n\n    const fiber = Fiber.current;\n    const currentValues = fiber._meteorDynamics || (\n      fiber._meteorDynamics = {}\n    );\n\n    const saved = _.has(currentValues, this.slot)\n      ? currentValues[this.slot]\n      : this.defaultValue;\n\n    currentValues[this.slot] = value;\n\n    return () => {\n      currentValues[this.slot] = saved;\n    };\n  },\n\n  withValue(value, func) {\n    const reset = this.set(value);\n    try {\n      return func();\n    } finally {\n      reset();\n    }\n  }\n});\n\n// This is like Meteor.bindEnvironment.\n// Experimentally, we are NOT including onException or _this in this version.\nexports.bindEnvironment = function (func) {\n  exports.nodeCodeMustBeInFiber();\n\n  var boundValues = _.clone(Fiber.current._meteorDynamics || {});\n\n  return function (...args) {\n    var self = this;\n\n    var runWithEnvironment = function () {\n      var savedValues = Fiber.current._meteorDynamics;\n      try {\n        // Need to clone boundValues in case two fibers invoke this\n        // function at the same time\n        Fiber.current._meteorDynamics = _.clone(boundValues);\n        return func.apply(self, args);\n      } finally {\n        Fiber.current._meteorDynamics = savedValues;\n      }\n    };\n\n    if (Fiber.current) {\n      return runWithEnvironment();\n    }\n    Fiber(runWithEnvironment).run();\n  };\n};\n\n// Returns a Promise that supports .resolve(result) and .reject(error).\nexports.makeFulfillablePromise = function () {\n  var resolve, reject;\n  var promise = new Promise(function (res, rej) {\n    resolve = res;\n    reject = rej;\n  });\n  promise.resolve = resolve;\n  promise.reject = reject;\n  return promise;\n};\n"],"file":"tools/utils/fiber-helpers.js.map"}